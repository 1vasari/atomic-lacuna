<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title> - game.js</title>

  <link rel="stylesheet" href="../../assets/style.css">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"/>
  <meta name="groc-relative-root" content="../../"/>
  <meta name="groc-document-path" content="app/js/game.js"/>
  
</head>
<body>
  <div id="file-area">
    <div id="meta">
      <code class="file-path">
      
        app/js/game.js
      
      </code>
    </div>
    <div id="document">
    
      <div class="segment">
      
      
        <div class="code"><pre class="wrapper"><span class="hljs-pi">'use strict'</span>;
YAHOO.namespace(<span class="hljs-string">"lacuna"</span>);
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> Util = YAHOO.util,
        Lang = YAHOO.lang,
        Cookie = Util.Cookie,
        Dom = Util.Dom,
        Event = Util.Event,
        Lacuna = YAHOO.lacuna,
        Lib = Lacuna.Library;
    <span class="hljs-keyword">var</span> Game = {
        EmpireData: {},
        Resources: {},
        ServerData: {},
        Services: {},
        Timeout: <span class="hljs-number">60000</span>,
        HourMS: <span class="hljs-number">3600000</span>,
        onTick: <span class="hljs-keyword">new</span> Util.CustomEvent(<span class="hljs-string">"onTick"</span>),
        OverlayManager: <span class="hljs-keyword">new</span> YAHOO.widget.OverlayManager(),

        Start: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(query)</span> {</span>
            <span class="hljs-keyword">var</span> l = window.location;
            Game.RPCBase = window.lacuna_rpc_base_url || l.protocol + <span class="hljs-string">'//'</span> + l.host + <span class="hljs-string">'/'</span>;
            Game.domain = l.hostname || <span class="hljs-string">"lacunaexpanse.com"</span>;
            <span class="hljs-keyword">var</span> ie = YAHOO.env.ua.ie,</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>7 or later</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">                opera = YAHOO.env.ua.opera,</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>9.65 or later</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">                firefox = YAHOO.env.ua.gecko,</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>1.9 = 3.0</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">                webkit = YAHOO.env.ua.webkit,</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>523 = Safari 3</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">                oldBrowserOkay = Game.GetCookieSettings(<span class="hljs-string">"oldBrowserOkay"</span>, <span class="hljs-string">"0"</span>);
            <span class="hljs-keyword">if</span> (oldBrowserOkay === <span class="hljs-number">0</span> &amp;&amp; ((ie &gt; <span class="hljs-number">0</span> &amp;&amp; ie &lt; <span class="hljs-number">7</span>) || (opera &gt; <span class="hljs-number">0</span> &amp;&amp; opera &lt; <span class="hljs-number">9.65</span>) || (firefox &gt; <span class="hljs-number">0</span> &amp;&amp; firefox &lt; <span class="hljs-number">1.9</span>) || (webkit &gt; <span class="hljs-number">0</span> &amp;&amp; webkit &lt; <span class="hljs-number">523</span>))) {
                <span class="hljs-keyword">if</span> (confirm(<span class="hljs-string">"Your browser is quite old and some game functions may not work properly. Are you certain you want to continue?"</span>)) {
                    Game.SetCookieSettings(<span class="hljs-string">"oldBrowserOkay"</span>, <span class="hljs-string">"1"</span>);
                }
                <span class="hljs-keyword">else</span> {
                    window.location = <span class="hljs-string">'http://www.lacunaexpanse.com'</span>;
                }
            }
            <span class="hljs-keyword">if</span> (!Lacuna.Pulser) {
                Lacuna.Pulser = <span class="hljs-keyword">new</span> Lacuna.Pulse();
            }
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">if</span> (!query) {
                query = {};
            }
            <span class="hljs-comment">//add overlay manager functionality</span>
            Game.OverlayManager.hideAllBut = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id)</span> {</span>
                <span class="hljs-keyword">var</span> overlays = <span class="hljs-keyword">this</span>.overlays,
                    n = overlays.length;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = n - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
                    <span class="hljs-keyword">if</span> (overlays[i].id !== id) {
                        overlays[i].hide();
                    }
                }
            };
            Game.escListener = <span class="hljs-keyword">new</span> Util.KeyListener(document, {
                keys: <span class="hljs-number">27</span>
            }, {
                fn: Game.OverlayManager.hideAll,
                scope: Game.OverlayManager,
                correctScope: <span class="hljs-literal">true</span>
            });
            <span class="hljs-comment">//get resources right away since they don't depend on anything</span>
            Game.GetResources();
            Game.PreloadUI();
            Game.Services = Game.InitServices(YAHOO.lacuna.SMD.Services);
            <span class="hljs-keyword">var</span> session = Game.GetSession();
            <span class="hljs-keyword">if</span> (query.referral) {
                <span class="hljs-comment">//if they came from someelse</span>
                <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
                Cookie.set(<span class="hljs-string">"lacunaReferral"</span>, query.referral, {
                    domain: Game.domain,
                    expires: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(now.setFullYear(now.getFullYear() + <span class="hljs-number">1</span>))
                });
            }
            <span class="hljs-keyword">if</span> (query.reset_password) {
                Game.InitLogin();
                Game.LoginDialog.resetPassword(query.reset_password);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">if</span> (query.facebook_uid) {
                Game.InitLogin();
                Game.LoginDialog.initEmpireCreator();
                Game.EmpireCreator.facebookReturn(query.facebook_uid, query.facebook_token, query.facebook_name);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (query.session_id) {
                Game.SetSession(query.session_id);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (query.empire_id) {
                Game.InitLogin();
                Game.LoginDialog.initEmpireCreator();
                Game.SpeciesCreator.show(query.empire_id);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!session) {
                Game.DoLogin();
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-comment">//Run rest of UI since we're logged in</span>
            Game.GetStatus({
                success: Game.Run,
                failure: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span> {</span>
                    Game.Reset();
                    Game.DoLogin(o.error);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
            });
        },
        Failure: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o, retry, fail)</span> {</span></pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>session expired</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">if</span> (o.error.code === <span class="hljs-number">1006</span>) {
                Game.Reset();
                Game.DoLogin(o.error);
            }</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Game over</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (o.error.code === <span class="hljs-number">1200</span>) {
                alert(o.error.message);
                Game.Reset();
                window.location = o.error.data;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (o.error.code === <span class="hljs-number">1016</span>) {
                Lacuna.Captcha.show(retry, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    fail(<span class="hljs-literal">true</span>);
                });
            }</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Internal error</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (o.error.code === -<span class="hljs-number">32603</span>) {
                Game.QuickDialog({
                    width: <span class="hljs-string">"500px"</span>,
                    text: [<span class="hljs-string">'&lt;p&gt;An internal error has occurred.  Please report this on &lt;a target="_blank" href="http://community.lacunaexpanse.com/forums/support"&gt;the support forums&lt;/a&gt;, and include the data below.&lt;/p&gt;'</span>, <span class="hljs-string">'&lt;textarea style="width: 100%; height: 300px;" id="internalErrorMessageText" readonly="readonly" onclick="this.select()"&gt;&lt;/textarea&gt;'</span>].join(<span class="hljs-string">''</span>),
                    buttons: [{
                        text: <span class="hljs-string">"Close"</span>,
                        handler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                            <span class="hljs-keyword">this</span>.hide();
                        }
                    }]
                }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    Dom.get(<span class="hljs-string">'internalErrorMessageText'</span>).value = o.error.data;
                });
            }
            <span class="hljs-keyword">else</span> {
                fail();
            }
        },
        InitLogin: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(error)</span> {</span>
            <span class="hljs-keyword">if</span> (!Lacuna.Game.LoginDialog) {
                Lacuna.Game.LoginDialog = <span class="hljs-keyword">new</span> Lacuna.Login();
                Lacuna.Game.LoginDialog.subscribe(<span class="hljs-string">"onLoginSuccessful"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(oArgs)</span> {</span>
                    <span class="hljs-keyword">var</span> result = oArgs.result;
                    <span class="hljs-comment">//remember session</span>
                    Game.SetSession(result.session_id);
                    Game.RemoveCookie(<span class="hljs-string">"locationId"</span>);
                    Game.RemoveCookie(<span class="hljs-string">"locationView"</span>);
                    <span class="hljs-comment">//store empire data</span>
                    Lacuna.Game.ProcessStatus(result.status);
                    <span class="hljs-comment">//Run rest of UI now that we're logged in</span>
                    Lacuna.Game.Run();
                    <span class="hljs-keyword">if</span> (result.welcome_message_id) {
                        Game.QuickDialog({
                            width: <span class="hljs-string">"400px"</span>,
                            text: [<span class="hljs-string">'Welcome to the Lacuna Expanse.  It is recommended that you play through the in game tutorial to familiarize yourself with the game, and to get some free resources to build up your empire.'</span>, <span class="hljs-string">'&lt;p&gt;If you choose to skip the tutorial now you may find it by clicking &lt;img src="'</span>, Lib.AssetUrl, <span class="hljs-string">'ui/s/inbox.png" title="Inbox" style="width:19px;height:22px;vertical-align:middle;margin:-5px 0 -4px -2px" /&gt; in the upper left of the interface and find the message with the subject `Welcome`.&lt;/p&gt;'</span>, <span class="hljs-string">'&lt;p&gt;For some extra help, look to the upper right of the interface for the &lt;img src="'</span>, Lib.AssetUrl, <span class="hljs-string">'ui/s/tutorial.png" title="Interface Tutorial" style="width:19px;height:22px;vertical-align:middle;margin-left:-3px" /&gt; button.&lt;/p&gt;'</span>, <span class="hljs-string">'&lt;p&gt;Thanks for playing!&lt;/p&gt;'</span>].join(<span class="hljs-string">''</span>),
                            buttons: [{
                                text: <span class="hljs-string">"View Tutorial"</span>,
                                handler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                                    <span class="hljs-keyword">this</span>.hide();
                                    Lacuna.Messaging.showMessage(result.welcome_message_id);
                                },
                                isDefault: <span class="hljs-literal">true</span>
                            }, {
                                text: <span class="hljs-string">"Skip Tutorial"</span>,
                                handler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                                    <span class="hljs-keyword">this</span>.hide();
                                }
                            }]
                        });
                    }
                });
            }
        },
        DoLogin: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(error)</span> {</span>
            Dom.setStyle(document.body, <span class="hljs-string">'background'</span>, <span class="hljs-string">'url("'</span> + Lib.AssetUrl + <span class="hljs-string">'star_system/field.png") repeat scroll 0 0 black'</span>);
            <span class="hljs-keyword">this</span>.InitLogin();
            <span class="hljs-comment">//Game.OverlayManager.hideAll(); //don't need this.  the show already hides everything if it needs to</span>
            Lacuna.Game.LoginDialog.show(error);
            Lacuna.Menu.hide();
            Lacuna.Pulser.Hide();
        },
        Run: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-comment">//create menus (or update if already created)</span>
            Lacuna.Menu.create();
            <span class="hljs-comment">//set our interval going for resource calcs since Logout clears it</span>
            Game.recTime = <span class="hljs-built_in">Date</span>.now();
            Game.isRunning = <span class="hljs-number">1</span>;
            <span class="hljs-comment">//Game.recInt = setInterval(Game.Tick, 1000);</span></pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>possible new pattern for game loop</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GameLoop</span><span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">if</span> (Game.isRunning) {
                    Game.Tick();
                    setTimeout(GameLoop, <span class="hljs-number">1000</span>);
                }
            })();
            Game.planetRefreshInterval = setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">var</span> BodyServ = Game.Services.Body,
                    session = Game.GetSession(),
                    body = Game.GetCurrentPlanet();
                BodyServ.get_status({
                    session_id: session,
                    body_id: body.id
                }, {
                    success: Game.onRpc,
                    failure: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                    }
                });
            }, <span class="hljs-number">10</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
            <span class="hljs-comment">//chat system</span>
            Game.InitChat();
            <span class="hljs-comment">//init event subscribtions if we need to</span>
            Game.InitEvents();
            <span class="hljs-comment">//enable esc handler</span>
            Game.escListener.enable();
            document.title = <span class="hljs-string">'Lacuna Expanse - '</span> + Game.EmpireData.name;
            <span class="hljs-comment">//load the correct screen</span>
            <span class="hljs-keyword">var</span> locationId = Game.GetCookie(<span class="hljs-string">"locationId"</span>),
                locationView = Game.GetCookie(<span class="hljs-string">"locationView"</span>);
            <span class="hljs-keyword">if</span> (!locationId) {
                Lacuna.Menu.PlanetVisible();
                Lacuna.MapPlanet.Load(Game.EmpireData.current_planet_id || Game.EmpireData.home_planet_id);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (locationView === <span class="hljs-string">"planet"</span>) {
                Game.EmpireData.current_planet_id = locationId;
                Lacuna.MapStar.MapVisible(<span class="hljs-literal">false</span>);
                Lacuna.MapPlanet.MapVisible(<span class="hljs-literal">true</span>);
                Lacuna.Menu.PlanetVisible();
                Lacuna.MapPlanet.Load(locationId);
            }
            <span class="hljs-keyword">else</span> {
                Lacuna.MapStar.MapVisible(<span class="hljs-literal">true</span>);
                Lacuna.MapPlanet.MapVisible(<span class="hljs-literal">false</span>);
                Lacuna.Menu.StarVisible();
                Lacuna.MapStar.Load();
            }
            Lacuna.Pulser.Hide();
        },
        InitChat: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>One day, this will do something interesting.</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">        },
        InitEvents: _.once(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-comment">//this will be called on the first load and create menu</span>
            Lacuna.MapStar.subscribe(<span class="hljs-string">"onMapRpc"</span>, Game.onRpc);
            Lacuna.MapStar.subscribe(<span class="hljs-string">"onChangeToPlanetView"</span>, Game.onChangeToPlanetView);
            Lacuna.MapPlanet.subscribe(<span class="hljs-string">"onMapRpc"</span>, Game.onRpc);
            Lacuna.Menu.subscribe(<span class="hljs-string">"onChangeClick"</span>, Game.onChangeClick);
            Lacuna.Menu.subscribe(<span class="hljs-string">"onInboxClick"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                Game.OverlayManager.hideAll();
                Lacuna.Messaging.show();
            });
            Lacuna.Menu.subscribe(<span class="hljs-string">"onDestructClick"</span>, Game.onDestructClick);
            Lacuna.Messaging.subscribe(<span class="hljs-string">"onRpc"</span>, Game.onRpc);
            Lacuna.Essentia.subscribe(<span class="hljs-string">"onRpc"</span>, Game.onRpc);
            Lacuna.Invite.subscribe(<span class="hljs-string">"onRpc"</span>, Game.onRpc);
            Lacuna.Profile.subscribe(<span class="hljs-string">"onRpc"</span>, Game.onRpc);
            Event.on(window, <span class="hljs-string">"resize"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
                <span class="hljs-comment">//taken from YUI Overlay</span>
                <span class="hljs-keyword">if</span> (YAHOO.env.ua.ie) {
                    <span class="hljs-keyword">if</span> (!window.resizeEnd) {
                        window.resizeEnd = -<span class="hljs-number">1</span>;
                    }
                    clearTimeout(window.resizeEnd);
                    window.resizeEnd = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                        Lacuna.Game.Resize();
                    }, <span class="hljs-number">100</span>);
                }
                <span class="hljs-keyword">else</span> {
                    Lacuna.Game.Resize();
                }
            });
        }),
        InitServices: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(smd)</span> {</span>
            <span class="hljs-keyword">var</span> serviceOut = {};
            <span class="hljs-keyword">var</span> successFunc = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> methodName <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>) {
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasOwnProperty(methodName) &amp;&amp; Lang.isFunction(<span class="hljs-keyword">this</span>[methodName])) {
                        <span class="hljs-keyword">var</span> method = <span class="hljs-keyword">this</span>[methodName];
                        <span class="hljs-keyword">this</span>[methodName] = Game.WrappedService(method, sKey + <span class="hljs-string">'.'</span> + methodName);
                    }
                }
            };
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> sKey <span class="hljs-keyword">in</span> smd) {
                <span class="hljs-keyword">if</span> (smd.hasOwnProperty(sKey)) {
                    <span class="hljs-keyword">var</span> oSmd = smd[sKey];
                    <span class="hljs-keyword">if</span> (oSmd.services) {
                        serviceOut[sKey] = <span class="hljs-keyword">new</span> YAHOO.rpc.Service(oSmd, {
                            success: successFunc
                        }, Game.RPCBase);
                    }
                    <span class="hljs-keyword">else</span> {
                        serviceOut[sKey] = Game.InitServices(oSmd);
                    }
                }
            }
            <span class="hljs-keyword">return</span> serviceOut;
        },
        WrappedService: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method, name)</span> {</span>
            <span class="hljs-keyword">var</span> logNS = <span class="hljs-string">'Game.RPC.'</span> + name + <span class="hljs-string">'.failure'</span>;
            <span class="hljs-keyword">var</span> func = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(params, origOpts)</span> {</span>
                <span class="hljs-keyword">var</span> retry = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">var</span> opts = {
                        retry: <span class="hljs-number">0</span>
                    };
                    YAHOO.lang.augmentObject(opts, origOpts, <span class="hljs-literal">true</span>);
                    opts.retry++;
                    func(params, opts);
                };
                <span class="hljs-keyword">var</span> opts = {
                    failure: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
                        <span class="hljs-keyword">var</span> failure = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(silent)</span> {</span>
                            <span class="hljs-keyword">if</span> (Lang.isFunction(origOpts.failure)) {
                                <span class="hljs-keyword">if</span> (origOpts.failure.call(self, o)) {
                                    <span class="hljs-keyword">return</span>;
                                }
                            }
                            <span class="hljs-keyword">if</span> (!silent) {
                                alert(o.error.message);
                            }
                        };
                        YAHOO.log(o, <span class="hljs-string">"error"</span>, logNS);
                        Lacuna.Pulser.Hide();
                        Game.Failure(o, retry, failure);
                    }
                };
                YAHOO.lang.augmentObject(opts, origOpts);
                <span class="hljs-keyword">if</span> (!(<span class="hljs-string">'timeout'</span> <span class="hljs-keyword">in</span> opts)) {
                    opts.timeout = Game.Timeout;
                }
                method(params, opts);
            };
            <span class="hljs-keyword">return</span> func;
        },
        InitTips: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (!Game.Resources.tips &amp;&amp; !Game.Resources.complete) {
                setTimeout(Game.InitTips, <span class="hljs-number">10</span>);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">var</span> showTips = <span class="hljs-number">1</span> - Game.GetCookieSettings(<span class="hljs-string">"hideTips"</span>, <span class="hljs-string">"0"</span>) * <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (showTips === <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">var</span> tipCount = Game.Resources.tips.length,
                    tipNum = Game.GetCookieSettings(<span class="hljs-string">"tipNum"</span>, -<span class="hljs-number">1</span>),
                    showTip = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dialog, change)</span> {</span>
                        tipNum = (tipNum + change + tipCount) % tipCount;
                        <span class="hljs-keyword">var</span> tip = Game.Resources.tips[tipNum];
                        dialog.setBody(tip);
                        Game.SetCookieSettings(<span class="hljs-string">"tipNum"</span>, tipNum);
                    };
                Game.QuickDialog({
                    width: <span class="hljs-string">"400px"</span>,
                    buttons: [{
                        text: <span class="hljs-string">"&lt; Previous"</span>,
                        handler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                            showTip(dialog, -<span class="hljs-number">1</span>);
                        }
                    }, {
                        text: <span class="hljs-string">"Next &gt;"</span>,
                        handler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                            showTip(dialog, <span class="hljs-number">1</span>);
                        }
                    }, {
                        text: <span class="hljs-string">"Close"</span>,
                        handler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                            <span class="hljs-keyword">this</span>.hide();
                        },
                        isDefault: <span class="hljs-literal">true</span>
                    }]
                }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">this</span>.setHeader(<span class="hljs-string">'Tips'</span>);
                    showTip(<span class="hljs-keyword">this</span>, <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">var</span> label = document.createElement(<span class="hljs-string">'label'</span>);
                    Dom.setStyle(label, <span class="hljs-string">'float'</span>, <span class="hljs-string">'left'</span>);
                    label.innerHTML = <span class="hljs-string">'&lt;input id="showTips" type="checkbox" checked="checked" /&gt; Show tips at login'</span>;
                    <span class="hljs-keyword">this</span>.footer.insertBefore(label, <span class="hljs-keyword">this</span>.footer.firstChild);
                }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">if</span> (Dom.get(<span class="hljs-string">'showTips'</span>)
                        .checked) {
                        Game.RemoveCookieSettings(<span class="hljs-string">"hideTips"</span>);
                    }
                    <span class="hljs-keyword">else</span> {
                        Game.SetCookieSettings(<span class="hljs-string">"hideTips"</span>, <span class="hljs-string">"1"</span>);
                    }
                });
            }
        },
        PreloadUI: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> images = Lib.UIImages;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; images.length; i++) {
                <span class="hljs-keyword">var</span> url = Lib.AssetUrl + images[i];
                <span class="hljs-keyword">var</span> img = <span class="hljs-keyword">new</span> Image();
                img.src = url;
            }
        },
        QuickDialog: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(config, afterRender, afterHide)</span> {</span>
            <span class="hljs-keyword">var</span> container = document.createElement(<span class="hljs-string">'div'</span>);
            <span class="hljs-keyword">if</span> (config.id) {
                container.id = config.id;
                <span class="hljs-keyword">delete</span> config.id;
            }
            YAHOO.lang.augmentObject(config, {
                fixedcenter: <span class="hljs-literal">true</span>,
                visible: <span class="hljs-literal">false</span>,
                draggable: <span class="hljs-literal">false</span>,
                constraintoviewport: <span class="hljs-literal">true</span>,
                modal: <span class="hljs-literal">true</span>,
                close: <span class="hljs-literal">false</span>,
                zindex: <span class="hljs-number">20000</span>
            });
            Dom.addClass(container, <span class="hljs-string">'quick-dialog'</span>);
            document.body.insertBefore(container, document.body.firstChild);
            <span class="hljs-keyword">var</span> dialog = <span class="hljs-keyword">new</span> YAHOO.widget.SimpleDialog(container, config);
            dialog.renderEvent.subscribe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">if</span> (afterRender) {
                    afterRender.call(<span class="hljs-keyword">this</span>);
                }
                <span class="hljs-keyword">this</span>.show();
            });
            dialog.hideEvent.subscribe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">if</span> (afterHide) {
                    afterHide.call(<span class="hljs-keyword">this</span>);
                }</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>let the current process complete before destroying</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    dialog.destroy();
                }, <span class="hljs-number">1</span>);
            });
            dialog.render();
            Game.OverlayManager.register(dialog);
        },
        onChangeToPlanetView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(planetId)</span> {</span>
            YAHOO.log(planetId, <span class="hljs-string">"info"</span>, <span class="hljs-string">"onChangeToPlanetView"</span>);
            Game.PlanetJump(Game.EmpireData.planets[planetId]);
        },
        onRpc: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(oResult)</span> {</span>
            Lacuna.Game.ProcessStatus(oResult.status);
        },
        onChangeClick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            YAHOO.log(<span class="hljs-string">"onChangeClick"</span>, <span class="hljs-string">"debug"</span>, <span class="hljs-string">"Game"</span>);
            Game.OverlayManager.hideAll();
            <span class="hljs-keyword">if</span> (Lacuna.MapStar.IsVisible() || Lacuna.Menu.IsStarVisible()) {
                Game.PlanetJump(Game.GetCurrentPlanet());
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Lacuna.MapPlanet.IsVisible() || Lacuna.Menu.IsPlanetVisible()) {
                Lacuna.MapPlanet.MapVisible(<span class="hljs-literal">false</span>);
                Lacuna.MapStar.MapVisible(<span class="hljs-literal">true</span>);
                Lacuna.Menu.StarVisible();
                Lacuna.MapStar.Load();
            }
        },
        onDestructClick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            YAHOO.log(<span class="hljs-string">"onDestructClick"</span>, <span class="hljs-string">"debug"</span>, <span class="hljs-string">"Game"</span>);
            <span class="hljs-keyword">var</span> ED = Game.EmpireData,
                EmpireServ = Game.Services.Empire,
                session = Game.GetSession(),
                func;
            <span class="hljs-keyword">if</span> (ED.self_destruct_active * <span class="hljs-number">1</span> === <span class="hljs-number">1</span>) {
                func = EmpireServ.disable_self_destruct;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (confirm(<span class="hljs-string">"Are you certain you want to enable self destruct?  If enabled, your empire will be deleted after 24 hours."</span>)) {
                func = EmpireServ.enable_self_destruct;
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span>;
            }
            Lacuna.Pulser.Show();
            func({
                session_id: session
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">'info'</span>, <span class="hljs-string">'Game.onDestructClick.success'</span>);
                    Game.ProcessStatus(o.result.status);
                    Lacuna.Pulser.Hide();
                }
            });
        },
        ProcessStatus: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status)</span> {</span>
            <span class="hljs-keyword">if</span> (status) {
                <span class="hljs-keyword">var</span> doMenuUpdate;
                <span class="hljs-keyword">if</span> (status.server) {
                    <span class="hljs-comment">//add everything from status empire to game empire</span>
                    Lang.augmentObject(Game.ServerData, status.server, <span class="hljs-literal">true</span>);
                    Game.ServerData.time = Lib.parseServerDate(Game.ServerData.time);
                    <span class="hljs-keyword">if</span> (status.server.announcement) {
                        Lacuna.Announce.show();
                    }
                }
                <span class="hljs-keyword">if</span> (status.empire) {
                    <span class="hljs-comment">//convert to numbers</span>
                    status.empire.has_new_messages *= <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">if</span> (status.empire.happiness) {
                        status.empire.happiness *= <span class="hljs-number">1</span>;
                        status.empire.happiness_hour *= <span class="hljs-number">1</span>;
                    }
                    <span class="hljs-keyword">if</span> (!Lacuna.Game.EmpireData.planets) {
                        Lacuna.Game.EmpireData.planets = {};
                    }
                    <span class="hljs-keyword">if</span> (!Lacuna.Game.EmpireData.planetsByName) {
                        Lacuna.Game.EmpireData.planetsByName = {};
                    }
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> pKey <span class="hljs-keyword">in</span> status.empire.planets) {
                        <span class="hljs-keyword">if</span> (status.empire.planets.hasOwnProperty(pKey)) {
                            <span class="hljs-keyword">var</span> ePlanet = Lacuna.Game.EmpireData.planets[pKey];
                            <span class="hljs-keyword">if</span> (!ePlanet) {
                                Lacuna.Game.EmpireData.planets[pKey] = {
                                    id: pKey,
                                    name: status.empire.planets[pKey],
                                    star_name: <span class="hljs-string">""</span>,
                                    image: <span class="hljs-literal">undefined</span>,
                                    energy_capacity: <span class="hljs-number">0</span>,
                                    energy_hour: <span class="hljs-number">0</span>,
                                    energy_stored: <span class="hljs-number">0</span>,
                                    food_capacity: <span class="hljs-number">0</span>,
                                    food_hour: <span class="hljs-number">0</span>,
                                    food_stored: <span class="hljs-number">0</span>,
                                    happiness: <span class="hljs-number">0</span>,
                                    happiness_hour: <span class="hljs-number">0</span>,
                                    ore_capacity: <span class="hljs-number">0</span>,
                                    ore_hour: <span class="hljs-number">0</span>,
                                    ore_stored: <span class="hljs-number">0</span>,
                                    waste_capacity: <span class="hljs-number">0</span>,
                                    waste_hour: <span class="hljs-number">0</span>,
                                    waste_stored: <span class="hljs-number">0</span>,
                                    water_capacity: <span class="hljs-number">0</span>,
                                    water_hour: <span class="hljs-number">0</span>,
                                    water_stored: <span class="hljs-number">0</span>
                                };
                            }
                            <span class="hljs-keyword">else</span> {
                                Lacuna.Game.EmpireData.planets[pKey].name = status.empire.planets[pKey];
                            }
                            Lacuna.Game.EmpireData.planetsByName[status.empire.planets[pKey]] = Lacuna.Game.EmpireData.planets[pKey];
                            doMenuUpdate = <span class="hljs-literal">true</span>;
                        }
                    }
                    <span class="hljs-keyword">delete</span> status.empire.planets; <span class="hljs-comment">//delete this so it doesn't overwrite the desired structure</span>
                    <span class="hljs-comment">//add everything from status empire to game empire</span>
                    Lang.augmentObject(Lacuna.Game.EmpireData, status.empire, <span class="hljs-literal">true</span>);
                    <span class="hljs-keyword">if</span> (!doMenuUpdate) {
                        Lacuna.Menu.updateTick();
                    }
                    <span class="hljs-comment">/*if(status.empire.full_status_update_required == 1) {
                    Lacuna.Game.GetStatus();
                }*/</span>
                }
                <span class="hljs-keyword">if</span> (status.body) {
                    <span class="hljs-keyword">var</span> planet = status.body,
                        p = Game.EmpireData.planets[planet.id];
                    <span class="hljs-keyword">if</span> (p) {
                        Lang.augmentObject(p, planet, <span class="hljs-literal">true</span>);
                        p.energy_capacity *= <span class="hljs-number">1</span>;
                        p.energy_hour *= <span class="hljs-number">1</span>;
                        p.energy_stored *= <span class="hljs-number">1</span>;
                        p.food_capacity *= <span class="hljs-number">1</span>;
                        p.food_hour *= <span class="hljs-number">1</span>;
                        p.food_stored *= <span class="hljs-number">1</span>;
                        p.happiness *= <span class="hljs-number">1</span>;
                        p.happiness_hour *= <span class="hljs-number">1</span>;
                        p.ore_capacity *= <span class="hljs-number">1</span>;
                        p.ore_hour *= <span class="hljs-number">1</span>;
                        p.ore_stored *= <span class="hljs-number">1</span>;
                        p.waste_capacity *= <span class="hljs-number">1</span>;
                        p.waste_hour *= <span class="hljs-number">1</span>;
                        p.waste_stored *= <span class="hljs-number">1</span>;
                        p.water_capacity *= <span class="hljs-number">1</span>;
                        p.water_hour *= <span class="hljs-number">1</span>;
                        p.water_stored *= <span class="hljs-number">1</span>;
                        doMenuUpdate = <span class="hljs-literal">true</span>;
                    }
                    <span class="hljs-keyword">if</span> (planet.needs_surface_refresh &amp;&amp; planet.needs_surface_refresh * <span class="hljs-number">1</span> === <span class="hljs-number">1</span>) {
                        Lacuna.MapPlanet.Refresh();
                    }
                    Lacuna.Notify.Load(planet);
                }
                <span class="hljs-keyword">if</span> (doMenuUpdate) {
                    Lacuna.Menu.update();
                }
            }
        },
        GetStatus: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
            <span class="hljs-keyword">var</span> EmpireServ = Game.Services.Empire,
                session = Game.GetSession();
            EmpireServ.get_status({
                session_id: session
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Game.GetStatus.success"</span>);
                    Lacuna.Game.ProcessStatus(o.result);
                    <span class="hljs-keyword">if</span> (callback &amp;&amp; callback.success) {
                        <span class="hljs-keyword">return</span> callback.success.call(<span class="hljs-keyword">this</span>);
                    }
                },
                failure: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">if</span> (callback &amp;&amp; callback.failure) {
                        <span class="hljs-keyword">return</span> callback.failure.call(<span class="hljs-keyword">this</span>, o);
                    }
                },
                scope: callback &amp;&amp; callback.scope || <span class="hljs-keyword">this</span>
            });
        },
        GetSession: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(replace)</span> {</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._session) {
                <span class="hljs-keyword">this</span>._session = Game.GetCookie(<span class="hljs-string">'session'</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._session || replace;
        },
        SetSession: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(session)</span> {</span>
            <span class="hljs-keyword">if</span> (session) {
                Game.SetCookie(<span class="hljs-string">'session'</span>, session);
                Game._session = session;
                Game.InitTips();
            }
            <span class="hljs-keyword">else</span> {
                Game.RemoveCookie(<span class="hljs-string">'session'</span>);
                <span class="hljs-keyword">delete</span> Game._session;
            }
        },
        GetCurrentPlanet: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> ED = Game.EmpireData,
                id = ED.current_planet_id || ED.home_planet_id;
            <span class="hljs-keyword">return</span> ED.planets[id];
        },
        GetSize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> content = document.getElementById(<span class="hljs-string">"content"</span>),
                width = content.offsetWidth,
                height = document.documentElement.clientHeight - document.getElementById(<span class="hljs-string">"header"</span>)
                    .offsetHeight - document.getElementById(<span class="hljs-string">"footer"</span>)
                    .offsetHeight;
            <span class="hljs-keyword">return</span> {
                w: width,
                h: height
            };
        },
        Resize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (Lacuna.MapStar.IsVisible()) {
                Lacuna.MapStar.Resize();
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Lacuna.MapPlanet.IsVisible()) {
                Lacuna.MapPlanet.Resize();
            }
        },
        StarJump: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(star)</span> {</span>
            YAHOO.log(star, <span class="hljs-string">"debug"</span>, <span class="hljs-string">"StarJump"</span>);
            Game.OverlayManager.hideAll();
            Lacuna.MapPlanet.MapVisible(<span class="hljs-literal">false</span>);
            Lacuna.MapStar.MapVisible(<span class="hljs-literal">true</span>);
            Lacuna.Menu.StarVisible();
            Lacuna.MapStar.Jump(star.x * <span class="hljs-number">1</span>, star.y * <span class="hljs-number">1</span>);
        },
        PlanetJump: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(planet)</span> {</span>
            <span class="hljs-keyword">if</span> (!planet) {
                <span class="hljs-comment">//try to find home planet</span>
                planet = Game.EmpireData.planets[Game.EmpireData.home_planet_id];
            }
            <span class="hljs-comment">//make sure we have found a planet to look at</span>
            <span class="hljs-keyword">if</span> (planet) {
                Game.OverlayManager.hideAll();
                Game.EmpireData.current_planet_id = planet.id;
                Lacuna.Menu.PlanetMenu.update();
                Game.SetLocation(planet.id, Lib.View.PLANET);
                Lacuna.MapStar.MapVisible(<span class="hljs-literal">false</span>);
                Lacuna.Menu.PlanetVisible();
                Lacuna.MapPlanet.Load(planet.id, <span class="hljs-literal">true</span>);
            }
        },
        PlanetChange: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(planet)</span> {</span>
            <span class="hljs-keyword">if</span> (!planet) {
                <span class="hljs-comment">//try to find home planet</span>
                planet = Game.EmpireData.planets[Game.EmpireData.home_planet_id];
            }
            <span class="hljs-comment">//make sure we have found a planet to look at</span>
            <span class="hljs-keyword">if</span> (planet) {
                Game.OverlayManager.hideAll();
                Game.EmpireData.current_planet_id = planet.id;
                Lacuna.Menu.PlanetMenu.update();
                Game.SetLocation(planet.id, Lib.View.PLANET);
                Lacuna.MapPlanet.Load(planet.id, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);
            }
        },
        GetResources: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> newResources = <span class="hljs-built_in">require</span>(<span class="hljs-string">'data/resources.json'</span>);
            Game.Resources = newResources;
            Game.Resources.complete = <span class="hljs-number">1</span>;
        },
        GetBuildingDesc: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(url)</span> {</span>
            <span class="hljs-keyword">if</span> (Game.Resources &amp;&amp; Game.Resources.buildings) {
                <span class="hljs-keyword">var</span> desc = Game.Resources.buildings[url];
                <span class="hljs-keyword">if</span> (desc) {
                    <span class="hljs-keyword">return</span> [desc.description, <span class="hljs-string">' &lt;a href="'</span>, desc.wiki, <span class="hljs-string">'" target="_blank"&gt;More Information on Wiki&lt;/a&gt;'</span>].join(<span class="hljs-string">''</span>);
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
                }
            }
        },
        GetShipDesc: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type)</span> {</span>
            <span class="hljs-keyword">if</span> (Game.Resources &amp;&amp; Game.Resources.ships) {
                <span class="hljs-keyword">var</span> desc = Game.Resources.ships[type];
                <span class="hljs-keyword">if</span> (desc) {
                    <span class="hljs-keyword">return</span> [desc.description, <span class="hljs-string">' &lt;a href="'</span>, desc.wiki, <span class="hljs-string">'" target="_blank"&gt;More Information on Wiki&lt;/a&gt;'</span>].join(<span class="hljs-string">''</span>);
                }
            }
        },
        GetContainerEffect: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(effect)</span> {</span>
            <span class="hljs-keyword">if</span> (Game.GetCookieSettings(<span class="hljs-string">"disableDialogAnim"</span>, <span class="hljs-string">"0"</span>) === <span class="hljs-string">"1"</span>) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> effect || {
                    effect: YAHOO.widget.ContainerEffect.FADE,
                    duration: <span class="hljs-number">0.5</span>
                };
            }
        },
        Logout: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">var</span> EmpireServ = Game.Services.Empire,
                session = Game.GetSession();
            EmpireServ.logout({
                session_id: session
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">'info'</span>, <span class="hljs-string">'Game.Logout.success'</span>);
                    Game.Reset();
                    Game.DoLogin();
                    Lacuna.Pulser.Hide();
                }
            });
        },
        Reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">delete</span> Game.isRunning;
            clearInterval(Game.planetRefreshInterval);
            <span class="hljs-keyword">delete</span> Game.planetRefreshInterval;
            <span class="hljs-comment">//disable esc handler</span>
            Game.escListener.disable();
            document.title = <span class="hljs-string">'Lacuna Expanse'</span>;
            <span class="hljs-keyword">var</span> logoutCommand = Game.chatLogout;
            Game.RemoveCookie(<span class="hljs-string">"locationId"</span>);
            Game.RemoveCookie(<span class="hljs-string">"locationView"</span>);
            Game.SetSession();
            Game.EmpireData = {};
            Lacuna.Stats.Reset();
            Lacuna.MapStar.Reset();
            Lacuna.MapPlanet.Reset();
            Lacuna.Notify.Hide();
            <span class="hljs-comment">//do this last since we don't control the code</span>
            <span class="hljs-keyword">if</span> (logoutCommand &amp;&amp; window.env_executeCommand) {
                YAHOO.log(<span class="hljs-string">"Chat logout of session"</span>, <span class="hljs-string">"debug"</span>, <span class="hljs-string">"Reset"</span>);
                window.env_executeCommand(logoutCommand);
            }
        },
        <span class="hljs-comment">//Cookie helpers functions</span>
        GetCookie: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, defaultValue)</span> {</span>
            <span class="hljs-keyword">var</span> item = Lib.db.getItem(key);
            <span class="hljs-keyword">return</span> item || defaultValue;
        },
        SetCookie: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value)</span> {</span>
            Lib.db.setItem(key, value);
        },
        RemoveCookie: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> {</span>
            Lib.db.removeItem(key);
        },
        RemoveAllCookies: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            Lib.db.clear();
        },
        SetLocation: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id, view)</span> {</span>
            Game.SetCookie(<span class="hljs-string">"locationId"</span>, id);
            Game.SetCookie(<span class="hljs-string">"locationView"</span>, view);
        },
        <span class="hljs-comment">//using a more permanent cookie</span>
        GetCookieSettings: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, defaultValue)</span> {</span>
            <span class="hljs-keyword">var</span> item = Lib.settings.getItem(key);
            <span class="hljs-keyword">return</span> item || defaultValue;
        },
        SetCookieSettings: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value)</span> {</span>
            Lib.settings.setItem(key, value);
        },
        RemoveCookieSettings: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> {</span>
            Lib.settings.clear();
        },
        <span class="hljs-comment">//Tick related</span>
        Tick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> ED = Lacuna.Game.EmpireData,
                SD = Lacuna.Game.ServerData,
                dt = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>())
                    .getTime(),
                diff = dt - Lacuna.Game.recTime;
            Lacuna.Game.recTime = dt;
            SD.time = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(Lib.getTime(SD.time) + diff);
            <span class="hljs-keyword">var</span> ratio = (diff / Lacuna.Game.HourMS),
                updateMenu = <span class="hljs-literal">true</span>,
                totalWasteOverage = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> pKey <span class="hljs-keyword">in</span> ED.planets) {
                <span class="hljs-keyword">if</span> (ED.planets.hasOwnProperty(pKey)) {
                    <span class="hljs-keyword">var</span> planet = ED.planets[pKey],
                        isNotStation = planet.type !== <span class="hljs-string">"space station"</span>;
                    <span class="hljs-keyword">if</span> (planet.energy_stored &lt; planet.energy_capacity) {
                        planet.energy_stored += planet.energy_hour * ratio;
                        <span class="hljs-keyword">if</span> (planet.energy_stored &gt; planet.energy_capacity) {
                            planet.energy_stored = planet.energy_capacity;
                        }
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (planet.energy_stored &lt; <span class="hljs-number">0</span>) {
                            <span class="hljs-keyword">if</span> (isNotStation) {
                                planet.happiness += planet.energy_stored;
                            }
                            planet.energy_stored = <span class="hljs-number">0</span>;
                        }
                    }
                    <span class="hljs-keyword">if</span> (planet.food_stored &lt; planet.food_capacity) {
                        planet.food_stored += planet.food_hour * ratio;
                        <span class="hljs-keyword">if</span> (planet.food_stored &gt; planet.food_capacity) {
                            planet.food_stored = planet.food_capacity;
                        }
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (planet.food_stored &lt; <span class="hljs-number">0</span>) {
                            <span class="hljs-keyword">if</span> (isNotStation) {
                                planet.happiness += planet.food_stored;
                            }
                            planet.food_stored = <span class="hljs-number">0</span>;
                        }
                    }
                    <span class="hljs-keyword">if</span> (planet.ore_stored &lt; planet.ore_capacity) {
                        planet.ore_stored += planet.ore_hour * ratio;
                        <span class="hljs-keyword">if</span> (planet.ore_stored &gt; planet.ore_capacity) {
                            planet.ore_stored = planet.ore_capacity;
                        }
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (planet.ore_stored &lt; <span class="hljs-number">0</span>) {
                            <span class="hljs-keyword">if</span> (isNotStation) {
                                planet.happiness += planet.ore_stored;
                            }
                            planet.ore_stored = <span class="hljs-number">0</span>;
                        }
                    }
                    <span class="hljs-keyword">if</span> (planet.water_stored &lt; planet.water_capacity) {
                        planet.water_stored += planet.water_hour * ratio;
                        <span class="hljs-keyword">if</span> (planet.water_stored &gt; planet.water_capacity) {
                            planet.water_stored = planet.water_capacity;
                        }
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (planet.water_stored &lt; <span class="hljs-number">0</span>) {
                            <span class="hljs-keyword">if</span> (isNotStation) {
                                planet.happiness += planet.water_stored;
                            }
                            planet.water_stored = <span class="hljs-number">0</span>;
                        }
                    }
                    <span class="hljs-keyword">var</span> wasteOverage = <span class="hljs-number">0</span>;
                    <span class="hljs-keyword">if</span> (planet.waste_stored &lt; planet.waste_capacity) {
                        planet.waste_stored += planet.waste_hour * ratio;
                        <span class="hljs-keyword">if</span> (planet.waste_stored &gt; planet.waste_capacity) {
                            wasteOverage = planet.waste_stored - planet.waste_capacity;
                            planet.waste_stored = planet.waste_capacity;
                        }
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (planet.waste_stored &lt; <span class="hljs-number">0</span>) {
                            <span class="hljs-keyword">if</span> (isNotStation) {
                                planet.happiness += planet.waste_stored;
                            }
                            planet.waste_stored = <span class="hljs-number">0</span>;
                        }
                    }
                    <span class="hljs-keyword">else</span> {
                        wasteOverage = planet.waste_hour * ratio;
                    }
                    <span class="hljs-keyword">if</span> (isNotStation) {
                        planet.happiness += (planet.happiness_hour * ratio) - wasteOverage;
                        <span class="hljs-keyword">if</span> (planet.happiness &lt; <span class="hljs-number">0</span> &amp;&amp; ED.is_isolationist === <span class="hljs-string">"1"</span>) {
                            planet.happiness = <span class="hljs-number">0</span>;
                        }
                        <span class="hljs-comment">//totalWasteOverage += wasteOverage;</span>
                    }
                }
            }
            <span class="hljs-keyword">if</span> (updateMenu) {
                Lacuna.Menu.updateTick();
            }
            Game.onTick.fire(diff);
        },
        QueueAdd: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id, type, ms)</span> {</span>
            <span class="hljs-keyword">if</span> (!id || !type || !ms) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">if</span> (!Game.queue) {
                Game.queue = {};
            }
            <span class="hljs-keyword">if</span> (!Game.queue[type]) {
                Game.queue[type] = {};
            }
            Game.queue[type][id] = ms;
        },
        QueueProcess: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, oArgs)</span> {</span>
            <span class="hljs-comment">//only do anything if the queue actually has data</span>
            <span class="hljs-keyword">if</span> (Game.queue) {
                <span class="hljs-keyword">var</span> toFire = {},
                    tickMS = oArgs[<span class="hljs-number">0</span>];
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> type <span class="hljs-keyword">in</span> Game.queue) {
                    <span class="hljs-keyword">if</span> (Game.queue.hasOwnProperty(type)) {
                        <span class="hljs-keyword">var</span> qt = Game.queue[type];
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> id <span class="hljs-keyword">in</span> qt) {
                            <span class="hljs-keyword">if</span> (qt.hasOwnProperty(id)) {
                                <span class="hljs-keyword">var</span> ms = qt[id] - tickMS;
                                <span class="hljs-keyword">if</span> (ms &lt;= <span class="hljs-number">0</span>) {
                                    toFire[id] = type;
                                }
                                <span class="hljs-keyword">else</span> {
                                    qt[id] = ms;
                                    Game.QueueTick(type, id, ms);
                                }
                            }
                        }
                    }
                }
                <span class="hljs-keyword">var</span> fId;
                <span class="hljs-keyword">for</span> (fId <span class="hljs-keyword">in</span> toFire) {
                    <span class="hljs-keyword">if</span> (toFire.hasOwnProperty(fId)) {
                        <span class="hljs-keyword">delete</span> Game.queue[toFire[fId]][fId];
                        Game.QueueFire(toFire[fId], fId);
                    }
                }
            }
        },
        QueueTick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, id, ms)</span> {</span>
            <span class="hljs-keyword">switch</span> (type) {
                <span class="hljs-keyword">case</span> Lib.QueueTypes.PLANET:
                    Lacuna.MapPlanet.QueueTick(id, ms);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> Lib.QueueTypes.STAR:
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> Lib.QueueTypes.SYSTEM:
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">break</span>;
            }
        },
        QueueFire: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, id)</span> {</span>
            YAHOO.log(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">"debug"</span>, <span class="hljs-string">"Game.QueueFire"</span>);
            <span class="hljs-keyword">switch</span> (type) {
                <span class="hljs-keyword">case</span> Lib.QueueTypes.PLANET:
                    Lacuna.MapPlanet.ReLoadTile(id);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> Lib.QueueTypes.STAR:
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> Lib.QueueTypes.SYSTEM:
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    YAHOO.log(<span class="hljs-string">"type unknown"</span>, <span class="hljs-string">"debug"</span>, <span class="hljs-string">"Game.QueueFire"</span>);
                    <span class="hljs-keyword">break</span>;
            }
        },
        QueueResetPlanet: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (Game.queue &amp;&amp; Game.queue[Lib.QueueTypes.PLANET]) {
                <span class="hljs-keyword">var</span> queue = Game.queue[Lib.QueueTypes.PLANET];
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> id <span class="hljs-keyword">in</span> queue) {
                    <span class="hljs-keyword">if</span> (queue.hasOwnProperty(id)) {
                        queue[id] = <span class="hljs-number">0</span>;
                    }
                }
            }
        },
        onScroll: (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> evName;
            <span class="hljs-keyword">var</span> func;
            <span class="hljs-keyword">var</span> pixelsPerLine = <span class="hljs-number">10</span>;
            <span class="hljs-keyword">var</span> ua = navigator.userAgent;
            <span class="hljs-keyword">var</span> safari5 = ua.match(<span class="hljs-regexp">/\bSafari\//</span>) &amp;&amp; ua.match(<span class="hljs-regexp">/\bVersion\/5/</span>);
            <span class="hljs-keyword">var</span> isEventSupported = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">var</span> TAGNAMES = {
                    <span class="hljs-string">'select'</span>: <span class="hljs-string">'input'</span>,
                    <span class="hljs-string">'change'</span>: <span class="hljs-string">'input'</span>,
                    <span class="hljs-string">'submit'</span>: <span class="hljs-string">'form'</span>,
                    <span class="hljs-string">'reset'</span>: <span class="hljs-string">'form'</span>,
                    <span class="hljs-string">'error'</span>: <span class="hljs-string">'img'</span>,
                    <span class="hljs-string">'load'</span>: <span class="hljs-string">'img'</span>,
                    <span class="hljs-string">'abort'</span>: <span class="hljs-string">'img'</span>
                };
                <span class="hljs-keyword">var</span> cache = {};

                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isEventSupported</span><span class="hljs-params">(eventName)</span> {</span>
                    <span class="hljs-keyword">var</span> el = document.createElement(TAGNAMES[eventName] || <span class="hljs-string">'div'</span>);
                    eventName = <span class="hljs-string">'on'</span> + eventName;
                    <span class="hljs-keyword">if</span> (eventName <span class="hljs-keyword">in</span> cache) {
                        <span class="hljs-keyword">return</span> cache[eventName];
                    }
                    <span class="hljs-keyword">var</span> isSupported = (eventName <span class="hljs-keyword">in</span> el);
                    <span class="hljs-keyword">if</span> (!isSupported) {
                        el.setAttribute(eventName, <span class="hljs-string">'return;'</span>);
                        isSupported = <span class="hljs-keyword">typeof</span> el[eventName] === <span class="hljs-string">'function'</span>;
                    }
                    cache[eventName] = isSupported;
                    el = <span class="hljs-literal">null</span>;
                    <span class="hljs-keyword">return</span> isSupported;
                }
                <span class="hljs-keyword">return</span> isEventSupported;
            })();
            <span class="hljs-keyword">if</span> (isEventSupported(<span class="hljs-string">'mousewheel'</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, fn, obj, context)</span> {</span>
                    Event.on(el, <span class="hljs-string">'mousewheel'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, o)</span> {</span>
                        <span class="hljs-keyword">var</span> xDelta = <span class="hljs-string">'wheelDeltaX'</span> <span class="hljs-keyword">in</span> e ? e.wheelDeltaX : <span class="hljs-number">0</span>;
                        <span class="hljs-keyword">var</span> yDelta = <span class="hljs-string">'wheelDeltaY'</span> <span class="hljs-keyword">in</span> e ? e.wheelDeltaY : e.wheelDelta;</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>chrome/safari 4 give pixels
safari 5 gives pixels * 120</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">                        <span class="hljs-keyword">if</span> (safari5) {
                            xDelta /= <span class="hljs-number">120</span>;
                            yDelta /= <span class="hljs-number">120</span>;
                        }
                        fn.call(<span class="hljs-keyword">this</span>, e, xDelta, yDelta, o);
                    }, obj, context);
                };
            }</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>not possible to feature detect this, have to just use the version number</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (YAHOO.env.ua.gecko &gt;= <span class="hljs-number">1.9</span> &amp;&amp; !ua.match(<span class="hljs-regexp">/\brv:1\.9\.0/</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, fn, obj, context)</span> {</span>
                    Event.on(el, <span class="hljs-string">'MozMousePixelScroll'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, o)</span> {</span>
                        <span class="hljs-keyword">var</span> xAxis = (e.axis === e.HORIZONTAL_AXIS);
                        <span class="hljs-keyword">var</span> xDelta = xAxis ? -e.detail : <span class="hljs-number">0</span>;
                        <span class="hljs-keyword">var</span> yDelta = xAxis ? <span class="hljs-number">0</span> : -e.detail;
                        fn.call(<span class="hljs-keyword">this</span>, e, xDelta, yDelta, o);
                    }, obj, context);
                };
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, fn, obj, context)</span> {</span>
                    Event.on(el, <span class="hljs-string">'DOMMouseScroll'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, o)</span> {</span>
                        <span class="hljs-keyword">var</span> xAxis = (<span class="hljs-string">'axis'</span> <span class="hljs-keyword">in</span> e &amp;&amp; e.axis === e.HORIZONTAL_AXIS);</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>this event gets &#39;lines&#39;</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">                        <span class="hljs-keyword">var</span> xDelta = xAxis ? -e.detail * pixelsPerLine : <span class="hljs-number">0</span>;
                        <span class="hljs-keyword">var</span> yDelta = xAxis ? <span class="hljs-number">0</span> : -e.detail * pixelsPerLine;
                        fn.call(<span class="hljs-keyword">this</span>, e, xDelta, yDelta, o);
                    }, obj, context);
                };
            }
        })()
    };
    YAHOO.lacuna.Game = Game;
})();</pre></div>
      
      </div>
    
    </div>
  </div>

  <script src="../../toc.js"></script>
  <script src="../../assets/libs.js"></script>
  <script src="../../assets/behavior.js"></script>
</body>
</html>
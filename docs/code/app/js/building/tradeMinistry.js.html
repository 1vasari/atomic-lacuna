<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title> - tradeMinistry.js</title>

  <link rel="stylesheet" href="../../../assets/style.css">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"/>
  <meta name="groc-relative-root" content="../../../"/>
  <meta name="groc-document-path" content="app/js/building/tradeMinistry.js"/>
  
</head>
<body>
  <div id="file-area">
    <div id="meta">
      <code class="file-path">
      
        app/js/building/tradeMinistry.js
      
      </code>
    </div>
    <div id="document">
    
      <div class="segment">
      
      
        <div class="code"><pre class="wrapper"><span class="hljs-pi">'use strict'</span>;
YAHOO.namespace(<span class="hljs-string">"lacuna.buildings"</span>);
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> Lang = YAHOO.lang,
        Util = YAHOO.util,
        Dom = Util.Dom,
        Event = Util.Event,
        Sel = Util.Selector,
        Pager = YAHOO.widget.Paginator,
        Lacuna = YAHOO.lacuna,
        Game = Lacuna.Game,
        Lib = Lacuna.Library;
    <span class="hljs-keyword">var</span> Trade = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(result)</span> {</span>
        Trade.superclass.constructor.call(<span class="hljs-keyword">this</span>, result);
        <span class="hljs-keyword">this</span>.service = Game.Services.Buildings.Trade;
        <span class="hljs-keyword">this</span>.availableAcceptText = <span class="hljs-string">"Accept"</span>;
        <span class="hljs-keyword">this</span>.addTradeText = <span class="hljs-string">"Add Trade"</span>;
        <span class="hljs-keyword">this</span>.pushTradeText = <span class="hljs-string">"Send"</span>;</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>defaults.  Values are updated to server numbers during get_* calls</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">        <span class="hljs-keyword">this</span>.shipSize = <span class="hljs-number">50000</span>;
        <span class="hljs-keyword">this</span>.planSize = <span class="hljs-number">10000</span>;
        <span class="hljs-keyword">this</span>.spySize = <span class="hljs-number">350</span>;
        <span class="hljs-keyword">this</span>.glyphSize = <span class="hljs-number">100</span>;
        <span class="hljs-keyword">this</span>.createEvent(<span class="hljs-string">"onLoadResources"</span>);
        <span class="hljs-keyword">this</span>.createEvent(<span class="hljs-string">"onLoadGlyphSummary"</span>);
        <span class="hljs-keyword">this</span>.createEvent(<span class="hljs-string">"onLoadPlanSummary"</span>);
        <span class="hljs-keyword">this</span>.createEvent(<span class="hljs-string">"onLoadShipSummary"</span>);
        <span class="hljs-keyword">this</span>.createEvent(<span class="hljs-string">"onLoadPrisoners"</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.building.level &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">this</span>.subscribe(<span class="hljs-string">"onLoad"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">this</span>.getStoredResources();
                <span class="hljs-keyword">this</span>.mine.subscribe(<span class="hljs-string">"activeChange"</span>, <span class="hljs-keyword">this</span>.getMyTrades, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">this</span>.avail.subscribe(<span class="hljs-string">"activeChange"</span>, <span class="hljs-keyword">this</span>.getAvailableTrades, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">this</span>.push.subscribe(<span class="hljs-string">"activeChange"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                    <span class="hljs-keyword">if</span> (e.newValue) {
                        <span class="hljs-keyword">this</span>.getPushShips();
                        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.tradePushSubbed) {
                            Event.on(<span class="hljs-string">"tradePushResources"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                                <span class="hljs-keyword">if</span> (Dom.getStyle(<span class="hljs-string">"tradePushResourceName"</span>, <span class="hljs-string">"display"</span>) === <span class="hljs-string">"none"</span>) {
                                    Dom.setStyle(<span class="hljs-string">"tradePushResourceName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"block"</span>);
                                    <span class="hljs-keyword">this</span>.getStoredResources();
                                } <span class="hljs-keyword">else</span> {
                                    Dom.setStyle(<span class="hljs-string">"tradePushResourceName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                                }
                            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                            Event.on(<span class="hljs-string">"tradePushGlyphSummary"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                                <span class="hljs-keyword">if</span> (Dom.getStyle(<span class="hljs-string">"tradePushGlyphSummaryName"</span>, <span class="hljs-string">"display"</span>) === <span class="hljs-string">"none"</span>) {
                                    Dom.setStyle(<span class="hljs-string">"tradePushGlyphSummaryName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"block"</span>);
                                    <span class="hljs-keyword">this</span>.getGlyphSummary();
                                } <span class="hljs-keyword">else</span> {
                                    Dom.setStyle(<span class="hljs-string">"tradePushGlyphSummaryName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                                }
                            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                            Event.on(<span class="hljs-string">"tradePushPlanSummary"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                                <span class="hljs-keyword">if</span> (Dom.getStyle(<span class="hljs-string">"tradePushPlanSummaryName"</span>, <span class="hljs-string">"display"</span>) === <span class="hljs-string">"none"</span>) {
                                    Dom.setStyle(<span class="hljs-string">"tradePushPlanSummaryName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"block"</span>);
                                    <span class="hljs-keyword">this</span>.getPlanSummary();
                                } <span class="hljs-keyword">else</span> {
                                    Dom.setStyle(<span class="hljs-string">"tradePushPlanSummaryName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                                }
                            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                            Event.on(<span class="hljs-string">"tradePushShipSummary"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                                <span class="hljs-keyword">if</span> (Dom.getStyle(<span class="hljs-string">"tradePushShipSummaryName"</span>, <span class="hljs-string">"display"</span>) === <span class="hljs-string">"none"</span>) {
                                    Dom.setStyle(<span class="hljs-string">"tradePushShipSummaryName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"block"</span>);
                                    <span class="hljs-keyword">this</span>.getShipSummary();
                                } <span class="hljs-keyword">else</span> {
                                    Dom.setStyle(<span class="hljs-string">"tradePushShipSummaryName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                                }
                            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                            Event.on(<span class="hljs-string">"tradePushPrisoners"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                                <span class="hljs-keyword">if</span> (Dom.getStyle(<span class="hljs-string">"tradePushPrisonerName"</span>, <span class="hljs-string">"display"</span>) === <span class="hljs-string">"none"</span>) {
                                    Dom.setStyle(<span class="hljs-string">"tradePushPrisonerName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"block"</span>);
                                    <span class="hljs-keyword">this</span>.getPrisoners();
                                } <span class="hljs-keyword">else</span> {
                                    Dom.setStyle(<span class="hljs-string">"tradePushPrisonerName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                                }
                            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        }
                        <span class="hljs-keyword">this</span>.tradePushSubbed = <span class="hljs-number">1</span>;
                    }
                }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">this</span>.add.subscribe(<span class="hljs-string">"activeChange"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                    <span class="hljs-keyword">if</span> (e.newValue) {
                        <span class="hljs-keyword">this</span>.getAddShips();
                        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.tradeAddSubbed) {
                            Event.on(<span class="hljs-string">"tradeAddResources"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                                <span class="hljs-keyword">if</span> (Dom.getStyle(<span class="hljs-string">"tradeAddResourceName"</span>, <span class="hljs-string">"display"</span>) === <span class="hljs-string">"none"</span>) {
                                    Dom.setStyle(<span class="hljs-string">"tradeAddResourceName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"block"</span>);
                                    <span class="hljs-keyword">this</span>.getStoredResources();
                                } <span class="hljs-keyword">else</span> {
                                    Dom.setStyle(<span class="hljs-string">"tradeAddResourceName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                                }
                            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                            Event.on(<span class="hljs-string">"tradeAddGlyphSummary"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                                <span class="hljs-keyword">if</span> (Dom.getStyle(<span class="hljs-string">"tradeAddGlyphSummaryName"</span>, <span class="hljs-string">"display"</span>) === <span class="hljs-string">"none"</span>) {
                                    Dom.setStyle(<span class="hljs-string">"tradeAddGlyphSummaryName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"block"</span>);
                                    <span class="hljs-keyword">this</span>.getGlyphSummary();
                                } <span class="hljs-keyword">else</span> {
                                    Dom.setStyle(<span class="hljs-string">"tradeAddGlyphSummaryName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                                }
                            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                            Event.on(<span class="hljs-string">"tradeAddPlanSummary"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                                <span class="hljs-keyword">if</span> (Dom.getStyle(<span class="hljs-string">"tradeAddPlanSummaryName"</span>, <span class="hljs-string">"display"</span>) === <span class="hljs-string">"none"</span>) {
                                    Dom.setStyle(<span class="hljs-string">"tradeAddPlanSummaryName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"block"</span>);
                                    <span class="hljs-keyword">this</span>.getPlanSummary();
                                } <span class="hljs-keyword">else</span> {
                                    Dom.setStyle(<span class="hljs-string">"tradeAddPlanSummaryName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                                }
                            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                            Event.on(<span class="hljs-string">"tradeAddShipSummary"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                                <span class="hljs-keyword">if</span> (Dom.getStyle(<span class="hljs-string">"tradeAddShipSummaryName"</span>, <span class="hljs-string">"display"</span>) === <span class="hljs-string">"none"</span>) {
                                    Dom.setStyle(<span class="hljs-string">"tradeAddShipSummaryName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"block"</span>);
                                    <span class="hljs-keyword">this</span>.getShipSummary();
                                } <span class="hljs-keyword">else</span> {
                                    Dom.setStyle(<span class="hljs-string">"tradeAddShipSummaryName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                                }
                            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                            Event.on(<span class="hljs-string">"tradeAddPrisoners"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                                <span class="hljs-keyword">if</span> (Dom.getStyle(<span class="hljs-string">"tradeAddPrisonerName"</span>, <span class="hljs-string">"display"</span>) === <span class="hljs-string">"none"</span>) {
                                    Dom.setStyle(<span class="hljs-string">"tradeAddPrisonerName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"block"</span>);
                                    <span class="hljs-keyword">this</span>.getPrisoners();
                                } <span class="hljs-keyword">else</span> {
                                    Dom.setStyle(<span class="hljs-string">"tradeAddPrisonerName"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                                }
                            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        }
                        <span class="hljs-keyword">this</span>.tradeAddSubbed = <span class="hljs-number">1</span>;
                    }
                }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
        }
    };
    Lang.extend(Trade, Lacuna.buildings.Building, {
        destroy: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.availablePager) {
                <span class="hljs-keyword">this</span>.availablePager.destroy();
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.minePage) {
                <span class="hljs-keyword">this</span>.minePage.destroy();
            }
            Trade.superclass.destroy.call(<span class="hljs-keyword">this</span>);
        },
        getChildTabs: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.mineTabIndex = <span class="hljs-number">3</span>; <span class="hljs-comment">//array location plus 1 since Production tab is always first</span>
            <span class="hljs-keyword">return</span> [<span class="hljs-keyword">this</span>._getPushTab(), <span class="hljs-keyword">this</span>._getAvailableTradesTab(), <span class="hljs-keyword">this</span>._getMyTradesTab(), <span class="hljs-keyword">this</span>._getAddTradeTab(), <span class="hljs-keyword">this</span>._getSupplyChainTab(), <span class="hljs-keyword">this</span>._getSupplyShipsTab(), <span class="hljs-keyword">this</span>._getWasteChainTab()];
        },
        _getPushTab: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.push = <span class="hljs-keyword">new</span> YAHOO.widget.Tab({
                label: <span class="hljs-string">"Push"</span>,
                content: [<span class="hljs-string">'&lt;div id="pHt"&gt;&lt;div class="tradeStash yui-g"&gt;'</span>, <span class="hljs-string">'    &lt;div class="yui-u first"&gt;'</span>, <span class="hljs-string">'        &lt;legend&gt;On Planet&lt;/legend&gt;'</span>, <span class="hljs-string">'        &lt;div class="tradeContainers"&gt;'</span>, <span class="hljs-string">'            &lt;div&gt;&lt;div id="tradePushResources" class="accordian"&gt;Resources&lt;/div&gt;&lt;ul id="tradePushResourceName"&gt;&lt;/ul&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'           &lt;div&gt;&lt;div id="tradePushGlyphSummary" class="accordian"&gt;Glyphs&lt;/div&gt;&lt;ul id="tradePushGlyphSummaryName" style="display:none;"&gt;&lt;/ul&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'           &lt;div&gt;&lt;div id="tradePushPlanSummary" class="accordian"&gt;Plans&lt;/div&gt;&lt;ul id="tradePushPlanSummaryName" style="display:none;"&gt;&lt;/ul&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'           &lt;div&gt;&lt;div id="tradePushShipSummary" class="accordian"&gt;Ships&lt;/div&gt;&lt;ul id="tradePushShipSummaryName" style="display:none;"&gt;&lt;/ul&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'            &lt;div&gt;&lt;div id="tradePushPrisoners" class="accordian"&gt;Prisoners&lt;/div&gt;&lt;ul id="tradePushPrisonerName" style="display:none;"&gt;&lt;/ul&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'        &lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;div class="yui-u"&gt;'</span>, <span class="hljs-string">'        &lt;legend&gt;To Push&lt;/legend&gt;'</span>, <span class="hljs-string">'        &lt;div class="tradeContainers"&gt;&lt;ul id="tradePushItems"&gt;&lt;/ul&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;/div&gt;'</span>, <span class="hljs-string">'&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;ul style="margin-top:5px;"&gt;'</span>, <span class="hljs-string">'    &lt;li style=""&gt;&lt;label&gt;Total Cargo:&lt;/label&gt;&lt;span id="tradePushCargo"&gt;0&lt;/span&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li style="margin-bottom:5px;"&gt;&lt;label&gt;To Colony:&lt;/label&gt;&lt;select id="tradePushColony"&gt;&lt;option value="" selected&gt;&amp;nbsp;&lt;/option&gt;&lt;/select&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li style="margin-bottom:5px;"&gt;&lt;label&gt;With Ship:&lt;/label&gt;&lt;select id="tradePushShip"&gt;&lt;/select&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li style="margin-bottom:5px;"&gt;&lt;label&gt;Stay at Colony:&lt;/label&gt;&lt;input type="checkbox" id="tradePushStay" /&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li id="tradePushMessage" class="alert"&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'&lt;/ul&gt;&lt;/div&gt;&lt;button id="tradePushSend"&gt;'</span>, <span class="hljs-keyword">this</span>.pushTradeText, <span class="hljs-string">'&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>)
            });
            <span class="hljs-keyword">this</span>.subscribe(<span class="hljs-string">"onLoadResources"</span>, <span class="hljs-keyword">this</span>.populatePushResourceName, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">this</span>.subscribe(<span class="hljs-string">"onLoadGlyphSummary"</span>, <span class="hljs-keyword">this</span>.populatePushGlyphSummaryName, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">this</span>.subscribe(<span class="hljs-string">"onLoadPlanSummary"</span>, <span class="hljs-keyword">this</span>.populatePushPlanSummaryName, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">this</span>.subscribe(<span class="hljs-string">"onLoadShipSummary"</span>, <span class="hljs-keyword">this</span>.populatePushShipSummaryName, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">this</span>.subscribe(<span class="hljs-string">"onLoadPrisoners"</span>, <span class="hljs-keyword">this</span>.populatePushPrisonerName, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.onAvailable(<span class="hljs-string">"tradePushColony"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">var</span> opt = document.createElement(<span class="hljs-string">"option"</span>),
                    planets = Lib.planetarySort(Game.EmpireData.planets),
                    cp = Game.GetCurrentPlanet(),
                    nOpt;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> p = <span class="hljs-number">0</span>; p &lt; planets.length; p++) {
                    <span class="hljs-keyword">if</span> (planets[p].id !== cp.id) {
                        nOpt = opt.cloneNode(<span class="hljs-literal">false</span>);
                        nOpt.value = planets[p].id;
                        nOpt.innerHTML = planets[p].name;
                        <span class="hljs-keyword">this</span>.appendChild(nOpt);
                    }
                }
            });
            Event.on(<span class="hljs-string">"tradePushColony"</span>, <span class="hljs-string">"change"</span>, <span class="hljs-keyword">this</span>.getPushShips, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.delegate(<span class="hljs-string">"tradePushResourceName"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.PushAddResource, <span class="hljs-string">"button"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.delegate(<span class="hljs-string">"tradePushGlyphSummaryName"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.PushAddGlyphSummary, <span class="hljs-string">"button"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.delegate(<span class="hljs-string">"tradePushPlanSummaryName"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.PushAddPlanSummary, <span class="hljs-string">"button"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.delegate(<span class="hljs-string">"tradePushShipSummaryName"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.PushAddShipSummary, <span class="hljs-string">"button"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.delegate(<span class="hljs-string">"tradePushPrisonerName"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.PushAddPrisoner, <span class="hljs-string">"button"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.delegate(<span class="hljs-string">"tradePushItems"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.PushRemove, <span class="hljs-string">"button"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.on(<span class="hljs-string">"tradePushSend"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.Push, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.push;
        },
        _getAvailableTradesTab: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.avail = <span class="hljs-keyword">new</span> YAHOO.widget.Tab({
                label: <span class="hljs-string">"Trades"</span>,
                content: [<span class="hljs-string">'&lt;div&gt;'</span>, <span class="hljs-string">'    &lt;div style="border-bottom: 1px solid #52ACFF; padding-bottom: 5px; margin-bottom: 5px;"&gt;&lt;label&gt;Filter:&lt;/label&gt;&lt;select id="tradeFilter"&gt;&lt;option value=""&gt;All&lt;/option&gt;&lt;option value="energy"&gt;Energy&lt;/option&gt;&lt;option value="food"&gt;Food&lt;/option&gt;&lt;option value="ore"&gt;Ore&lt;/option&gt;'</span>, <span class="hljs-string">'    &lt;option value="water"&gt;Water&lt;/option&gt;&lt;option value="waste"&gt;Waste&lt;/option&gt;&lt;option value="glyph"&gt;Glyph&lt;/option&gt;&lt;option value="prisoner"&gt;Prisoner&lt;/option&gt;'</span>, <span class="hljs-string">'    &lt;option value="ship"&gt;Ship&lt;/option&gt;&lt;option value="plan"&gt;Plan&lt;/option&gt;&lt;/select&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;ul class="tradeHeader tradeInfo clearafter"&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeEmpire"&gt;Empire&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeOfferedDate"&gt;Travel Time&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeAsking"&gt;Cost&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeOffer"&gt;Offering&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeAction"&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeAction"&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;/ul&gt;'</span>, <span class="hljs-string">'    &lt;div&gt;&lt;div id="tradeAvailableDetails"&gt;&lt;/div&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;div id="tradeAvailablePaginator"&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;/div&gt;'</span>].join(<span class="hljs-string">''</span>)
            });
            Event.on(<span class="hljs-string">"tradeFilter"</span>, <span class="hljs-string">"change"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                <span class="hljs-keyword">this</span>.getAvailableTrades({
                    newValue: <span class="hljs-literal">true</span>
                });
            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.avail;
        },
        _getMyTradesTab: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.mine = <span class="hljs-keyword">new</span> YAHOO.widget.Tab({
                label: <span class="hljs-string">"My Trades"</span>,
                content: [<span class="hljs-string">'&lt;div class="myTrades"&gt;'</span>, <span class="hljs-string">'    &lt;ul class="tradeHeader tradeInfo clearafter"&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeOfferedDate"&gt;Offered Date&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeAsking"&gt;Cost&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeOffer"&gt;Offering&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeAction"&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;/ul&gt;'</span>, <span class="hljs-string">'    &lt;div&gt;&lt;div id="tradeMineDetails"&gt;&lt;/div&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;div id="tradeMinePaginator"&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;/div&gt;'</span>].join(<span class="hljs-string">''</span>)
            });
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.mine;
        },
        _getAddTradeTab: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.add = <span class="hljs-keyword">new</span> YAHOO.widget.Tab({
                label: <span class="hljs-string">"Add Trade"</span>,
                content: [<span class="hljs-string">'&lt;div id="aHt"&gt;&lt;div class="tradeStash yui-g"&gt;'</span>, <span class="hljs-string">'    &lt;div class="yui-u first"&gt;'</span>, <span class="hljs-string">'        &lt;legend&gt;On Planet&lt;/legend&gt;'</span>, <span class="hljs-string">'        &lt;div class="tradeContainers"&gt;'</span>, <span class="hljs-string">'            &lt;div&gt;&lt;div id="tradeAddResources" class="accordian"&gt;Resources&lt;/div&gt;&lt;ul id="tradeAddResourceName"&gt;&lt;/ul&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'           &lt;div&gt;&lt;div id="tradeAddGlyphSummary" class="accordian"&gt;Glyph&lt;/div&gt;&lt;ul id="tradeAddGlyphSummaryName" style="display:none;"&gt;&lt;/ul&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'           &lt;div&gt;&lt;div id="tradeAddPlanSummary" class="accordian"&gt;Plan&lt;/div&gt;&lt;ul id="tradeAddPlanSummaryName" style="display:none;"&gt;&lt;/ul&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'           &lt;div&gt;&lt;div id="tradeAddShipSummary" class="accordian"&gt;Ship&lt;/div&gt;&lt;ul id="tradeAddShipSummaryName" style="display:none;"&gt;&lt;/ul&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'            &lt;div&gt;&lt;div id="tradeAddPrisoners" class="accordian"&gt;Prisoners&lt;/div&gt;&lt;ul id="tradeAddPrisonerName" style="display:none;"&gt;&lt;/ul&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'        &lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;div class="yui-u"&gt;'</span>, <span class="hljs-string">'        &lt;legend&gt;To Offer&lt;/legend&gt;'</span>, <span class="hljs-string">'        &lt;div class="tradeContainers"&gt;&lt;ul id="tradeAddItems"&gt;&lt;/ul&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;/div&gt;'</span>, <span class="hljs-string">'&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;ul style="margin-top:5px;"&gt;'</span>, <span class="hljs-string">'    &lt;li style=""&gt;&lt;label&gt;Total Cargo:&lt;/label&gt;&lt;span id="tradeAddCargo"&gt;0&lt;/span&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li style="margin: 5px 0;"&gt;&lt;label style="font-weight:bold"&gt;Asking Essentia:&lt;/label&gt;&lt;input type="text" id="tradeAddAskingQuantity" /&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li style="margin-bottom:5px;"&gt;&lt;label&gt;With Ship:&lt;/label&gt;&lt;select id="tradeAddShip"&gt;&lt;/select&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li id="tradeAddMessage" class="alert"&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'&lt;/ul&gt;&lt;/div&gt;&lt;button id="tradeAdd"&gt;'</span>, <span class="hljs-keyword">this</span>.addTradeText, <span class="hljs-string">'&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>)
            });
            <span class="hljs-keyword">this</span>.subscribe(<span class="hljs-string">"onLoadResources"</span>, <span class="hljs-keyword">this</span>.populateAddResourceName, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">this</span>.subscribe(<span class="hljs-string">"onLoadGlyphSummary"</span>, <span class="hljs-keyword">this</span>.populateAddGlyphSummaryName, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">this</span>.subscribe(<span class="hljs-string">"onLoadPlanSummary"</span>, <span class="hljs-keyword">this</span>.populateAddPlanSummaryName, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">this</span>.subscribe(<span class="hljs-string">"onLoadShipSummary"</span>, <span class="hljs-keyword">this</span>.populateAddShipSummaryName, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">this</span>.subscribe(<span class="hljs-string">"onLoadPrisoners"</span>, <span class="hljs-keyword">this</span>.populateAddPrisonerName, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.delegate(<span class="hljs-string">"tradeAddResourceName"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.AddResource, <span class="hljs-string">"button"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.delegate(<span class="hljs-string">"tradeAddGlyphSummaryName"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.AddGlyphSummary, <span class="hljs-string">"button"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.delegate(<span class="hljs-string">"tradeAddPlanSummaryName"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.AddPlanSummary, <span class="hljs-string">"button"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.delegate(<span class="hljs-string">"tradeAddShipSummaryName"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.AddShipSummary, <span class="hljs-string">"button"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.delegate(<span class="hljs-string">"tradeAddPrisonerName"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.AddPrisoner, <span class="hljs-string">"button"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.delegate(<span class="hljs-string">"tradeAddItems"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.AddRemove, <span class="hljs-string">"button"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.on(<span class="hljs-string">"tradeAdd"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.AddTrade, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.add;
        },
        _getSupplyChainTab: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> planets = Lib.planetarySort(Game.EmpireData.planets),
                current_planet = Game.GetCurrentPlanet(),
                target_options = <span class="hljs-string">""</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> p = <span class="hljs-number">0</span>; p &lt; planets.length; p++) {
                <span class="hljs-keyword">if</span> (planets[p].id !== current_planet.id) {
                    target_options += [<span class="hljs-string">'&lt;option value="'</span>, planets[p].id, <span class="hljs-string">'"&gt;'</span>, planets[p].name, <span class="hljs-string">'&lt;/option&gt;'</span>].join(<span class="hljs-string">''</span>);
                }
            }
            <span class="hljs-keyword">this</span>.supplyChainTab = <span class="hljs-keyword">new</span> YAHOO.widget.Tab({
                label: <span class="hljs-string">"Supply Chains"</span>,
                content: [<span class="hljs-string">'&lt;div id="supplyChainInfo" style="margin-bottom: 2px"&gt;'</span>, <span class="hljs-string">'    &lt;div id="supplyChainMaxCount"&gt;&lt;/div&gt;&lt;hr/&gt;'</span>, <span class="hljs-string">'    &lt;div id="supplyChainAddNew"&gt;'</span>, <span class="hljs-string">'     &lt;b&gt;Add New Supply Chain&lt;/b&gt;&lt;br/&gt;'</span>, <span class="hljs-string">'     Target: &lt;select id="supplyChainAddTargetId"&gt;'</span>,
                    target_options, <span class="hljs-string">'     &lt;/select&gt;'</span>, <span class="hljs-string">'     Resource: &lt;select id="supplyChainAddResourceType"&gt;'</span>,
                    <span class="hljs-keyword">this</span>.resourceOptionsHTML(), <span class="hljs-string">'     &lt;/select&gt;'</span>, <span class="hljs-string">'     Resources/hr: &lt;input id="supplyChainAddResourceHour" type="text"/&gt;'</span>, <span class="hljs-string">'     &lt;button id="supplyChainAddButton"&gt;Add&lt;/button&gt;'</span>, <span class="hljs-string">'   &lt;/div&gt;'</span>, <span class="hljs-string">'   &lt;div id="supplyChainMetric"&gt;&lt;/div&gt;&lt;hr/&gt;'</span>, <span class="hljs-string">'   &lt;div id="supplyChainList"&gt;'</span>, <span class="hljs-string">'      &lt;ul id="supplyChainListHeader" class="supplyChainHeader supplyChainInfo clearafter"&gt;'</span>, <span class="hljs-string">'        &lt;li class="supplyChainBody"&gt;Target&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="supplyChainResource"&gt;Resource&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="supplyChainHour"&gt;/hr&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="supplyChainAction"&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'      &lt;/ul&gt;'</span>, <span class="hljs-string">'      &lt;div&gt;&lt;div id="supplyChainListDetails"&gt;&lt;/div&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'   &lt;/div&gt;'</span>, <span class="hljs-string">'   &lt;div id="supplyChainListNone"&gt;&lt;b&gt;No Supply Chains In Use&lt;/b&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;/div&gt;'</span>,
                ].join(<span class="hljs-string">''</span>)
            });
            Event.on(<span class="hljs-string">"supplyChainAddButton"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.SupplyChainAddNew, {
                Self: <span class="hljs-keyword">this</span>
            }, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">this</span>.supplyChainTab.subscribe(<span class="hljs-string">"activeChange"</span>, <span class="hljs-keyword">this</span>.viewSupplyChainInfo, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.supplyChainTab;
        },
        _getSupplyShipsTab: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.supplyShipsTab = <span class="hljs-keyword">new</span> YAHOO.widget.Tab({
                label: <span class="hljs-string">"Supply Ships"</span>,
                content: [<span class="hljs-string">'&lt;div id="supplyChainShipsInfo"&gt;&lt;/div&gt;&lt;hr/&gt;'</span>, <span class="hljs-string">'&lt;div id="supplyChainShipsHeader"&gt;'</span>, <span class="hljs-string">'  &lt;ul class="shipHeader shipInfo clearafter"&gt;'</span>, <span class="hljs-string">'    &lt;li class="shipName"&gt;Name&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li class="shipTask"&gt;Task&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li class="shipSpeed"&gt;Speed&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li class="shipHold"&gt;Hold&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li class="shipAction"&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'  &lt;/ul&gt;'</span>, <span class="hljs-string">'  &lt;div&gt;&lt;div id="supplyChainShipsDetails"&gt;&lt;/div&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;div id="supplyChainShipsNone"&gt;There are no supply ships available.&lt;/div&gt;'</span>].join(<span class="hljs-string">''</span>)
            });
            <span class="hljs-keyword">this</span>.supplyShipsTab.subscribe(<span class="hljs-string">"activeChange"</span>, <span class="hljs-keyword">this</span>.viewSupplyShips, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.supplyShipsTab;
        },
        _getWasteChainTab: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.wasteChainTab = <span class="hljs-keyword">new</span> YAHOO.widget.Tab({
                label: <span class="hljs-string">"Waste Chain"</span>,
                content: [<span class="hljs-string">'&lt;div id="wasteChainDetails" style="margin-bottom: 2px"&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;div id="wasteChainShips"&gt;'</span>, <span class="hljs-string">'    &lt;ul class="shipHeader shipInfo clearafter"&gt;'</span>, <span class="hljs-string">'        &lt;li class="shipName"&gt;Name&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="shipTask"&gt;Task&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="shipSpeed"&gt;Speed&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="shipHold"&gt;Hold&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="shipAction"&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;/ul&gt;'</span>, <span class="hljs-string">'    &lt;div&gt;&lt;div id="wasteChainShipsDetails"&gt;&lt;/div&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;div id="wasteChainShipsNone"&gt;There are no scows available.&lt;/div&gt;'</span>].join(<span class="hljs-string">''</span>)
            });
            <span class="hljs-keyword">this</span>.wasteChainTab.subscribe(<span class="hljs-string">"activeChange"</span>, <span class="hljs-keyword">this</span>.viewWasteChainInfo, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.wasteChainTab;
        },
        getGlyphSummary: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(force)</span> {</span>
            <span class="hljs-keyword">if</span> (force || !<span class="hljs-keyword">this</span>.glyph_summary) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.service.get_glyph_summary({
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    building_id: <span class="hljs-keyword">this</span>.building.id
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">this</span>.glyph_summary = o.result.glyphs;
                        <span class="hljs-keyword">this</span>.glyphSize = o.result.cargo_space_used_each;
                        <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onLoadGlyphSummary"</span>);
                        Lacuna.Pulser.Hide();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        getPlanSummary: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(force)</span> {</span>
            <span class="hljs-keyword">if</span> (force || !<span class="hljs-keyword">this</span>.plan_summary) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.service.get_plan_summary({
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    building_id: <span class="hljs-keyword">this</span>.building.id
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">this</span>.plan_summary = o.result.plans;
                        <span class="hljs-keyword">this</span>.planSize = o.result.cargo_space_used_each;
                        <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onLoadPlanSummary"</span>);
                        Lacuna.Pulser.Hide();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        getPrisoners: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(force)</span> {</span>
            <span class="hljs-keyword">if</span> (force || !<span class="hljs-keyword">this</span>.prisoners) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.service.get_prisoners({
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    building_id: <span class="hljs-keyword">this</span>.building.id
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">this</span>.prisoners = o.result.prisoners;
                        <span class="hljs-keyword">this</span>.spySize = o.result.cargo_space_used_each;
                        <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onLoadPrisoners"</span>);
                        Lacuna.Pulser.Hide();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        getShipSummary: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(force)</span> {</span>
            <span class="hljs-keyword">if</span> (force || !<span class="hljs-keyword">this</span>.ship_summary) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.service.get_ship_summary({
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    building_id: <span class="hljs-keyword">this</span>.building.id
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">this</span>.ship_summary = o.result.ships;
                        <span class="hljs-keyword">this</span>.shipSize = o.result.cargo_space_used_each;
                        <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onLoadShipSummary"</span>);
                        Lacuna.Pulser.Hide();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        getStoredResources: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(force)</span> {</span>
            <span class="hljs-keyword">if</span> (force || !<span class="hljs-keyword">this</span>.resources) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.service.get_stored_resources({
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    building_id: <span class="hljs-keyword">this</span>.building.id
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">this</span>.resources = o.result.resources;
                        <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onLoadResources"</span>);
                        Lacuna.Pulser.Hide();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        <span class="hljs-comment">//View Available</span>
        getAvailableTrades: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (e.newValue) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">var</span> data = {
                    session_id: Game.GetSession(),
                    building_id: <span class="hljs-keyword">this</span>.building.id,
                    page_number: <span class="hljs-number">1</span>
                },
                    selVal = Lib.getSelectedOptionValue(<span class="hljs-string">"tradeFilter"</span>);
                <span class="hljs-keyword">if</span> (selVal) {
                    data.filter = selVal;
                }
                <span class="hljs-keyword">this</span>.service.view_market(data, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.view_available_trades.success"</span>);
                        Lacuna.Pulser.Hide();
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">delete</span> o.result.status; <span class="hljs-comment">//get rid of status after we process it, since it's big</span>
                        <span class="hljs-keyword">this</span>.availableTrades = o.result; <span class="hljs-comment">//store: trades=[], trade_count = 1, page_number=1,  captcha = {guid, url}</span>
                        <span class="hljs-keyword">this</span>.availablePager = <span class="hljs-keyword">new</span> Pager({
                            rowsPerPage: <span class="hljs-number">25</span>,
                            totalRecords: o.result.trade_count,
                            containers: <span class="hljs-string">'tradeAvailablePaginator'</span>,
                            template: <span class="hljs-string">"{PreviousPageLink} {PageLinks} {NextPageLink}"</span>,
                            alwaysVisible: <span class="hljs-literal">false</span>
                        });
                        <span class="hljs-keyword">this</span>.availablePager.subscribe(<span class="hljs-string">'changeRequest'</span>, <span class="hljs-keyword">this</span>.AvailableHandlePagination, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.availablePager.render();
                        <span class="hljs-keyword">this</span>.AvailablePopulate();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        AvailablePopulate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> details = Dom.get(<span class="hljs-string">"tradeAvailableDetails"</span>);
            <span class="hljs-keyword">if</span> (details) {
                <span class="hljs-keyword">var</span> trades = <span class="hljs-keyword">this</span>.availableTrades.trades,
                    ul = document.createElement(<span class="hljs-string">"ul"</span>),
                    li = document.createElement(<span class="hljs-string">"li"</span>);
                Event.purgeElement(details);
                details.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; trades.length; i++) {
                    <span class="hljs-keyword">var</span> trade = trades[i],
                        bbtn, nUl = ul.cloneNode(<span class="hljs-literal">false</span>),
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    nUl.Trade = trade;
                    Dom.addClass(nUl, <span class="hljs-string">"tradeInfo"</span>);
                    Dom.addClass(nUl, <span class="hljs-string">"clearafter"</span>);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeEmpire"</span>);
                    nLi.innerHTML = trade.empire.name;
                    Event.on(nLi, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.EmpireProfile, trade.empire);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeOfferedDate"</span>);
                    nLi.innerHTML = Lib.formatTime(<span class="hljs-built_in">Math</span>.round(trade.delivery.duration));
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeAsking"</span>);
                    nLi.innerHTML = [trade.ask, <span class="hljs-string">'&lt;img src="'</span>, Lib.AssetUrl, <span class="hljs-string">'ui/s/essentia.png" class="smallEssentia" /&gt;'</span>].join(<span class="hljs-string">''</span>);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeOffer"</span>);
                    nLi.innerHTML = Lib.formatInlineList(trade.offer);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeAction"</span>);
                    bbtn = document.createElement(<span class="hljs-string">"button"</span>);
                    bbtn.setAttribute(<span class="hljs-string">"type"</span>, <span class="hljs-string">"button"</span>);
                    bbtn.innerHTML = <span class="hljs-keyword">this</span>.availableAcceptText;
                    bbtn = nLi.appendChild(bbtn);
                    Event.on(bbtn, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.AvailableAccept, {
                        Self: <span class="hljs-keyword">this</span>,
                        Trade: trade,
                        Line: nUl
                    }, <span class="hljs-literal">true</span>);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeAction"</span>);
                    bbtn = document.createElement(<span class="hljs-string">"button"</span>);
                    bbtn.setAttribute(<span class="hljs-string">"type"</span>, <span class="hljs-string">"button"</span>);
                    Dom.addClass(bbtn, <span class="hljs-string">"reportAbuse"</span>);
                    bbtn.innerHTML = <span class="hljs-string">"Spam"</span>;
                    bbtn = nLi.appendChild(bbtn);
                    Event.on(bbtn, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.AvailableReport, {
                        Self: <span class="hljs-keyword">this</span>,
                        Trade: trade,
                        Line: nUl
                    }, <span class="hljs-literal">true</span>);
                    nUl.appendChild(nLi);
                    details.appendChild(nUl);
                }
                <span class="hljs-comment">//wait for tab to display first</span>
                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">var</span> Ht = Game.GetSize()
                        .h - <span class="hljs-number">240</span>;
                    <span class="hljs-keyword">if</span> (Ht &gt; <span class="hljs-number">300</span>) {
                        Ht = <span class="hljs-number">300</span>;
                    }
                    <span class="hljs-keyword">var</span> tC = details.parentNode;
                    Dom.setStyle(tC, <span class="hljs-string">"height"</span>, Ht + <span class="hljs-string">"px"</span>);
                    Dom.setStyle(tC, <span class="hljs-string">"overflow-y"</span>, <span class="hljs-string">"auto"</span>);
                }, <span class="hljs-number">10</span>);
            }
        },
        AvailableHandlePagination: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newState)</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">var</span> data = {
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.building.id,
                page_number: newState.page
            },
                selVal = Lib.getSelectedOptionValue(<span class="hljs-string">"tradeFilter"</span>);
            <span class="hljs-keyword">if</span> (selVal) {
                data.filter = selVal;
            }
            <span class="hljs-keyword">this</span>.service.view_market(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.view_available_trades.success"</span>);
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.rpcSuccess(o);
                    <span class="hljs-keyword">delete</span> o.result.status; <span class="hljs-comment">//get rid of status after we process it, since it's big</span>
                    <span class="hljs-keyword">this</span>.availableTrades = o.result; <span class="hljs-comment">//store: trades=[], trade_count = 1, page_number=1,  captcha = {guid, url}</span>
                    <span class="hljs-keyword">this</span>.AvailablePopulate();
                },
                scope: <span class="hljs-keyword">this</span>
            });</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Update the Paginator&#39;s state</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">this</span>.availablePager.setState(newState);
        },
        AvailableAccept: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.Self.service.accept_from_market({
                session_id: Game.GetSession(<span class="hljs-string">""</span>),
                building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                trade_id: <span class="hljs-keyword">this</span>.Trade.id
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.accept_trade.success"</span>);
                    <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                    <span class="hljs-comment">//force get the new availabe list after accepting so we get a new captcha</span>
                    <span class="hljs-keyword">this</span>.Self.getAvailableTrades({
                        newValue: <span class="hljs-literal">true</span>
                    });
                    Lacuna.Pulser.Hide();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        AvailableReport: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.Self.service.report_abuse({
                session_id: Game.GetSession(<span class="hljs-string">""</span>),
                building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                trade_id: <span class="hljs-keyword">this</span>.Trade.id
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">var</span> btn = Sel.query(<span class="hljs-string">".reportAbuse"</span>, <span class="hljs-keyword">this</span>.Line, <span class="hljs-literal">true</span>);
                    <span class="hljs-keyword">if</span> (btn) {
                        Event.purgeElement(btn);
                        btn.parentNode.removeChild(btn);
                    }
                    <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                    Lacuna.Pulser.Hide();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        EmpireProfile: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, empire)</span> {</span>
            Lacuna.Info.Empire.Load(empire.id);
        },
        <span class="hljs-comment">//View Mine</span>
        getMyTrades: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (e.newValue) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.service.view_my_market({
                    session_id: Game.GetSession(),
                    building_id: <span class="hljs-keyword">this</span>.building.id,
                    page_number: <span class="hljs-number">1</span>
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.view_my_trades.success"</span>);
                        Lacuna.Pulser.Hide();
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">delete</span> o.result.status; <span class="hljs-comment">//get rid of status after we process it, since it's big</span>
                        <span class="hljs-keyword">this</span>.mineTrades = o.result; <span class="hljs-comment">//store: trades=[], trade_count = 1, page_number=1</span>
                        <span class="hljs-keyword">this</span>.minePage = <span class="hljs-keyword">new</span> Pager({
                            rowsPerPage: <span class="hljs-number">25</span>,
                            totalRecords: o.result.trade_count,
                            containers: <span class="hljs-string">'tradeMinePaginator'</span>,
                            template: <span class="hljs-string">"{PreviousPageLink} {PageLinks} {NextPageLink}"</span>,
                            alwaysVisible: <span class="hljs-literal">false</span>
                        });
                        <span class="hljs-keyword">this</span>.minePage.subscribe(<span class="hljs-string">'changeRequest'</span>, <span class="hljs-keyword">this</span>.MineHandlePagination, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.minePage.render();
                        <span class="hljs-keyword">this</span>.MinePopulate();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        MinePopulate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> details = Dom.get(<span class="hljs-string">"tradeMineDetails"</span>);
            <span class="hljs-keyword">if</span> (details) {
                <span class="hljs-keyword">var</span> trades = <span class="hljs-keyword">this</span>.mineTrades.trades,
                    ul = document.createElement(<span class="hljs-string">"ul"</span>),
                    li = document.createElement(<span class="hljs-string">"li"</span>);
                Event.purgeElement(details);
                details.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; trades.length; i++) {
                    <span class="hljs-keyword">var</span> trade = trades[i],
                        nUl = ul.cloneNode(<span class="hljs-literal">false</span>),
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    nUl.Trade = trade;
                    Dom.addClass(nUl, <span class="hljs-string">"tradeInfo"</span>);
                    Dom.addClass(nUl, <span class="hljs-string">"clearafter"</span>);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeOfferedDate"</span>);
                    nLi.innerHTML = Lib.formatServerDateTimeShort(trade.date_offered);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeAsking"</span>);
                    nLi.innerHTML = [trade.ask, <span class="hljs-string">'&lt;img src="'</span>, Lib.AssetUrl, <span class="hljs-string">'ui/s/essentia.png" class="smallEssentia" /&gt;'</span>].join(<span class="hljs-string">''</span>);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeOffer"</span>);
                    nLi.innerHTML = Lib.formatInlineList(trade.offer);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeAction"</span>);
                    <span class="hljs-keyword">var</span> bbtn = document.createElement(<span class="hljs-string">"button"</span>);
                    bbtn.setAttribute(<span class="hljs-string">"type"</span>, <span class="hljs-string">"button"</span>);
                    bbtn.innerHTML = <span class="hljs-string">"Withdraw"</span>;
                    bbtn = nLi.appendChild(bbtn);
                    Event.on(bbtn, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.MineWithdraw, {
                        Self: <span class="hljs-keyword">this</span>,
                        Trade: trade,
                        Line: nUl
                    }, <span class="hljs-literal">true</span>);
                    nUl.appendChild(nLi);
                    details.appendChild(nUl);
                }
                <span class="hljs-comment">//wait for tab to display first</span>
                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">var</span> Ht = Game.GetSize()
                        .h - <span class="hljs-number">185</span>;
                    <span class="hljs-keyword">if</span> (Ht &gt; <span class="hljs-number">300</span>) {
                        Ht = <span class="hljs-number">300</span>;
                    }
                    <span class="hljs-keyword">var</span> tC = details.parentNode;
                    Dom.setStyle(tC, <span class="hljs-string">"height"</span>, Ht + <span class="hljs-string">"px"</span>);
                    Dom.setStyle(tC, <span class="hljs-string">"overflow-y"</span>, <span class="hljs-string">"auto"</span>);
                }, <span class="hljs-number">10</span>);
            }
        },
        MineHandlePagination: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newState)</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.service.view_my_market({
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.building.id,
                page_number: newState.page
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.view_available_trades.success"</span>);
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.rpcSuccess(o);
                    <span class="hljs-keyword">delete</span> o.result.status; <span class="hljs-comment">//get rid of status after we process it, since it's big</span>
                    <span class="hljs-keyword">this</span>.mineTrades = o.result; <span class="hljs-comment">//store: trades=[], trade_count = 1, page_number=1</span>
                    <span class="hljs-keyword">this</span>.MinePopulate();
                },
                scope: <span class="hljs-keyword">this</span>
            });</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Update the Paginator&#39;s state</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">this</span>.minePage.setState(newState);
        },
        MineWithdraw: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (confirm([<span class="hljs-string">'Are you sure you want to withdraw the trade asking for '</span>, <span class="hljs-keyword">this</span>.Trade.ask, <span class="hljs-string">' essentia and offering '</span>, <span class="hljs-keyword">this</span>.Trade.offer.join(<span class="hljs-string">', '</span>), <span class="hljs-string">'?'</span>].join(<span class="hljs-string">''</span>))) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.Self.service.withdraw_from_market({
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                    trade_id: <span class="hljs-keyword">this</span>.Trade.id
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.withdraw_trade.success"</span>);
                        <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                        <span class="hljs-keyword">var</span> trades = <span class="hljs-keyword">this</span>.Self.mineTrades.trades;
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; trades.length; i++) {
                            <span class="hljs-keyword">if</span> (trades[i].id === <span class="hljs-keyword">this</span>.Trade.id) {
                                trades.splice(i, <span class="hljs-number">1</span>);
                                <span class="hljs-keyword">break</span>;
                            }
                        }
                        <span class="hljs-keyword">this</span>.Line.parentNode.removeChild(<span class="hljs-keyword">this</span>.Line);
                        Lacuna.Pulser.Hide();
                        <span class="hljs-keyword">this</span>.Self.getStoredResources(<span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.Self.getPlanSummary(<span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.Self.getGlyphSummary(<span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.Self.getPrisoners(<span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.Self.getShipSummary(<span class="hljs-literal">true</span>);
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        <span class="hljs-comment">//Add trade</span>
        populateAddResourceName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradeAddResourceName"</span>),
                li = document.createElement(<span class="hljs-string">"li"</span>),
                nLi, x, r, name, resource;
            <span class="hljs-keyword">if</span> (elm) {
                elm.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">for</span> (r <span class="hljs-keyword">in</span> Lib.ResourceTypes) {
                    <span class="hljs-keyword">if</span> (Lib.ResourceTypes.hasOwnProperty(r)) {
                        resource = Lib.ResourceTypes[r];
                        <span class="hljs-keyword">if</span> (Lang.isArray(resource)) {
                            <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; resource.length; x++) {
                                name = resource[x];
                                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.resources[name]) {
                                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                                    nLi.Resource = {
                                        type: name,
                                        quantity: <span class="hljs-keyword">this</span>.resources[name] * <span class="hljs-number">1</span>
                                    };
                                    nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, name.titleCaps(), <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, <span class="hljs-keyword">this</span>.resources[name], <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" /&gt;&lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                                    elm.appendChild(nLi);
                                }
                            }
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.resources[r] &amp;&amp; resource) {
                            nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                            nLi.Resource = {
                                type: r,
                                quantity: <span class="hljs-keyword">this</span>.resources[r] * <span class="hljs-number">1</span>
                            };
                            nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, r.titleCaps(), <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, <span class="hljs-keyword">this</span>.resources[r], <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" /&gt;&lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                            elm.appendChild(nLi);
                        }
                    }
                }
            }
            <span class="hljs-comment">//wait for tab to display first</span>
            setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">var</span> Ht = Game.GetSize()
                    .h - <span class="hljs-number">180</span>;
                <span class="hljs-keyword">if</span> (Ht &gt; <span class="hljs-number">300</span>) {
                    Ht = <span class="hljs-number">300</span>;
                }
                <span class="hljs-keyword">var</span> aHt = Dom.get(<span class="hljs-string">'aHt'</span>);
                Dom.setStyle(aHt, <span class="hljs-string">"height"</span>, Ht + <span class="hljs-string">"px"</span>);
                Dom.setStyle(aHt, <span class="hljs-string">"overflow-y"</span>, <span class="hljs-string">"auto"</span>);
            }, <span class="hljs-number">10</span>);
        },
        populateAddGlyphSummaryName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradeAddGlyphSummaryName"</span>),
                li = document.createElement(<span class="hljs-string">"li"</span>),
                nLi;
            <span class="hljs-keyword">if</span> (elm) {
                elm.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.glyph_summary.length &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-keyword">this</span>.glyph_summary.length; x++) {
                        <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.glyph_summary[x];
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                        nLi.GlyphSummary = obj;
                        nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, obj.name.titleCaps(), <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, obj.quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" /&gt;&lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                        elm.appendChild(nLi);
                    }
                } <span class="hljs-keyword">else</span> {
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    nLi.innerHTML = <span class="hljs-string">"No Glyphs Available"</span>;
                    elm.appendChild(nLi);
                }
            }
        },
        populateAddPlanSummaryName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradeAddPlanSummaryName"</span>),
                li = document.createElement(<span class="hljs-string">"li"</span>),
                nLi;
            <span class="hljs-keyword">if</span> (elm) {
                elm.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.plan_summary.length &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-keyword">this</span>.plan_summary.length; x++) {
                        <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.plan_summary[x];
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                        nLi.PlanSummary = obj;
                        <span class="hljs-keyword">if</span> (obj.extra_build_level &gt; <span class="hljs-number">0</span>) {
                            nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, obj.name, <span class="hljs-string">' '</span>, obj.level, <span class="hljs-string">'+'</span>, obj.extra_build_level, <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, obj.quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" /&gt;&lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                        } <span class="hljs-keyword">else</span> {
                            nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, obj.name, <span class="hljs-string">' '</span>, obj.level, <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, obj.quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" /&gt;&lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                        }
                        elm.appendChild(nLi);
                    }
                } <span class="hljs-keyword">else</span> {
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    nLi.innerHTML = <span class="hljs-string">"No Plans Available"</span>;
                    elm.appendChild(nLi);
                }
            }
        },
        populateAddShipSummaryName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradeAddShipSummaryName"</span>),
                li = document.createElement(<span class="hljs-string">"li"</span>),
                nLi;
            <span class="hljs-keyword">if</span> (elm) {
                elm.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.ship_summary.length &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-keyword">this</span>.ship_summary.length; x++) {
                        <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.ship_summary[x];
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                        nLi.ShipSummary = obj;
                        nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, obj.name, <span class="hljs-string">' - '</span>, obj.type.titleCaps(<span class="hljs-string">'_'</span>, <span class="hljs-string">' '</span>), <span class="hljs-string">' - Hold:'</span>, obj.hold_size, <span class="hljs-string">' - Berth:'</span>, obj.berth_level, <span class="hljs-string">' - Speed:'</span>, obj.speed, <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, obj.quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" /&gt;&lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                        elm.appendChild(nLi);
                    }
                } <span class="hljs-keyword">else</span> {
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    nLi.innerHTML = <span class="hljs-string">"No Ships Available"</span>;
                    elm.appendChild(nLi);
                }
            }
        },
        populateAddPrisonerName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradeAddPrisonerName"</span>),
                li = document.createElement(<span class="hljs-string">"li"</span>),
                nLi;
            <span class="hljs-keyword">if</span> (elm) {
                elm.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.prisoners.length &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-keyword">this</span>.prisoners.length; x++) {
                        <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.prisoners[x];
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                        nLi.Prisoner = obj;
                        nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeName"&gt;'</span>, obj.name, <span class="hljs-string">' '</span>, obj.level, <span class="hljs-string">'&lt;/span&gt; &lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                        elm.appendChild(nLi);
                    }
                } <span class="hljs-keyword">else</span> {
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    nLi.innerHTML = <span class="hljs-string">"No Prisoners Available"</span>;
                    elm.appendChild(nLi);
                }
            }
        },
        getAddShips: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.service.get_trade_ships({
                session_id: Game.GetSession(<span class="hljs-string">""</span>),
                building_id: <span class="hljs-keyword">this</span>.building.id
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">this</span>.rpcSuccess(o);
                    <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradeAddShip"</span>),
                        opt = document.createElement(<span class="hljs-string">"option"</span>),
                        ships = o.result.ships,
                        nOpt;
                    <span class="hljs-keyword">if</span> (elm &amp;&amp; ships) {
                        <span class="hljs-keyword">var</span> selectedVal = Lib.getSelectedOptionValue(elm);
                        elm.options.length = <span class="hljs-number">0</span>;
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; ships.length; x++) {
                            <span class="hljs-keyword">var</span> obj = ships[x];
                            nOpt = opt.cloneNode(<span class="hljs-literal">false</span>);
                            nOpt.value = obj.id;
                            nOpt.innerHTML = [obj.name, <span class="hljs-string">' ('</span>, obj.type_human, <span class="hljs-string">' - Hold:'</span>, obj.hold_size, <span class="hljs-string">' - Berth:'</span>, obj.berth_level, <span class="hljs-string">' - Speed:'</span>, obj.speed, <span class="hljs-string">')'</span>].join(<span class="hljs-string">''</span>);
                            nOpt.selected = selectedVal === obj.id;
                            elm.appendChild(nOpt);
                        }
                    }
                    Lacuna.Pulser.Hide();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        updateAddCargo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(byVal)</span> {</span>
            <span class="hljs-keyword">var</span> c = Dom.get(<span class="hljs-string">"tradeAddCargo"</span>),
                cv = c.innerHTML * <span class="hljs-number">1</span>;
            c.innerHTML = cv + byVal;
        },
        AddResource: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> quantity = matchedEl.previousSibling.value * <span class="hljs-number">1</span>,
                li = matchedEl.parentNode,
                c = Dom.get(<span class="hljs-string">"tradeAddItems"</span>);
            <span class="hljs-keyword">if</span> (quantity &amp;&amp; c) {
                <span class="hljs-keyword">var</span> id = <span class="hljs-string">"addResource-"</span> + li.Resource.type,
                    exists = Sel.query(<span class="hljs-string">"#"</span> + id, c);
                <span class="hljs-keyword">if</span> (exists.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">var</span> item = document.createElement(<span class="hljs-string">"li"</span>),
                        del = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>)),
                        content = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>));
                    item.id = id;
                    <span class="hljs-keyword">if</span> (quantity &gt; li.Resource.quantity) {
                        quantity = li.Resource.quantity;
                    }
                    Dom.addClass(item, <span class="hljs-string">"tradeItem"</span>);
                    Dom.addClass(del, <span class="hljs-string">"tradeDelete"</span>);
                    Event.on(del, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                        <span class="hljs-keyword">var</span> ed = Event.getTarget(e),
                            ep = ed.parentNode;
                        <span class="hljs-keyword">this</span>.updateAddCargo(ep.Object.quantity * -<span class="hljs-number">1</span>);
                        Event.purgeElement(ep);
                        ep.parentNode.removeChild(ep);
                    }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                    item.Object = {
                        type: li.Resource.type,
                        quantity: quantity,
                        size: <span class="hljs-number">1</span>
                    };
                    content.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, item.Object.type.titleCaps(), <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" value="'</span>, quantity, <span class="hljs-string">'" /&gt;&lt;button type="button"&gt;-&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                    c.appendChild(item);
                    <span class="hljs-keyword">this</span>.updateAddCargo(quantity);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> found = exists[<span class="hljs-number">0</span>],
                        newTotal = found.Object.quantity + quantity,
                        diff = quantity,
                        lq = Sel.query(<span class="hljs-string">".quantity"</span>, found, <span class="hljs-literal">true</span>),
                        inp = Sel.query(<span class="hljs-string">"input"</span>, found, <span class="hljs-literal">true</span>);
                    <span class="hljs-keyword">if</span> (newTotal &gt; li.Resource.quantity) {
                        newTotal = li.Resource.quantity;
                        diff = newTotal - found.Object.quantity;
                    }
                    <span class="hljs-keyword">if</span> (inp) {
                        inp.value = diff;
                    }
                    lq.innerHTML = newTotal;
                    found.Object.quantity = newTotal;
                    <span class="hljs-keyword">this</span>.updateAddCargo(diff);
                    <span class="hljs-keyword">var</span> a = <span class="hljs-keyword">new</span> Util.ColorAnim(lq, {
                        color: {
                            from: <span class="hljs-string">'#0f0'</span>,
                            to: <span class="hljs-string">'#fff'</span>
                        }
                    }, <span class="hljs-number">1.5</span>);
                    a.animate();
                }
            }
        },
        AddGlyphSummary: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> quantity = matchedEl.previousSibling.value * <span class="hljs-number">1</span>,
                li = matchedEl.parentNode,
                c = Dom.get(<span class="hljs-string">"tradeAddItems"</span>);
            <span class="hljs-keyword">if</span> (li &amp;&amp; c) {
                <span class="hljs-keyword">var</span> gName = li.GlyphSummary.name,
                    id = <span class="hljs-string">"addGlyphSummary-"</span> + gName,
                    exists = Sel.query(<span class="hljs-string">"#"</span> + id, c);
                <span class="hljs-keyword">if</span> (exists.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">var</span> item = document.createElement(<span class="hljs-string">"li"</span>),
                        del = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>)),
                        content = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>));
                    item.id = id;
                    Dom.addClass(item, <span class="hljs-string">"tradeItem"</span>);
                    Dom.addClass(del, <span class="hljs-string">"tradeDelete"</span>);
                    Event.on(del, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                        <span class="hljs-keyword">var</span> ed = Event.getTarget(e),
                            ep = ed.parentNode;
                        <span class="hljs-keyword">this</span>.updateAddCargo(ep.Object.quantity * -<span class="hljs-keyword">this</span>.glyphSize);
                        Event.purgeElement(item);
                        item.parentNode.removeChild(item);
                    }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                    item.Object = {
                        name: gName,
                        quantity: quantity,
                        type: <span class="hljs-string">"glyph"</span>,
                        size: <span class="hljs-keyword">this</span>.glyphSize
                    };
                    content.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, gName.titleCaps(), <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" value="'</span>, quantity, <span class="hljs-string">'" /&gt;&lt;button type="button"&gt;-&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                    c.appendChild(item);
                    <span class="hljs-keyword">this</span>.updateAddCargo(<span class="hljs-keyword">this</span>.glyphSize * quantity);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> found = exists[<span class="hljs-number">0</span>],
                        newTotal = found.Object.quantity + quantity,
                        diff = quantity,
                        lq = Sel.query(<span class="hljs-string">".quantity"</span>, found, <span class="hljs-literal">true</span>),
                        inp = Sel.query(<span class="hljs-string">"input"</span>, found, <span class="hljs-literal">true</span>);
                    <span class="hljs-keyword">if</span> (newTotal &gt; li.GlyphSummary.quantity) {
                        newTotal = li.GlyphSummary.quantity;
                        diff = newTotal - found.Object.quantity;
                    }
                    <span class="hljs-keyword">if</span> (inp) {
                        inp.value = diff;
                    }
                    lq.innerHTML = newTotal;
                    found.Object.quantity = newTotal;
                    <span class="hljs-keyword">this</span>.updateAddCargo(<span class="hljs-keyword">this</span>.glyphSize * diff);
                }
            }
        },
        AddPlanSummary: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> quantity = matchedEl.previousSibling.value * <span class="hljs-number">1</span>,
                li = matchedEl.parentNode,
                c = Dom.get(<span class="hljs-string">"tradeAddItems"</span>);
            <span class="hljs-keyword">if</span> (li &amp;&amp; c) {
                <span class="hljs-keyword">var</span> pName = li.PlanSummary.name,
                    pType = li.PlanSummary.plan_type,
                    pLevel = li.PlanSummary.level,
                    pExtra = li.PlanSummary.extra_build_level,
                    id = [<span class="hljs-string">'addPlanSummary-'</span>, pType, <span class="hljs-string">'-'</span>, pLevel, <span class="hljs-string">'-'</span>, pExtra].join(<span class="hljs-string">''</span>)
                        .titleCaps(<span class="hljs-string">' '</span>, <span class="hljs-string">'_'</span>),
                    exists = Sel.query(<span class="hljs-string">"#"</span> + id, c);
                <span class="hljs-keyword">if</span> (exists.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">var</span> item = document.createElement(<span class="hljs-string">"li"</span>),
                        del = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>)),
                        content = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>));
                    item.id = id;
                    Dom.addClass(item, <span class="hljs-string">"tradeItem"</span>);
                    Dom.addClass(del, <span class="hljs-string">"tradeDelete"</span>);
                    Event.on(del, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                        <span class="hljs-keyword">var</span> ed = Event.getTarget(e),
                            ep = ed.parentNode;
                        <span class="hljs-keyword">this</span>.updateAddCargo(ep.Object.quantity * -<span class="hljs-keyword">this</span>.planSize);
                        Event.purgeElement(item);
                        item.parentNode.removeChild(item);
                    }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                    item.Object = {
                        plan_type: pType,
                        quantity: quantity,
                        type: <span class="hljs-string">"plan"</span>,
                        level: pLevel,
                        extra_build_level: pExtra,
                        size: <span class="hljs-keyword">this</span>.planSize
                    };
                    <span class="hljs-keyword">if</span> (pExtra &gt; <span class="hljs-number">0</span>) {
                        content.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, pName, <span class="hljs-string">' '</span>, pLevel, <span class="hljs-string">'+'</span>, pExtra, <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" value="'</span>, quantity, <span class="hljs-string">'" /&gt;&lt;button type="button"&gt;-&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                    } <span class="hljs-keyword">else</span> {
                        content.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, pName, <span class="hljs-string">' '</span>, pLevel, <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" value="'</span>, quantity, <span class="hljs-string">'" /&gt;&lt;button type="button"&gt;-&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                    }
                    c.appendChild(item);
                    <span class="hljs-keyword">this</span>.updateAddCargo(<span class="hljs-keyword">this</span>.planSize * quantity);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> found = exists[<span class="hljs-number">0</span>],
                        newTotal = found.Object.quantity + quantity,
                        diff = quantity,
                        lq = Sel.query(<span class="hljs-string">".quantity"</span>, found, <span class="hljs-literal">true</span>),
                        inp = Sel.query(<span class="hljs-string">"input"</span>, found, <span class="hljs-literal">true</span>);
                    <span class="hljs-keyword">if</span> (newTotal &gt; li.PlanSummary.quantity) {
                        newTotal = li.PlanSummary.quantity;
                        diff = newTotal - found.Object.quantity;
                    }
                    <span class="hljs-keyword">if</span> (inp) {
                        inp.value = diff;
                    }
                    lq.innerHTML = newTotal;
                    found.Object.quantity = newTotal;
                    <span class="hljs-keyword">this</span>.updateAddCargo(<span class="hljs-keyword">this</span>.planSize * diff);
                }
            }
        },
        AddShipSummary: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> quantity = matchedEl.previousSibling.value * <span class="hljs-number">1</span>,
                li = matchedEl.parentNode,
                c = Dom.get(<span class="hljs-string">"tradeAddItems"</span>);
            <span class="hljs-keyword">if</span> (li &amp;&amp; c) {
                <span class="hljs-keyword">var</span> sName = li.ShipSummary.name,
                    sType = li.ShipSummary.type,
                    sSize = li.ShipSummary.hold_size,
                    sBerth = li.ShipSummary.berth_level,
                    sSpeed = li.ShipSummary.speed,
                    id = [<span class="hljs-string">'addShipSummary'</span>, sName, sType, sSize, sBerth, sSpeed].join(<span class="hljs-string">'-'</span>)
                        .titleCaps(<span class="hljs-string">' '</span>, <span class="hljs-string">'_'</span>),
                    exists = Sel.query(<span class="hljs-string">"#"</span> + id, c);
                <span class="hljs-keyword">if</span> (exists.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">var</span> item = document.createElement(<span class="hljs-string">"li"</span>),
                        del = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>)),
                        content = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>));
                    item.id = id;
                    Dom.addClass(item, <span class="hljs-string">"tradeItem"</span>);
                    Dom.addClass(del, <span class="hljs-string">"tradeDelete"</span>);
                    Event.on(del, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                        <span class="hljs-keyword">var</span> ed = Event.getTarget(e),
                            ep = ed.parentNode;
                        <span class="hljs-keyword">this</span>.updateAddCargo(ep.Object.quantity * -<span class="hljs-keyword">this</span>.shipSize);
                        Event.purgeElement(item);
                        item.parentNode.removeChild(item);
                    }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                    item.Object = {
                        quantity: quantity,
                        type: <span class="hljs-string">"ship"</span>,
                        name: sName,
                        ship_type: sType,
                        hold_size: sSize,
                        berth_level: sBerth,
                        speed: sSpeed,
                        size: <span class="hljs-keyword">this</span>.shipSize
                    };
                    content.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, sName, <span class="hljs-string">' - '</span>, sType.titleCaps(<span class="hljs-string">'_'</span>, <span class="hljs-string">' '</span>), <span class="hljs-string">' - Hold:'</span>, sSize, <span class="hljs-string">' - Berth:'</span>, sBerth, <span class="hljs-string">' - Speed:'</span>, sSpeed, <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" value="'</span>,
                        quantity, <span class="hljs-string">'" /&gt;&lt;button type="button"&gt;-&lt;/button&gt;'</span>
                    ].join(<span class="hljs-string">''</span>);
                    c.appendChild(item);
                    <span class="hljs-keyword">this</span>.updateAddCargo(<span class="hljs-keyword">this</span>.shipSize * quantity);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> found = exists[<span class="hljs-number">0</span>],
                        newTotal = found.Object.quantity + quantity,
                        diff = quantity,
                        lq = Sel.query(<span class="hljs-string">".quantity"</span>, found, <span class="hljs-literal">true</span>),
                        inp = Sel.query(<span class="hljs-string">"input"</span>, found, <span class="hljs-literal">true</span>);
                    <span class="hljs-keyword">if</span> (newTotal &gt; li.ShipSummary.quantity) {
                        newTotal = li.ShipSummary.quantity;
                        diff = newTotal - found.Object.quantity;
                    }
                    <span class="hljs-keyword">if</span> (inp) {
                        inp.value = diff;
                    }
                    lq.innerHTML = newTotal;
                    found.Object.quantity = newTotal;
                    <span class="hljs-keyword">this</span>.updateAddCargo(<span class="hljs-keyword">this</span>.shipSize * diff);
                }
            }
        },
        AddPrisoner: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> li = matchedEl.parentNode,
                c = Dom.get(<span class="hljs-string">"tradeAddItems"</span>);
            <span class="hljs-keyword">if</span> (li &amp;&amp; c) {
                <span class="hljs-keyword">var</span> obj = li.Prisoner,
                    gId = obj.id,
                    id = <span class="hljs-string">"addPrisoner-"</span> + gId;
                <span class="hljs-keyword">if</span> (Sel.query(<span class="hljs-string">"#"</span> + id, c)
                    .length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">var</span> item = document.createElement(<span class="hljs-string">"li"</span>),
                        del = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>)),
                        content = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>));
                    item.id = id;
                    Dom.addClass(item, <span class="hljs-string">"tradeItem"</span>);
                    Dom.addClass(del, <span class="hljs-string">"tradeDelete"</span>);
                    Event.on(del, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                        <span class="hljs-keyword">this</span>.updateAddCargo(<span class="hljs-keyword">this</span>.spySize * -<span class="hljs-number">1</span>);
                        Event.purgeElement(item);
                        item.parentNode.removeChild(item);
                    }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                    item.Object = {
                        prisoner_id: gId,
                        type: <span class="hljs-string">"prisoner"</span>,
                        size: <span class="hljs-keyword">this</span>.spySize
                    };
                    content.innerHTML = [obj.name, <span class="hljs-string">' '</span>, obj.level].join(<span class="hljs-string">''</span>);
                    c.appendChild(item);
                    <span class="hljs-keyword">this</span>.updateAddCargo(<span class="hljs-keyword">this</span>.spySize);
                }
            }
        },
        AddRemove: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> quantity = matchedEl.previousSibling.value * <span class="hljs-number">1</span>,
                li = matchedEl.parentNode.parentNode;
            <span class="hljs-keyword">if</span> (quantity) {
                <span class="hljs-keyword">var</span> newTotal = li.Object.quantity - quantity,
                    diff = quantity * -<span class="hljs-number">1</span>,
                    lq = Sel.query(<span class="hljs-string">".quantity"</span>, li, <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">if</span> (newTotal &lt; <span class="hljs-number">0</span>) {
                    newTotal = <span class="hljs-number">0</span>;
                    diff = li.Object.quantity * -<span class="hljs-number">1</span>;
                }
                <span class="hljs-keyword">if</span> (newTotal === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">this</span>.updateAddCargo(li.Object.quantity * -<span class="hljs-number">1</span> * li.Object.size);
                    Event.purgeElement(li);
                    li.parentNode.removeChild(li);
                } <span class="hljs-keyword">else</span> {
                    lq.innerHTML = newTotal;
                    li.Object.quantity = newTotal;
                    <span class="hljs-keyword">this</span>.updateAddCargo(diff * li.Object.size);
                    <span class="hljs-keyword">var</span> a = <span class="hljs-keyword">new</span> Util.ColorAnim(lq, {
                        color: {
                            from: <span class="hljs-string">'#f00'</span>,
                            to: <span class="hljs-string">'#fff'</span>
                        }
                    }, <span class="hljs-number">1.5</span>);
                    a.animate();
                }
            }
        },
        AddTrade: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> qVal = Dom.get(<span class="hljs-string">"tradeAddAskingQuantity"</span>)
                .value * <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (!Lang.isNumber(qVal) || qVal &lt;= <span class="hljs-number">0</span>) {
                Dom.get(<span class="hljs-string">"tradeAddMessage"</span>)
                    .innerHTML = <span class="hljs-string">"Quantity of asking essentia must be a number and greater than 0"</span>;
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> {
                Dom.get(<span class="hljs-string">"tradeAddMessage"</span>)
                    .innerHTML = <span class="hljs-string">""</span>;
            }
            <span class="hljs-keyword">var</span> data = {
                session_id: Game.GetSession(<span class="hljs-string">""</span>),
                building_id: <span class="hljs-keyword">this</span>.building.id,
                offer: [],
                ask: qVal,
                options: {
                    ship_id: Lib.getSelectedOptionValue(<span class="hljs-string">"tradeAddShip"</span>)
                }
            };
            <span class="hljs-keyword">var</span> hasResources, hasPlans, hasGlyphs, hasShips, hasPrisoners, lis = Sel.query(<span class="hljs-string">"li"</span>, <span class="hljs-string">"tradeAddItems"</span>);
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>; n &lt; lis.length; n++) {
                <span class="hljs-keyword">var</span> obj = lis[n].Object;
                <span class="hljs-keyword">if</span> (obj) {
                    data.offer[data.offer.length] = obj;
                    <span class="hljs-keyword">switch</span> (obj.type) {
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"plan"</span>:
                        hasPlans = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"glyph"</span>:
                        hasGlyphs = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"prisoner"</span>:
                        hasPrisoners = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"ship"</span>:
                        hasShips = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">default</span>:
                        hasResources = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">break</span>;
                    }
                }
            }
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.service.add_to_market(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">this</span>.rpcSuccess(o);
                    <span class="hljs-keyword">if</span> (hasResources) {
                        <span class="hljs-keyword">this</span>.getStoredResources(<span class="hljs-literal">true</span>);
                    }
                    <span class="hljs-keyword">if</span> (hasPlans) {
                        <span class="hljs-keyword">this</span>.getPlanSummary(<span class="hljs-literal">true</span>);
                    }
                    <span class="hljs-keyword">if</span> (hasGlyphs) {
                        <span class="hljs-keyword">this</span>.getGlyphSummary(<span class="hljs-literal">true</span>);
                    }
                    <span class="hljs-keyword">if</span> (hasPrisoners) {
                        <span class="hljs-keyword">this</span>.getPrisoners(<span class="hljs-literal">true</span>);
                    }
                    <span class="hljs-keyword">if</span> (hasShips) {
                        <span class="hljs-keyword">this</span>.getShipSummary(<span class="hljs-literal">true</span>);
                    }
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; lis.length; i++) {
                        <span class="hljs-keyword">if</span> (lis[i].Object) {
                            Event.purgeElement(lis[i]);
                            lis[i].parentNode.removeChild(lis[i]);
                        }
                    }
                    Dom.get(<span class="hljs-string">"tradeAddAskingQuantity"</span>)
                        .value = <span class="hljs-string">""</span>;
                    Dom.get(<span class="hljs-string">"tradeAddCargo"</span>)
                        .innerHTML = <span class="hljs-string">"0"</span>;
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onSelectTab"</span>, <span class="hljs-keyword">this</span>.mineTabIndex);
                    Lacuna.Pulser.Hide();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        <span class="hljs-comment">//Push Resources</span>
        populatePushResourceName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradePushResourceName"</span>),
                li = document.createElement(<span class="hljs-string">"li"</span>),
                nLi, x, r, name, resource;
            <span class="hljs-keyword">if</span> (elm) {
                elm.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">for</span> (r <span class="hljs-keyword">in</span> Lib.ResourceTypes) {
                    <span class="hljs-keyword">if</span> (Lib.ResourceTypes.hasOwnProperty(r)) {
                        resource = Lib.ResourceTypes[r];
                        <span class="hljs-keyword">if</span> (Lang.isArray(resource)) {
                            <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; resource.length; x++) {
                                name = resource[x];
                                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.resources[name]) {
                                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                                    nLi.Resource = {
                                        type: name,
                                        quantity: <span class="hljs-keyword">this</span>.resources[name] * <span class="hljs-number">1</span>
                                    };
                                    nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, name.titleCaps(), <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, <span class="hljs-keyword">this</span>.resources[name], <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" /&gt;&lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                                    elm.appendChild(nLi);
                                }
                            }
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.resources[r] &amp;&amp; resource) {
                            nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                            nLi.Resource = {
                                type: r,
                                quantity: <span class="hljs-keyword">this</span>.resources[r] * <span class="hljs-number">1</span>
                            };
                            nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, r.titleCaps(), <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, <span class="hljs-keyword">this</span>.resources[r], <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" /&gt;&lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                            elm.appendChild(nLi);
                        }
                    }
                }
            }
            <span class="hljs-comment">//wait for tab to display first</span>
            setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">var</span> Ht = Game.GetSize()
                    .h - <span class="hljs-number">180</span>;
                <span class="hljs-keyword">if</span> (Ht &gt; <span class="hljs-number">320</span>) {
                    Ht = <span class="hljs-number">320</span>;
                }
                <span class="hljs-keyword">var</span> pHt = Dom.get(<span class="hljs-string">'pHt'</span>);
                Dom.setStyle(pHt, <span class="hljs-string">"height"</span>, Ht + <span class="hljs-string">"px"</span>);
                Dom.setStyle(pHt, <span class="hljs-string">"overflow-y"</span>, <span class="hljs-string">"auto"</span>);
            }, <span class="hljs-number">10</span>);
        },
        populatePushGlyphSummaryName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradePushGlyphSummaryName"</span>),
                li = document.createElement(<span class="hljs-string">"li"</span>),
                nLi;
            <span class="hljs-keyword">if</span> (elm) {
                elm.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.glyph_summary.length &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-keyword">this</span>.glyph_summary.length; x++) {
                        <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.glyph_summary[x];
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                        nLi.GlyphSummary = obj;
                        nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, obj.name.titleCaps(), <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, obj.quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" /&gt;&lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                        elm.appendChild(nLi);
                    }
                } <span class="hljs-keyword">else</span> {
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    nLi.innerHTML = <span class="hljs-string">"No Glyphs Available"</span>;
                    elm.appendChild(nLi);
                }
            }
        },
        populatePushPlanSummaryName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradePushPlanSummaryName"</span>),
                li = document.createElement(<span class="hljs-string">"li"</span>),
                nLi;
            <span class="hljs-keyword">if</span> (elm) {
                elm.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.plan_summary.length &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-keyword">this</span>.plan_summary.length; x++) {
                        <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.plan_summary[x];
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                        nLi.PlanSummary = obj;
                        <span class="hljs-keyword">if</span> (obj.extra_build_level &gt; <span class="hljs-number">0</span>) {
                            nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, obj.name, <span class="hljs-string">' '</span>, obj.level, <span class="hljs-string">'+'</span>, obj.extra_build_level, <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, obj.quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" /&gt;&lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                        } <span class="hljs-keyword">else</span> {
                            nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, obj.name, <span class="hljs-string">' '</span>, obj.level, <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, obj.quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" /&gt;&lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                        }
                        elm.appendChild(nLi);
                    }
                } <span class="hljs-keyword">else</span> {
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    nLi.innerHTML = <span class="hljs-string">"No Plans Available"</span>;
                    elm.appendChild(nLi);
                }
            }
        },
        populatePushShipSummaryName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradePushShipSummaryName"</span>),
                li = document.createElement(<span class="hljs-string">"li"</span>),
                nLi;
            <span class="hljs-keyword">if</span> (elm) {
                elm.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.ship_summary.length &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-keyword">this</span>.ship_summary.length; x++) {
                        <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.ship_summary[x];
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                        nLi.ShipSummary = obj;
                        nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeName"&gt;'</span>, obj.name, <span class="hljs-string">' - '</span>, obj.type.titleCaps(<span class="hljs-string">'_'</span>, <span class="hljs-string">' '</span>), <span class="hljs-string">' - Hold:'</span>, obj.hold_size, <span class="hljs-string">' - Berth:'</span>, obj.berth_level, <span class="hljs-string">' - Speed:'</span>, obj.speed, <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, obj.quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" /&gt;&lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                        elm.appendChild(nLi);
                    }
                } <span class="hljs-keyword">else</span> {
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    nLi.innerHTML = <span class="hljs-string">"No Ships Available"</span>;
                    elm.appendChild(nLi);
                }
            }
        },
        populatePushPrisonerName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradePushPrisonerName"</span>),
                li = document.createElement(<span class="hljs-string">"li"</span>),
                nLi;
            <span class="hljs-keyword">if</span> (elm) {
                elm.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.prisoners.length &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-keyword">this</span>.prisoners.length; x++) {
                        <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.prisoners[x];
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                        nLi.Prisoner = obj;
                        nLi.innerHTML = [<span class="hljs-string">'&lt;span class="tradeName"&gt;'</span>, obj.name, <span class="hljs-string">' '</span>, obj.level, <span class="hljs-string">'&lt;/span&gt; &lt;button type="button"&gt;+&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                        elm.appendChild(nLi);
                    }
                } <span class="hljs-keyword">else</span> {
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    nLi.innerHTML = <span class="hljs-string">"No Prisoners Available"</span>;
                    elm.appendChild(nLi);
                }
            }
        },
        getPushShips: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> targetId = Lib.getSelectedOptionValue(<span class="hljs-string">"tradePushColony"</span>);
            <span class="hljs-keyword">if</span> (targetId) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.service.get_trade_ships({
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    building_id: <span class="hljs-keyword">this</span>.building.id,
                    target_body_id: targetId
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradePushShip"</span>),
                            opt = document.createElement(<span class="hljs-string">"option"</span>),
                            ships = o.result.ships,
                            nOpt;
                        <span class="hljs-keyword">if</span> (elm &amp;&amp; ships) {
                            <span class="hljs-keyword">var</span> selectedVal = Lib.getSelectedOptionValue(elm);
                            elm.options.length = <span class="hljs-number">0</span>;
                            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; ships.length; x++) {
                                <span class="hljs-keyword">var</span> obj = ships[x];
                                nOpt = opt.cloneNode(<span class="hljs-literal">false</span>);
                                nOpt.value = obj.id;
                                nOpt.innerHTML = [obj.name, <span class="hljs-string">' ('</span>, obj.type_human, <span class="hljs-string">' - Hold:'</span>, obj.hold_size, <span class="hljs-string">' - Estimated Travel Time:'</span>, Lib.formatTime(obj.estimated_travel_time), <span class="hljs-string">')'</span>].join(<span class="hljs-string">''</span>);
                                nOpt.selected = selectedVal === obj.id;
                                elm.appendChild(nOpt);
                            }
                        }
                        Lacuna.Pulser.Hide();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            } <span class="hljs-keyword">else</span> {
                Dom.get(<span class="hljs-string">"tradePushShip"</span>)
                    .options.length = <span class="hljs-number">0</span>;
            }
        },
        updatePushCargo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(byVal)</span> {</span>
            <span class="hljs-keyword">var</span> c = Dom.get(<span class="hljs-string">"tradePushCargo"</span>),
                cv = c.innerHTML * <span class="hljs-number">1</span>;
            c.innerHTML = cv + byVal;
        },
        PushAddResource: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> quantity = matchedEl.previousSibling.value * <span class="hljs-number">1</span>,
                li = matchedEl.parentNode,
                c = Dom.get(<span class="hljs-string">"tradePushItems"</span>);
            <span class="hljs-keyword">if</span> (quantity &amp;&amp; c) {
                <span class="hljs-keyword">var</span> id = <span class="hljs-string">"pushResource-"</span> + li.Resource.type,
                    exists = Sel.query(<span class="hljs-string">"#"</span> + id, c);
                <span class="hljs-keyword">if</span> (exists.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">var</span> item = document.createElement(<span class="hljs-string">"li"</span>),
                        del = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>)),
                        content = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>));
                    item.id = id;
                    <span class="hljs-keyword">if</span> (quantity &gt; li.Resource.quantity) {
                        quantity = li.Resource.quantity;
                    }
                    Dom.addClass(item, <span class="hljs-string">"tradeItem"</span>);
                    Dom.addClass(del, <span class="hljs-string">"tradeDelete"</span>);
                    Event.on(del, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                        <span class="hljs-keyword">var</span> ed = Event.getTarget(e),
                            ep = ed.parentNode;
                        <span class="hljs-keyword">this</span>.updatePushCargo(ep.Object.quantity * -<span class="hljs-number">1</span>);
                        Event.purgeElement(ep);
                        ep.parentNode.removeChild(ep);
                    }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                    item.Object = {
                        type: li.Resource.type,
                        quantity: quantity,
                        size: <span class="hljs-number">1</span>
                    };
                    content.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, item.Object.type.titleCaps(), <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" value="'</span>, quantity, <span class="hljs-string">'" /&gt;&lt;button type="button"&gt;-&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                    c.appendChild(item);
                    <span class="hljs-keyword">this</span>.updatePushCargo(quantity);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> found = exists[<span class="hljs-number">0</span>],
                        newTotal = found.Object.quantity + quantity,
                        diff = quantity,
                        lq = Sel.query(<span class="hljs-string">".quantity"</span>, found, <span class="hljs-literal">true</span>),
                        inp = Sel.query(<span class="hljs-string">"input"</span>, found, <span class="hljs-literal">true</span>);
                    <span class="hljs-keyword">if</span> (newTotal &gt; li.Resource.quantity) {
                        newTotal = li.Resource.quantity;
                        diff = newTotal - found.Object.quantity;
                    }
                    <span class="hljs-keyword">if</span> (inp) {
                        inp.value = diff;
                    }
                    lq.innerHTML = newTotal;
                    found.Object.quantity = newTotal;
                    <span class="hljs-keyword">this</span>.updatePushCargo(diff);
                    <span class="hljs-keyword">var</span> a = <span class="hljs-keyword">new</span> Util.ColorAnim(lq, {
                        color: {
                            from: <span class="hljs-string">'#0f0'</span>,
                            to: <span class="hljs-string">'#fff'</span>
                        }
                    }, <span class="hljs-number">1.5</span>);
                    a.animate();
                }
            }
        },
        PushAddGlyphSummary: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> quantity = matchedEl.previousSibling.value * <span class="hljs-number">1</span>,
                li = matchedEl.parentNode,
                c = Dom.get(<span class="hljs-string">"tradePushItems"</span>);
            <span class="hljs-keyword">if</span> (li &amp;&amp; c) {
                <span class="hljs-keyword">var</span> gName = li.GlyphSummary.name,
                    id = <span class="hljs-string">"pushGlyphSummary-"</span> + gName,
                    exists = Sel.query(<span class="hljs-string">"#"</span> + id, c);
                <span class="hljs-keyword">if</span> (exists.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">var</span> item = document.createElement(<span class="hljs-string">"li"</span>),
                        del = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>)),
                        content = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>));
                    item.id = id;
                    Dom.addClass(item, <span class="hljs-string">"tradeItem"</span>);
                    Dom.addClass(del, <span class="hljs-string">"tradeDelete"</span>);
                    Event.on(del, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                        <span class="hljs-keyword">var</span> ed = Event.getTarget(e),
                            ep = ed.parentNode;
                        <span class="hljs-keyword">this</span>.updatePushCargo(ep.Object.quantity * -<span class="hljs-keyword">this</span>.glyphSize);
                        Event.purgeElement(item);
                        item.parentNode.removeChild(item);
                    }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                    item.Object = {
                        name: gName,
                        quantity: quantity,
                        type: <span class="hljs-string">"glyph"</span>,
                        size: <span class="hljs-keyword">this</span>.glyphSize
                    };
                    content.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, gName.titleCaps(), <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" value="'</span>, quantity, <span class="hljs-string">'" /&gt;&lt;button type="button"&gt;-&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                    c.appendChild(item);
                    <span class="hljs-keyword">this</span>.updatePushCargo(<span class="hljs-keyword">this</span>.glyphSize * quantity);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> found = exists[<span class="hljs-number">0</span>],
                        newTotal = found.Object.quantity + quantity,
                        diff = quantity,
                        lq = Sel.query(<span class="hljs-string">".quantity"</span>, found, <span class="hljs-literal">true</span>),
                        inp = Sel.query(<span class="hljs-string">"input"</span>, found, <span class="hljs-literal">true</span>);
                    <span class="hljs-keyword">if</span> (newTotal &gt; li.GlyphSummary.quantity) {
                        newTotal = li.GlyphSummary.quantity;
                        diff = newTotal - found.Object.quantity;
                    }
                    <span class="hljs-keyword">if</span> (inp) {
                        inp.value = diff;
                    }
                    lq.innerHTML = newTotal;
                    found.Object.quantity = newTotal;
                    <span class="hljs-keyword">this</span>.updatePushCargo(<span class="hljs-keyword">this</span>.glyphSize * diff);
                }
            }
        },
        PushAddPlanSummary: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> quantity = matchedEl.previousSibling.value * <span class="hljs-number">1</span>,
                li = matchedEl.parentNode,
                c = Dom.get(<span class="hljs-string">"tradePushItems"</span>);
            <span class="hljs-keyword">if</span> (quantity &amp;&amp; li &amp;&amp; c) {
                <span class="hljs-keyword">var</span> pName = li.PlanSummary.name,
                    pType = li.PlanSummary.plan_type,
                    pLevel = li.PlanSummary.level,
                    pExtra = li.PlanSummary.extra_build_level,
                    id = [<span class="hljs-string">'pushPlanSummary-'</span>, pType, <span class="hljs-string">'-'</span>, pLevel, <span class="hljs-string">'-'</span>, pExtra].join(<span class="hljs-string">''</span>)
                        .titleCaps(<span class="hljs-string">' '</span>, <span class="hljs-string">'_'</span>),
                    exists = Sel.query(<span class="hljs-string">"#"</span> + id, c);
                <span class="hljs-keyword">if</span> (exists.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">var</span> item = document.createElement(<span class="hljs-string">"li"</span>),
                        del = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>)),
                        content = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>));
                    item.id = id;
                    Dom.addClass(item, <span class="hljs-string">"tradeItem"</span>);
                    Dom.addClass(del, <span class="hljs-string">"tradeDelete"</span>);
                    Event.on(del, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                        <span class="hljs-keyword">var</span> ed = Event.getTarget(e),
                            ep = ed.parentNode;
                        <span class="hljs-keyword">this</span>.updatePushCargo(ep.Object.quantity * -<span class="hljs-keyword">this</span>.planSize);
                        Event.purgeElement(item);
                        item.parentNode.removeChild(item);
                    }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                    item.Object = {
                        plan_type: pType,
                        quantity: quantity,
                        type: <span class="hljs-string">"plan"</span>,
                        level: pLevel,
                        extra_build_level: pExtra,
                        size: <span class="hljs-keyword">this</span>.planSize
                    };
                    <span class="hljs-keyword">if</span> (pExtra &gt; <span class="hljs-number">0</span>) {
                        content.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, pName, <span class="hljs-string">' '</span>, pLevel, <span class="hljs-string">'+'</span>, pExtra, <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" value="'</span>, quantity, <span class="hljs-string">'" /&gt;&lt;button type="button"&gt;-&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                    } <span class="hljs-keyword">else</span> {
                        content.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, pName, <span class="hljs-string">' '</span>, pLevel, <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" value="'</span>, quantity, <span class="hljs-string">'" /&gt;&lt;button type="button"&gt;-&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>);
                    }
                    c.appendChild(item);
                    <span class="hljs-keyword">this</span>.updatePushCargo(<span class="hljs-keyword">this</span>.planSize * quantity);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> found = exists[<span class="hljs-number">0</span>],
                        newTotal = found.Object.quantity + quantity,
                        diff = quantity,
                        lq = Sel.query(<span class="hljs-string">".quantity"</span>, found, <span class="hljs-literal">true</span>),
                        inp = Sel.query(<span class="hljs-string">"input"</span>, found, <span class="hljs-literal">true</span>);
                    <span class="hljs-keyword">if</span> (newTotal &gt; li.PlanSummary.quantity) {
                        newTotal = li.PlanSummary.quantity;
                        diff = newTotal - found.Object.quantity;
                    }
                    <span class="hljs-keyword">if</span> (inp) {
                        inp.value = diff;
                    }
                    lq.innerHTML = newTotal;
                    found.Object.quantity = newTotal;
                    <span class="hljs-keyword">this</span>.updatePushCargo(<span class="hljs-keyword">this</span>.planSize * diff);
                }
            }
        },
        PushAddShipSummary: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> quantity = matchedEl.previousSibling.value * <span class="hljs-number">1</span>,
                li = matchedEl.parentNode,
                c = Dom.get(<span class="hljs-string">"tradePushItems"</span>);
            <span class="hljs-keyword">if</span> (li &amp;&amp; c) {
                <span class="hljs-keyword">var</span> sName = li.ShipSummary.name,
                    sType = li.ShipSummary.type,
                    sSize = li.ShipSummary.hold_size,
                    sBerth = li.ShipSummary.berth_level,
                    sSpeed = li.ShipSummary.speed,
                    id = [<span class="hljs-string">'pushShipSummary-'</span>, sName, sType, sSize, sBerth, sSpeed].join(<span class="hljs-string">'-'</span>)
                        .titleCaps(<span class="hljs-string">' '</span>, <span class="hljs-string">'_'</span>),
                    exists = Sel.query(<span class="hljs-string">"#"</span> + id, c);
                <span class="hljs-keyword">if</span> (exists.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">var</span> item = document.createElement(<span class="hljs-string">"li"</span>),
                        del = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>)),
                        content = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>));
                    item.id = id;
                    Dom.addClass(item, <span class="hljs-string">"tradeItem"</span>);
                    Dom.addClass(del, <span class="hljs-string">"tradeDelete"</span>);
                    Event.on(del, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                        <span class="hljs-keyword">var</span> ed = Event.getTarget(e),
                            ep = ed.parentNode;
                        <span class="hljs-keyword">this</span>.updatePushCargo(ep.Object.quantity * -<span class="hljs-keyword">this</span>.shipSize);
                        Event.purgeElement(item);
                        item.parentNode.removeChild(item);
                    }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                    item.Object = {
                        quantity: quantity,
                        type: <span class="hljs-string">"ship"</span>,
                        name: sName,
                        ship_type: sType,
                        hold_size: sSize,
                        berth_level: sBerth,
                        speed: sSpeed,
                        size: <span class="hljs-keyword">this</span>.shipSize
                    };
                    content.innerHTML = [<span class="hljs-string">'&lt;span class="tradeResourceName"&gt;'</span>, sName, <span class="hljs-string">' - '</span>,
                        sType.titleCaps(<span class="hljs-string">'_'</span>, <span class="hljs-string">' '</span>), <span class="hljs-string">' - Hold:'</span>, sSize, <span class="hljs-string">' - Berth:'</span>, sBerth, <span class="hljs-string">' - Speed:'</span>, sSpeed, <span class="hljs-string">' (&lt;label class="quantity"&gt;'</span>, quantity, <span class="hljs-string">'&lt;/label&gt;)&lt;/span&gt; &lt;input type="text" style="width:75px;" value="'</span>, quantity, <span class="hljs-string">'" /&gt;&lt;button type="button"&gt;-&lt;/button&gt;'</span>
                    ].join(<span class="hljs-string">''</span>);
                    c.appendChild(item);
                    <span class="hljs-keyword">this</span>.updatePushCargo(<span class="hljs-keyword">this</span>.shipSize * quantity);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> found = exists[<span class="hljs-number">0</span>],
                        newTotal = found.Object.quantity + quantity,
                        diff = quantity,
                        lq = Sel.query(<span class="hljs-string">".quantity"</span>, found, <span class="hljs-literal">true</span>),
                        inp = Sel.query(<span class="hljs-string">"input"</span>, found, <span class="hljs-literal">true</span>);
                    <span class="hljs-keyword">if</span> (newTotal &gt; li.ShipSummary.quantity) {
                        newTotal = li.ShipSummary.quantity;
                        diff = newTotal - found.Object.quantity;
                    }
                    <span class="hljs-keyword">if</span> (inp) {
                        inp.value = diff;
                    }
                    lq.innerHTML = newTotal;
                    found.Object.quantity = newTotal;
                    <span class="hljs-keyword">this</span>.updatePushCargo(<span class="hljs-keyword">this</span>.shipSize * diff);
                }
            }
        },
        PushAddPrisoner: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> li = matchedEl.parentNode,
                c = Dom.get(<span class="hljs-string">"tradePushItems"</span>);
            <span class="hljs-keyword">if</span> (li &amp;&amp; c) {
                <span class="hljs-keyword">var</span> obj = li.Prisoner,
                    gId = obj.id,
                    id = <span class="hljs-string">"pushPrisoner-"</span> + gId;
                <span class="hljs-keyword">if</span> (Sel.query(<span class="hljs-string">"#"</span> + id, c)
                    .length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">var</span> item = document.createElement(<span class="hljs-string">"li"</span>),
                        del = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>)),
                        content = item.appendChild(document.createElement(<span class="hljs-string">"div"</span>));
                    item.id = id;
                    Dom.addClass(item, <span class="hljs-string">"tradeItem"</span>);
                    Dom.addClass(del, <span class="hljs-string">"tradeDelete"</span>);
                    Event.on(del, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                        <span class="hljs-keyword">this</span>.updatePushCargo(<span class="hljs-keyword">this</span>.spySize * -<span class="hljs-number">1</span>);
                        Event.purgeElement(item);
                        item.parentNode.removeChild(item);
                    }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                    item.Object = {
                        prisoner_id: gId,
                        type: <span class="hljs-string">"prisoner"</span>,
                        size: <span class="hljs-keyword">this</span>.spySize
                    };
                    content.innerHTML = [obj.name, <span class="hljs-string">' '</span>, obj.level].join(<span class="hljs-string">''</span>);
                    c.appendChild(item);
                    <span class="hljs-keyword">this</span>.updatePushCargo(<span class="hljs-keyword">this</span>.spySize);
                }
            }
        },
        PushRemove: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> quantity = matchedEl.previousSibling.value * <span class="hljs-number">1</span>,
                li = matchedEl.parentNode.parentNode;
            <span class="hljs-keyword">if</span> (quantity) {
                <span class="hljs-keyword">var</span> newTotal = li.Object.quantity - quantity,
                    diff = quantity * -<span class="hljs-number">1</span>,
                    lq = Sel.query(<span class="hljs-string">".quantity"</span>, li, <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">if</span> (newTotal &lt; <span class="hljs-number">0</span>) {
                    newTotal = <span class="hljs-number">0</span>;
                    diff = li.Object.quantity * -<span class="hljs-number">1</span>;
                }
                <span class="hljs-keyword">if</span> (newTotal === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">this</span>.updatePushCargo(li.Object.quantity * -<span class="hljs-number">1</span> * li.Object.size);
                    Event.purgeElement(li);
                    li.parentNode.removeChild(li);
                } <span class="hljs-keyword">else</span> {
                    lq.innerHTML = newTotal;
                    li.Object.quantity = newTotal;
                    <span class="hljs-keyword">this</span>.updatePushCargo(diff * li.Object.size);
                    <span class="hljs-keyword">var</span> a = <span class="hljs-keyword">new</span> Util.ColorAnim(lq, {
                        color: {
                            from: <span class="hljs-string">'#f00'</span>,
                            to: <span class="hljs-string">'#fff'</span>
                        }
                    }, <span class="hljs-number">1.5</span>);
                    a.animate();
                }
            }
        },
        Push: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> data = {
                session_id: Game.GetSession(<span class="hljs-string">""</span>),
                building_id: <span class="hljs-keyword">this</span>.building.id,
                target_id: Lib.getSelectedOptionValue(Dom.get(<span class="hljs-string">"tradePushColony"</span>)),
                options: {
                    ship_id: Lib.getSelectedOptionValue(Dom.get(<span class="hljs-string">"tradePushShip"</span>)),
                    stay: Dom.get(<span class="hljs-string">"tradePushStay"</span>)
                        .checked ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>
                }
            },
                lis = Sel.query(<span class="hljs-string">"li"</span>, <span class="hljs-string">"tradePushItems"</span>),
                items = [],
                hasResources, hasPlans, hasGlyphs, hasShips, hasPrisoners;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>; n &lt; lis.length; n++) {
                <span class="hljs-keyword">if</span> (lis[n].Object) {
                    items[n] = lis[n].Object;
                    <span class="hljs-keyword">switch</span> (items[n].type) {
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"plan"</span>:
                        hasPlans = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"glyph"</span>:
                        hasGlyphs = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"prisoner"</span>:
                        hasPrisoners = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"ship"</span>:
                        hasShips = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">default</span>:
                        hasResources = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">break</span>;
                    }
                }
            }
            data.items = items;
            <span class="hljs-keyword">if</span> (data.items.length === <span class="hljs-number">0</span>) {
                Dom.get(<span class="hljs-string">"tradePushMessage"</span>)
                    .innerHTML = <span class="hljs-string">"Must add items to send to colony."</span>;
            } <span class="hljs-keyword">else</span> {
                Dom.get(<span class="hljs-string">"tradePushMessage"</span>)
                    .innerHTML = <span class="hljs-string">""</span>;
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.service.push_items(data, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; lis.length; i++) {
                            <span class="hljs-keyword">if</span> (lis[i].Object) {
                                Event.purgeElement(lis[i]);
                                lis[i].parentNode.removeChild(lis[i]);
                            }
                        }
                        Dom.get(<span class="hljs-string">"tradePushCargo"</span>)
                            .innerHTML = <span class="hljs-string">"0"</span>;
                        <span class="hljs-keyword">if</span> (hasResources) {
                            <span class="hljs-keyword">this</span>.getStoredResources(<span class="hljs-literal">true</span>);
                        }
                        <span class="hljs-keyword">if</span> (hasPlans) {
                            <span class="hljs-keyword">this</span>.getPlanSummary(<span class="hljs-literal">true</span>);
                        }
                        <span class="hljs-keyword">if</span> (hasGlyphs) {
                            <span class="hljs-keyword">this</span>.getGlyphSummary(<span class="hljs-literal">true</span>);
                        }
                        <span class="hljs-keyword">if</span> (hasPrisoners) {
                            <span class="hljs-keyword">this</span>.getPrisoners(<span class="hljs-literal">true</span>);
                        }
                        <span class="hljs-keyword">if</span> (hasShips) {
                            <span class="hljs-keyword">this</span>.getShipSummary(<span class="hljs-literal">true</span>);
                        }
                        <span class="hljs-keyword">var</span> msg = Dom.get(<span class="hljs-string">"tradePushMessage"</span>);
                        msg.innerHTML = [<span class="hljs-string">"Successfully pushed to "</span>, Lib.getSelectedOption(Dom.get(<span class="hljs-string">"tradePushColony"</span>))
                            .innerHTML, <span class="hljs-string">'.'</span>
                        ].join(<span class="hljs-string">''</span>);
                        Lib.fadeOutElm(<span class="hljs-string">"tradePushMessage"</span>);
                        Lacuna.Pulser.Hide();
                        <span class="hljs-comment">//get new ships since we just sent one</span>
                        <span class="hljs-keyword">this</span>.getPushShips();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        addResourceOptions: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(selectElement, selected)</span> {</span>
            <span class="hljs-keyword">var</span> option;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> r <span class="hljs-keyword">in</span> Lib.ResourceTypes) {
                <span class="hljs-keyword">if</span> (Lib.ResourceTypes.hasOwnProperty(r)) {
                    <span class="hljs-keyword">var</span> resource = Lib.ResourceTypes[r];
                    <span class="hljs-keyword">if</span> (Lang.isArray(resource)) {
                        <span class="hljs-keyword">var</span> optGroup = document.createElement(<span class="hljs-string">"optgroup"</span>);
                        optGroup.setAttribute(<span class="hljs-string">"label"</span>, r.titleCaps());
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; resource.length; x++) {
                            <span class="hljs-keyword">var</span> name = resource[x];
                            option = document.createElement(<span class="hljs-string">"option"</span>);
                            option.setAttribute(<span class="hljs-string">"value"</span>, name);
                            option.innerHTML = name.titleCaps();
                            <span class="hljs-keyword">if</span> (selected &amp;&amp; name === selected) {
                                option.setAttribute(<span class="hljs-string">"selected"</span>, <span class="hljs-string">"selected"</span>);
                            }
                            optGroup.appendChild(option);
                        }
                        selectElement.appendChild(optGroup);
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resource) {
                        option = document.createElement(<span class="hljs-string">"option"</span>);
                        option.setAttribute(<span class="hljs-string">"value"</span>, r);
                        option.innerHTML = r.titleCaps();
                        <span class="hljs-keyword">if</span> (selected &amp;&amp; r === selected) {
                            option.setAttribute(<span class="hljs-string">"selected"</span>, <span class="hljs-string">"selected"</span>);
                        }
                        selectElement.appendChild(option);
                    }
                }
            }
        },
        resourceOptionsHTML: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(selected)</span> {</span>
            <span class="hljs-keyword">var</span> resource_options = <span class="hljs-string">""</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> r <span class="hljs-keyword">in</span> Lib.ResourceTypes) {
                <span class="hljs-keyword">if</span> (Lib.ResourceTypes.hasOwnProperty(r)) {
                    <span class="hljs-keyword">var</span> resource = Lib.ResourceTypes[r];
                    <span class="hljs-keyword">if</span> (Lang.isArray(resource)) {
                        resource_options += [<span class="hljs-string">'&lt;optgroup label="'</span>, r.titleCaps(), <span class="hljs-string">'"&gt;'</span>].join(<span class="hljs-string">''</span>);
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; resource.length; x++) {
                            <span class="hljs-keyword">var</span> name = resource[x];
                            resource_options += [<span class="hljs-string">'&lt;option value="'</span>, name, <span class="hljs-string">'"'</span>].join(<span class="hljs-string">''</span>);
                            <span class="hljs-keyword">if</span> (selected &amp;&amp; name === selected) {
                                resource_options += <span class="hljs-string">' selected="selected"'</span>;
                            }
                            resource_options += [<span class="hljs-string">'&gt;'</span>, name.titleCaps(), <span class="hljs-string">'&lt;/option&gt;'</span>].join(<span class="hljs-string">''</span>);
                        }
                        resource_options += <span class="hljs-string">'&lt;/optgroup&gt;'</span>;
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resource) {
                        resource_options += [<span class="hljs-string">'&lt;option value="'</span>, r, <span class="hljs-string">'"'</span>].join(<span class="hljs-string">''</span>);
                        <span class="hljs-keyword">if</span> (selected &amp;&amp; r === selected) {
                            resource_options += <span class="hljs-string">' selected="selected"'</span>;
                        }
                        resource_options += [<span class="hljs-string">'&gt;'</span>, r.titleCaps(), <span class="hljs-string">'&lt;/option&gt;'</span>].join(<span class="hljs-string">''</span>);
                    }
                }
            }
            <span class="hljs-keyword">return</span> resource_options;
        },
        viewSupplyChainInfo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            Dom.setStyle(<span class="hljs-string">"supplyChainList"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
            Dom.setStyle(<span class="hljs-string">"supplyChainListNone"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.supply_chains) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.service.view_supply_chains({
                    session_id: Game.GetSession(),
                    building_id: <span class="hljs-keyword">this</span>.building.id
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.viewSupplyChainList.success"</span>);
                        Lacuna.Pulser.Hide();
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">this</span>.max_supply_chains = o.result.max_supply_chains;
                        <span class="hljs-keyword">this</span>.supply_chains = o.result.supply_chains;
                        <span class="hljs-keyword">this</span>.SupplyChainMaxCount();
                        <span class="hljs-keyword">this</span>.SupplyChainList();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.supplyChainMaxCount();
                <span class="hljs-keyword">this</span>.SupplyChainList();
            }
        },
        SupplyChainMaxCount: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> max_container = Dom.get(<span class="hljs-string">"supplyChainMaxCount"</span>);
            max_container.innerHTML = [<span class="hljs-string">"&lt;b&gt;Total of"</span>,
                <span class="hljs-keyword">this</span>.supply_chains.length, <span class="hljs-string">"supply chains in use. This ministry can control a maximum of"</span>,
                <span class="hljs-keyword">this</span>.max_supply_chains, <span class="hljs-string">"supply chains.&lt;/b&gt;"</span>
            ].join(<span class="hljs-string">" "</span>);
        },
        SupplyChainList: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> supply_chains = <span class="hljs-keyword">this</span>.supply_chains;
            <span class="hljs-keyword">if</span> (supply_chains.length === <span class="hljs-number">0</span>) {
                Dom.setStyle(<span class="hljs-string">"supplyChainList"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                Dom.setStyle(<span class="hljs-string">"supplyChainListNone"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> {
                Dom.setStyle(<span class="hljs-string">"supplyChainList"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                Dom.setStyle(<span class="hljs-string">"supplyChainListNone"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
            }
            <span class="hljs-keyword">var</span> metric = Dom.get(<span class="hljs-string">"supplyChainMetric"</span>),
                details = Dom.get(<span class="hljs-string">"supplyChainListDetails"</span>),
                detailsParent = details.parentNode,
                ul = document.createElement(<span class="hljs-string">"ul"</span>),
                li = document.createElement(<span class="hljs-string">"li"</span>);</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>chains metric text</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            metric.innerHTML = <span class="hljs-keyword">this</span>.SupplyMetricDescription(supply_chains[<span class="hljs-number">0</span>].percent_transferred);</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>chains list</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            Event.purgeElement(details, <span class="hljs-literal">true</span>); <span class="hljs-comment">//clear any events before we remove</span>
            details = detailsParent.removeChild(details); <span class="hljs-comment">//remove from DOM to make this faster</span>
            details.innerHTML = <span class="hljs-string">""</span>;
            <span class="hljs-comment">//Dom.setStyle(detailsParent, "display", "");</span>
            detailsParent.appendChild(details); <span class="hljs-comment">//add back as child</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; supply_chains.length; i++) {
                <span class="hljs-keyword">var</span> chain = supply_chains[i],
                    nUl = ul.cloneNode(<span class="hljs-literal">false</span>);
                Dom.addClass(nUl, <span class="hljs-string">"supplyChainInfo"</span>);
                Dom.addClass(nUl, <span class="hljs-string">"clearafter"</span>);
                <span class="hljs-keyword">var</span> nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                Dom.addClass(nLi, <span class="hljs-string">"supplyChainBody"</span>);
                <span class="hljs-keyword">if</span> (chain.stalled === <span class="hljs-number">1</span>) {
                    Dom.addClass(nUl, <span class="hljs-string">"supplyChainStalled"</span>);
                    nLi.innerHTML = chain.body.name + <span class="hljs-string">" (Stalled)"</span>;
                } <span class="hljs-keyword">else</span> {
                    nLi.innerHTML = chain.body.name;
                }
                nUl.appendChild(nLi);
                nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                Dom.addClass(nLi, <span class="hljs-string">"supplyChainResource"</span>);
                <span class="hljs-keyword">var</span> nSel = document.createElement(<span class="hljs-string">"select"</span>);
                <span class="hljs-keyword">this</span>.addResourceOptions(nSel, chain.resource_type);
                nLi.appendChild(nSel);
                nUl.appendChild(nLi);
                nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                Dom.addClass(nLi, <span class="hljs-string">"supplyChainHour"</span>);
                <span class="hljs-keyword">var</span> nText = document.createElement(<span class="hljs-string">"input"</span>);
                nText.type = <span class="hljs-string">"text"</span>;
                nText.size = <span class="hljs-number">10</span>;
                nText.value = chain.resource_hour;
                nLi.appendChild(nText);
                nUl.appendChild(nLi);
                nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                Dom.addClass(nLi, <span class="hljs-string">"supplyChainAction"</span>);
                <span class="hljs-keyword">var</span> editBtn = document.createElement(<span class="hljs-string">"button"</span>);
                editBtn.setAttribute(<span class="hljs-string">"type"</span>, <span class="hljs-string">"button"</span>);
                editBtn.innerHTML = <span class="hljs-string">"Update Chain"</span>;
                nLi.appendChild(editBtn);
                <span class="hljs-keyword">var</span> delBtn = document.createElement(<span class="hljs-string">"button"</span>);
                delBtn.setAttribute(<span class="hljs-string">"type"</span>, <span class="hljs-string">"button"</span>);
                delBtn.innerHTML = <span class="hljs-string">"Delete Chain"</span>;
                nLi.appendChild(delBtn);
                nUl.appendChild(nLi);
                Event.on(editBtn, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.SupplyChainUpdate, {
                    Self: <span class="hljs-keyword">this</span>,
                    Chain: chain,
                    Type: nSel,
                    Hour: nText,
                    Line: nUl
                }, <span class="hljs-literal">true</span>);
                Event.on(delBtn, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.SupplyChainRemove, {
                    Self: <span class="hljs-keyword">this</span>,
                    Chain: chain,
                    Line: nUl
                }, <span class="hljs-literal">true</span>);
                details.appendChild(nUl);
            }
            <span class="hljs-comment">//wait for tab to display first</span>
            setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">var</span> Ht = Game.GetSize()
                    .h - <span class="hljs-number">250</span>;
                <span class="hljs-keyword">if</span> (Ht &gt; <span class="hljs-number">250</span>) {
                    Ht = <span class="hljs-number">250</span>;
                }
                Dom.setStyle(detailsParent, <span class="hljs-string">"height"</span>, Ht + <span class="hljs-string">"px"</span>);
                Dom.setStyle(detailsParent, <span class="hljs-string">"overflow-y"</span>, <span class="hljs-string">"auto"</span>);
            }, <span class="hljs-number">10</span>);
        },
        SupplyMetricDescription: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(percent_transferred)</span> {</span>
            <span class="hljs-keyword">var</span> output = [<span class="hljs-string">'Current supply capacity is '</span>, percent_transferred, <span class="hljs-string">'&amp;#37;. '</span>];
            <span class="hljs-keyword">if</span> (percent_transferred === <span class="hljs-number">0</span>) {
                output.push(<span class="hljs-string">'You have no ships servicing your supply chains.'</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (percent_transferred &gt; <span class="hljs-number">100</span>) {
                output.push(<span class="hljs-string">'You have excess ships servicing your supply chains. You can increase your chain hourly rate, or you may be able to remove some ships to get closer to 100&amp;#37;.'</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (percent_transferred &lt; <span class="hljs-number">100</span>) {
                output.push(<span class="hljs-string">'You have insufficient ships servicing your supply chains. You should reduce your chain hourly rate or add more supply ships.'</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (percent_transferred === <span class="hljs-number">100</span>) {
                output.push(<span class="hljs-string">'Your shipping capacity and supply chains requirements are exactly in sync.'</span>);
            }
            <span class="hljs-keyword">return</span> output.join(<span class="hljs-string">''</span>);
        },
        SupplyChainAddNew: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> target_id = Lib.getSelectedOptionValue(<span class="hljs-string">"supplyChainAddTargetId"</span>),
                resource_type = Lib.getSelectedOptionValue(<span class="hljs-string">"supplyChainAddResourceType"</span>),
                resource_hour = Dom.get(<span class="hljs-string">"supplyChainAddResourceHour"</span>)
                    .value;
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.Self.service.create_supply_chain({
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                target_id: target_id,
                resource_type: resource_type,
                resource_hour: resource_hour
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.SupplyChainAddNew.success"</span>);
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.Self.supply_chains;
                    <span class="hljs-keyword">this</span>.Self.viewSupplyChainInfo();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        SupplyChainUpdate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.Self.service.update_supply_chain({
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                supply_chain_id: <span class="hljs-keyword">this</span>.Chain.id,
                resource_type: Lib.getSelectedOptionValueFromSelectElement(<span class="hljs-keyword">this</span>.Type),
                resource_hour: <span class="hljs-keyword">this</span>.Hour.value
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.SupplyChainUpdate.success"</span>);
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.Self.supply_chains;
                    <span class="hljs-keyword">this</span>.Self.viewSupplyChainInfo();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        SupplyChainRemove: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> chain = <span class="hljs-keyword">this</span>.Chain;
            <span class="hljs-keyword">if</span> (!confirm([<span class="hljs-string">'Are you sure you want to delete the supply chain of'</span>, chain.resource_hour, chain.resource_type.titleCaps(), <span class="hljs-string">'to'</span>, chain.body.name].join(<span class="hljs-string">' '</span>))) {
                <span class="hljs-keyword">return</span>;
            }
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.Self.service.delete_supply_chain({
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                supply_chain_id: <span class="hljs-keyword">this</span>.Chain.id
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.SupplyChainRemove.success"</span>);
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.Self.supply_chains;
                    <span class="hljs-keyword">this</span>.Self.viewSupplyChainInfo();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        viewSupplyShips: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span></pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>we have 2 asynchronous functions below both wanting to hide
the pulsar - keep a count of requests so it only gets hidden
once they&#39;ve both completed</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">var</span> request_count = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.supply_chains) {
                Lacuna.Pulser.Show();
                request_count++;
                <span class="hljs-keyword">this</span>.service.view_supply_chains({
                    session_id: Game.GetSession(),
                    building_id: <span class="hljs-keyword">this</span>.building.id
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.viewSupplyChainList.success"</span>);
                        request_count--;
                        <span class="hljs-keyword">if</span> (request_count === <span class="hljs-number">0</span>) {
                            Lacuna.Pulser.Hide();
                        }
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">this</span>.supply_chains = o.result.supply_chains;
                        <span class="hljs-keyword">this</span>.SupplyChainShipsInfo();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.SupplyChainShipsInfo();
            }
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.supply_chain_ships) {
                Lacuna.Pulser.Show();
                request_count++;
                <span class="hljs-keyword">this</span>.service.get_supply_ships({
                    session_id: Game.GetSession(),
                    building_id: <span class="hljs-keyword">this</span>.building.id
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.viewSupplyShipsInfo.success"</span>);
                        request_count--;
                        <span class="hljs-keyword">if</span> (request_count === <span class="hljs-number">0</span>) {
                            Lacuna.Pulser.Hide();
                        }
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">this</span>.supply_chain_ships = o.result.ships;
                        <span class="hljs-keyword">this</span>.SupplyChainShipsPopulate();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.SupplyChainShipsPopulate();
            }
        },
        SupplyChainShipsInfo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> metric = Dom.get(<span class="hljs-string">"supplyChainShipsInfo"</span>);
            metric.innerHTML = <span class="hljs-keyword">this</span>.SupplyMetricDescription(<span class="hljs-keyword">this</span>.supply_chains[<span class="hljs-number">0</span>].percent_transferred);
        },
        SupplyChainShipsPopulate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> ships = <span class="hljs-keyword">this</span>.supply_chain_ships,
                no_ships = Dom.get(<span class="hljs-string">"supplyChainShipsNone"</span>),
                details = Dom.get(<span class="hljs-string">"supplyChainShipsDetails"</span>),
                detailsParent = details.parentNode;
            <span class="hljs-keyword">if</span> (ships.length === <span class="hljs-number">0</span>) {
                Dom.setStyle(details, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                Dom.setStyle(no_ships, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> {
                Dom.setStyle(details, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                Dom.setStyle(no_ships, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
            }
            Event.purgeElement(details, <span class="hljs-literal">true</span>); <span class="hljs-comment">//clear any events before we remove</span>
            details = detailsParent.removeChild(details); <span class="hljs-comment">//remove from DOM to make this faster</span>
            details.innerHTML = <span class="hljs-string">""</span>;
            Dom.setStyle(detailsParent, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
            detailsParent.appendChild(details); <span class="hljs-comment">//add back as child</span>
            <span class="hljs-keyword">if</span> (details) {
                <span class="hljs-keyword">var</span> ul = document.createElement(<span class="hljs-string">"ul"</span>),
                    li = document.createElement(<span class="hljs-string">"li"</span>),
                    availShips = [],
                    workingShips = [];
                Event.purgeElement(details);
                details.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ships.length; i++) {
                    <span class="hljs-keyword">var</span> ship = ships[i],
                        nUl = ul.cloneNode(<span class="hljs-literal">false</span>),
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    <span class="hljs-keyword">if</span> (ship.task === <span class="hljs-string">"Docked"</span>) {
                        availShips.push(ship);
                    } <span class="hljs-keyword">else</span> {
                        workingShips.push(ship);
                    }
                    nUl.Ship = ship;
                    Dom.addClass(nUl, <span class="hljs-string">"shipInfo"</span>);
                    Dom.addClass(nUl, <span class="hljs-string">"clearafter"</span>);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"shipName"</span>);
                    nLi.innerHTML = ship.name;
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"shipTask"</span>);
                    nLi.innerHTML = ship.task;
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"shipSpeed"</span>);
                    nLi.innerHTML = ship.speed;
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"shipHold"</span>);
                    nLi.innerHTML = ship.hold_size;
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"shipAction"</span>);
                    <span class="hljs-keyword">var</span> bbtn = document.createElement(<span class="hljs-string">"button"</span>);
                    bbtn.setAttribute(<span class="hljs-string">"type"</span>, <span class="hljs-string">"button"</span>);
                    bbtn.innerHTML = ship.task === <span class="hljs-string">"Docked"</span> ? <span class="hljs-string">"Add to Chain"</span> : <span class="hljs-string">"Remove from Chain"</span>;
                    bbtn = nLi.appendChild(bbtn);
                    nUl.appendChild(nLi);
                    <span class="hljs-keyword">if</span> (ship.task === <span class="hljs-string">"Docked"</span>) {
                        Event.on(bbtn, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.SupplyChainShipAdd, {
                            Self: <span class="hljs-keyword">this</span>,
                            Ship: ship,
                            Line: nUl
                        }, <span class="hljs-literal">true</span>);
                    } <span class="hljs-keyword">else</span> {
                        Event.on(bbtn, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.SupplyChainShipRemove, {
                            Self: <span class="hljs-keyword">this</span>,
                            Ship: ship,
                            Line: nUl
                        }, <span class="hljs-literal">true</span>);
                    }
                    details.appendChild(nUl);
                }
                <span class="hljs-comment">//wait for tab to display first</span>
                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">var</span> Ht = Game.GetSize()
                        .h - <span class="hljs-number">175</span>;
                    <span class="hljs-keyword">if</span> (Ht &gt; <span class="hljs-number">300</span>) {
                        Ht = <span class="hljs-number">300</span>;
                    }
                    Dom.setStyle(details.parentNode, <span class="hljs-string">"height"</span>, Ht + <span class="hljs-string">"px"</span>);
                    Dom.setStyle(details.parentNode, <span class="hljs-string">"overflow-y"</span>, <span class="hljs-string">"auto"</span>);
                }, <span class="hljs-number">10</span>);
            }
        },
        SupplyChainShipAdd: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.Self.service.add_supply_ship_to_fleet({
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                ship_id: <span class="hljs-keyword">this</span>.Ship.id
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.SupplyChainShipAdd.success"</span>);
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                    <span class="hljs-keyword">var</span> ships = <span class="hljs-keyword">this</span>.Self.supply_chain_ships;
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ships.length; i++) {
                        <span class="hljs-keyword">if</span> (ships[i].id === <span class="hljs-keyword">this</span>.Ship.id) {
                            ships.splice(i, <span class="hljs-number">1</span>);
                            <span class="hljs-keyword">break</span>;
                        }
                    }
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.Self.supply_chains;
                    <span class="hljs-keyword">this</span>.Self.viewSupplyShips();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        SupplyChainShipRemove: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.Self.service.remove_supply_ship_from_fleet({
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                ship_id: <span class="hljs-keyword">this</span>.Ship.id
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.SupplyChainShipRemove.success"</span>);
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                    <span class="hljs-keyword">var</span> ships = <span class="hljs-keyword">this</span>.Self.supply_chain_ships;
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ships.length; i++) {
                        <span class="hljs-keyword">if</span> (ships[i].id === <span class="hljs-keyword">this</span>.Ship.id) {
                            ships.splice(i, <span class="hljs-number">1</span>);
                            <span class="hljs-keyword">break</span>;
                        }
                    }
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.Self.supply_chains;
                    <span class="hljs-keyword">this</span>.Self.viewSupplyShips();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        viewWasteChainInfo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (e.newValue) {
                <span class="hljs-keyword">this</span>.WasteChainDetails();
                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.waste_chain_ships) {
                    <span class="hljs-keyword">this</span>.WasteChainShipsView();
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">this</span>.WasteChainShipsPopulate();
                }
            }
        },
        WasteChainDetails: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.service.view_waste_chains({
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.building.id
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.WasteChainDetails.success"</span>);
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.rpcSuccess(o);
                    <span class="hljs-keyword">this</span>.waste_chain = o.result.waste_chain[<span class="hljs-number">0</span>];
                    <span class="hljs-keyword">this</span>.WasteChainDetailsPopulate();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        WasteChainDetailsPopulate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> waste_chain = <span class="hljs-keyword">this</span>.waste_chain,
                details = Dom.get(<span class="hljs-string">"wasteChainDetails"</span>);
            <span class="hljs-keyword">if</span> (details) {
                <span class="hljs-keyword">var</span> show_equalize_button;
                <span class="hljs-keyword">if</span> (Game.GetCurrentPlanet()
                    .waste_hour &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>.waste_chain.percent_transferred &gt;= <span class="hljs-number">100</span>) {
                    show_equalize_button = <span class="hljs-number">1</span>;
                }
                details.innerHTML = [<span class="hljs-string">'&lt;b&gt;Local Star Waste Chain&lt;/b&gt;&lt;br/&gt;'</span>, <span class="hljs-string">'Waste/hr: '</span>, <span class="hljs-string">'&lt;input id="chainWasteHourInput" type="text" value="'</span>, waste_chain.waste_hour, <span class="hljs-string">'"/&gt; '</span>, <span class="hljs-string">'&lt;button id="chainWasteHourButton"&gt;Update&lt;/button&gt;'</span>,
                    show_equalize_button ? <span class="hljs-string">'&lt;button id="chainWasteEqualizeButton"&gt;Equalize Body Waste Production&lt;/button&gt;&lt;br/&gt;'</span> : <span class="hljs-string">'&lt;br/&gt;'</span>, <span class="hljs-string">'Percent Transferred: '</span>, waste_chain.percent_transferred, <span class="hljs-string">'&amp;#37;'</span>, <span class="hljs-string">'&lt;hr&gt;'</span>
                ].join(<span class="hljs-string">''</span>);
                Event.on(<span class="hljs-string">"chainWasteHourButton"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.WasteChainUpdateWasteHour, {
                    Self: <span class="hljs-keyword">this</span>
                }, <span class="hljs-literal">true</span>);
                Event.on(<span class="hljs-string">"chainWasteEqualizeButton"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.WasteChainEqualize, {
                    Self: <span class="hljs-keyword">this</span>
                }, <span class="hljs-literal">true</span>);
            }
        },
        WasteChainUpdateWasteHour: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> waste_chain_id = <span class="hljs-keyword">this</span>.Self.waste_chain.id,
                waste_hour = Dom.get(<span class="hljs-string">"chainWasteHourInput"</span>)
                    .value;
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.Self.service.update_waste_chain({
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                waste_chain_id: waste_chain_id,
                waste_hour: waste_hour
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.WasteChainUpdateWasteHour.success"</span>);
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                    <span class="hljs-keyword">this</span>.Self.WasteChainDetails();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        WasteChainEqualize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> waste_chain_id = <span class="hljs-keyword">this</span>.Self.waste_chain.id,
                waste_hour = Dom.get(<span class="hljs-string">"chainWasteHourInput"</span>)
                    .value,
                body_waste_hour = Game.GetCurrentPlanet()
                    .waste_hour;
            <span class="hljs-keyword">if</span> (body_waste_hour &lt;= <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span>;
            }
            waste_hour = <span class="hljs-built_in">parseInt</span>(waste_hour) + <span class="hljs-built_in">parseInt</span>(body_waste_hour);
            Dom.get(<span class="hljs-string">"chainWasteHourInput"</span>)
                .value = waste_hour;
        },
        WasteChainShipsView: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.service.get_waste_ships({
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.building.id
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.WasteChainShipsView.success"</span>);
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.rpcSuccess(o);
                    <span class="hljs-keyword">this</span>.waste_chain_ships = o.result.ships;
                    <span class="hljs-keyword">this</span>.WasteChainShipsPopulate();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        WasteChainShipsPopulate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> ships = <span class="hljs-keyword">this</span>.waste_chain_ships,
                no_ships = Dom.get(<span class="hljs-string">"wasteChainShipsNone"</span>),
                details = Dom.get(<span class="hljs-string">"wasteChainShipsDetails"</span>);
            <span class="hljs-keyword">if</span> (ships.length === <span class="hljs-number">0</span>) {
                Dom.setStyle(details, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                Dom.setStyle(no_ships, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> {
                Dom.setStyle(details, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                Dom.setStyle(no_ships, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
            }
            <span class="hljs-keyword">if</span> (details) {
                <span class="hljs-keyword">var</span> ul = document.createElement(<span class="hljs-string">"ul"</span>),
                    li = document.createElement(<span class="hljs-string">"li"</span>),
                    availShips = [],
                    workingShips = [];
                Event.purgeElement(details);
                details.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ships.length; i++) {
                    <span class="hljs-keyword">var</span> ship = ships[i],
                        nUl = ul.cloneNode(<span class="hljs-literal">false</span>),
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    <span class="hljs-keyword">if</span> (ship.task === <span class="hljs-string">"Docked"</span>) {
                        availShips.push(ship);
                    } <span class="hljs-keyword">else</span> {
                        workingShips.push(ship);
                    }
                    nUl.Ship = ship;
                    Dom.addClass(nUl, <span class="hljs-string">"shipInfo"</span>);
                    Dom.addClass(nUl, <span class="hljs-string">"clearafter"</span>);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"shipName"</span>);
                    nLi.innerHTML = ship.name;
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"shipTask"</span>);
                    nLi.innerHTML = ship.task;
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"shipSpeed"</span>);
                    nLi.innerHTML = ship.speed;
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"shipHold"</span>);
                    nLi.innerHTML = ship.hold_size;
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"shipAction"</span>);
                    <span class="hljs-keyword">var</span> bbtn = document.createElement(<span class="hljs-string">"button"</span>);
                    bbtn.setAttribute(<span class="hljs-string">"type"</span>, <span class="hljs-string">"button"</span>);
                    bbtn.innerHTML = ship.task === <span class="hljs-string">"Docked"</span> ? <span class="hljs-string">"Add to Chain"</span> : <span class="hljs-string">"Remove from Chain"</span>;
                    bbtn = nLi.appendChild(bbtn);
                    nUl.appendChild(nLi);
                    <span class="hljs-keyword">if</span> (ship.task === <span class="hljs-string">"Docked"</span>) {
                        Event.on(bbtn, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.WasteChainShipAdd, {
                            Self: <span class="hljs-keyword">this</span>,
                            Ship: ship,
                            Line: nUl
                        }, <span class="hljs-literal">true</span>);
                    } <span class="hljs-keyword">else</span> {
                        Event.on(bbtn, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.WasteChainShipRemove, {
                            Self: <span class="hljs-keyword">this</span>,
                            Ship: ship,
                            Line: nUl
                        }, <span class="hljs-literal">true</span>);
                    }
                    details.appendChild(nUl);
                }
                <span class="hljs-comment">//wait for tab to display first</span>
                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">var</span> Ht = Game.GetSize()
                        .h - <span class="hljs-number">175</span>;
                    <span class="hljs-keyword">if</span> (Ht &gt; <span class="hljs-number">300</span>) {
                        Ht = <span class="hljs-number">300</span>;
                    }
                    Dom.setStyle(details.parentNode, <span class="hljs-string">"height"</span>, Ht + <span class="hljs-string">"px"</span>);
                    Dom.setStyle(details.parentNode, <span class="hljs-string">"overflow-y"</span>, <span class="hljs-string">"auto"</span>);
                }, <span class="hljs-number">10</span>);
            }
        },
        WasteChainShipAdd: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.Self.service.add_waste_ship_to_fleet({
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                ship_id: <span class="hljs-keyword">this</span>.Ship.id
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.WasteChainShipAdd.success"</span>);
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                    <span class="hljs-keyword">var</span> ships = <span class="hljs-keyword">this</span>.Self.waste_chain_ships;
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ships.length; i++) {
                        <span class="hljs-keyword">if</span> (ships[i].id === <span class="hljs-keyword">this</span>.Ship.id) {
                            ships.splice(i, <span class="hljs-number">1</span>);
                            <span class="hljs-keyword">break</span>;
                        }
                    }
                    <span class="hljs-keyword">this</span>.Line.parentNode.removeChild(<span class="hljs-keyword">this</span>.Line);
                    <span class="hljs-keyword">this</span>.Self.WasteChainDetails();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        WasteChainShipRemove: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.Self.service.remove_waste_ship_from_fleet({
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                ship_id: <span class="hljs-keyword">this</span>.Ship.id
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"Trade.WasteChainShipRemove.success"</span>);
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                    <span class="hljs-keyword">var</span> ships = <span class="hljs-keyword">this</span>.Self.waste_chain_ships;
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ships.length; i++) {
                        <span class="hljs-keyword">if</span> (ships[i].id === <span class="hljs-keyword">this</span>.Ship.id) {
                            ships.splice(i, <span class="hljs-number">1</span>);
                            <span class="hljs-keyword">break</span>;
                        }
                    }
                    <span class="hljs-keyword">this</span>.Line.parentNode.removeChild(<span class="hljs-keyword">this</span>.Line);
                    <span class="hljs-keyword">this</span>.Self.WasteChainDetails();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        }
    });
    Lacuna.buildings.Trade = Trade;
})();</pre></div>
      
      </div>
    
    </div>
  </div>

  <script src="../../../toc.js"></script>
  <script src="../../../assets/libs.js"></script>
  <script src="../../../assets/behavior.js"></script>
</body>
</html>
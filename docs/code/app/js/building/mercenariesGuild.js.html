<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title> - mercenariesGuild.js</title>

  <link rel="stylesheet" href="../../../assets/style.css">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"/>
  <meta name="groc-relative-root" content="../../../"/>
  <meta name="groc-document-path" content="app/js/building/mercenariesGuild.js"/>
  
</head>
<body>
  <div id="file-area">
    <div id="meta">
      <code class="file-path">
      
        app/js/building/mercenariesGuild.js
      
      </code>
    </div>
    <div id="document">
    
      <div class="segment">
      
      
        <div class="code"><pre class="wrapper"><span class="hljs-pi">'use strict'</span>;
YAHOO.namespace(<span class="hljs-string">"lacuna.buildings"</span>);
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> Lang = YAHOO.lang,
        Util = YAHOO.util,
        Dom = Util.Dom,
        Event = Util.Event,
        Sel = Util.Selector,
        Pager = YAHOO.widget.Paginator,
        Lacuna = YAHOO.lacuna,
        Game = Lacuna.Game,
        Lib = Lacuna.Library;
    <span class="hljs-keyword">var</span> MercenariesGuild = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(result)</span> {</span>
        MercenariesGuild.superclass.constructor.call(<span class="hljs-keyword">this</span>, result);
        <span class="hljs-keyword">this</span>.service = Game.Services.Buildings.MercenariesGuild;
        <span class="hljs-keyword">this</span>.availableAcceptText = <span class="hljs-string">"Accept"</span>;
        <span class="hljs-keyword">var</span> cost = <span class="hljs-built_in">Math</span>.round((<span class="hljs-number">3</span> - (<span class="hljs-keyword">this</span>.building.level * <span class="hljs-number">0.1</span>)) * <span class="hljs-number">10</span>) / <span class="hljs-number">10</span>;
        <span class="hljs-keyword">this</span>.addMercenariesGuildText = [<span class="hljs-string">'Add for '</span>, cost, <span class="hljs-string">'&lt;img src="'</span>, Lib.AssetUrl, <span class="hljs-string">'ui/s/essentia.png" class="smallEssentia" style="vertical-align:middle;" /&gt;'</span>].join(<span class="hljs-string">''</span>);
        <span class="hljs-comment">//defaults.  Values are updated to server numbers during get_* calls</span>
        <span class="hljs-keyword">this</span>.spySize = <span class="hljs-number">350</span>;
        <span class="hljs-keyword">this</span>.createEvent(<span class="hljs-string">"onLoadSpies"</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.building.level &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">this</span>.subscribe(<span class="hljs-string">"onLoad"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">this</span>.getSpies();
                <span class="hljs-keyword">this</span>.mine.subscribe(<span class="hljs-string">"activeChange"</span>, <span class="hljs-keyword">this</span>.getMine, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">this</span>.avail.subscribe(<span class="hljs-string">"activeChange"</span>, <span class="hljs-keyword">this</span>.getAvailable, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">this</span>.add.subscribe(<span class="hljs-string">"activeChange"</span>, <span class="hljs-keyword">this</span>.getAddShips, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
        }
    };
    Lang.extend(MercenariesGuild, Lacuna.buildings.Building, {
        destroy: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.availablePager) {
                <span class="hljs-keyword">this</span>.availablePager.destroy();
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.minePage) {
                <span class="hljs-keyword">this</span>.minePage.destroy();
            }
            MercenariesGuild.superclass.destroy.call(<span class="hljs-keyword">this</span>);
        },
        getChildTabs: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.mineTabIndex = <span class="hljs-number">2</span>; <span class="hljs-comment">//array location plus 1 since Production tab is always first</span>
            <span class="hljs-keyword">return</span> [<span class="hljs-keyword">this</span>._getAvailTab(), <span class="hljs-keyword">this</span>._getMineTab(), <span class="hljs-keyword">this</span>._getAddTab()];
        },
        _getAvailTab: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.avail = <span class="hljs-keyword">new</span> YAHOO.widget.Tab({
                label: <span class="hljs-string">"Available Mercs"</span>,
                content: [<span class="hljs-string">'&lt;div&gt;'</span>, <span class="hljs-string">'    &lt;ul class="tradeHeader tradeInfo clearafter"&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeEmpire"&gt;Empire&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeOfferedDate"&gt;Offered Date&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeAsking"&gt;Cost&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeOffer"&gt;Offering&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeAction"&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeAction"&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;/ul&gt;'</span>, <span class="hljs-string">'    &lt;div&gt;&lt;div id="tradeAvailableDetails"&gt;&lt;/div&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;div id="tradeAvailablePaginator"&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;/div&gt;'</span>].join(<span class="hljs-string">''</span>)
            });
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.avail;
        },
        _getMineTab: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.mine = <span class="hljs-keyword">new</span> YAHOO.widget.Tab({
                label: <span class="hljs-string">"My Mercs"</span>,
                content: [<span class="hljs-string">'&lt;div class="myMercenariesGuilds"&gt;'</span>, <span class="hljs-string">'    &lt;ul class="tradeHeader tradeInfo clearafter"&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeOfferedDate"&gt;Offered Date&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeAsking"&gt;Cost&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeOffer"&gt;Offering&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li class="tradeAction"&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;/ul&gt;'</span>, <span class="hljs-string">'    &lt;div&gt;&lt;div id="tradeMineDetails"&gt;&lt;/div&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;div id="tradeMinePaginator"&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;/div&gt;'</span>].join(<span class="hljs-string">''</span>)
            });
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.mine;
        },
        _getAddTab: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.add = <span class="hljs-keyword">new</span> YAHOO.widget.Tab({
                label: <span class="hljs-string">"Add Merc"</span>,
                content: [<span class="hljs-string">'&lt;div id="aHt"&gt;'</span>, <span class="hljs-string">'&lt;ul style="margin-top:5px;"&gt;'</span>, <span class="hljs-string">'    &lt;li&gt;&lt;label&gt;Spy:&lt;/label&gt;&lt;select id="tradeAddSpyName"&gt;&lt;/select&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li style="margin: 5px 0;"&gt;&lt;label&gt;Asking Essentia:&lt;/label&gt;&lt;input type="text" id="tradeAddAskingQuantity" /&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li style="margin-bottom:5px;"&gt;&lt;label&gt;With Ship:&lt;/label&gt;&lt;select id="tradeAddShip"&gt;&lt;/select&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;li id="tradeAddMessage" class="alert"&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'&lt;/ul&gt;&lt;/div&gt;&lt;button id="tradeAdd" type="button"&gt;'</span>, <span class="hljs-keyword">this</span>.addMercenariesGuildText, <span class="hljs-string">'&lt;/button&gt;'</span>].join(<span class="hljs-string">''</span>)
            });
            <span class="hljs-keyword">this</span>.subscribe(<span class="hljs-string">"onLoadSpies"</span>, <span class="hljs-keyword">this</span>.populateAddSpyName, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            Event.on(<span class="hljs-string">"tradeAdd"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.AddMerc, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.add;
        },
        getSpies: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(force)</span> {</span>
            <span class="hljs-keyword">if</span> (force || !<span class="hljs-keyword">this</span>.spies) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.service.get_spies({
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    building_id: <span class="hljs-keyword">this</span>.building.id
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">this</span>.spies = o.result.spies;
                        <span class="hljs-keyword">this</span>.spySize = o.result.cargo_space_used_each || <span class="hljs-keyword">this</span>.spySize;
                        <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onLoadSpies"</span>);
                        Lacuna.Pulser.Hide();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        <span class="hljs-comment">//View Available</span>
        getAvailable: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (e.newValue &amp;&amp; !<span class="hljs-keyword">this</span>.availableMercs) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">var</span> data = {
                    session_id: Game.GetSession(),
                    building_id: <span class="hljs-keyword">this</span>.building.id,
                    page_number: <span class="hljs-number">1</span>
                };
                <span class="hljs-keyword">this</span>.service.view_market(data, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        Lacuna.Pulser.Hide();
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">delete</span> o.result.status; <span class="hljs-comment">//get rid of status after we process it, since it's big</span>
                        <span class="hljs-keyword">this</span>.availableMercs = o.result; <span class="hljs-comment">//store: trades=[], trade_count = 1, page_number=1,  captcha = {guid, url}</span>
                        <span class="hljs-keyword">this</span>.availablePager = <span class="hljs-keyword">new</span> Pager({
                            rowsPerPage: <span class="hljs-number">25</span>,
                            totalRecords: o.result.trade_count,
                            containers: <span class="hljs-string">'tradeAvailablePaginator'</span>,
                            template: <span class="hljs-string">"{PreviousPageLink} {PageLinks} {NextPageLink}"</span>,
                            alwaysVisible: <span class="hljs-literal">false</span>
                        });
                        <span class="hljs-keyword">this</span>.availablePager.subscribe(<span class="hljs-string">'changeRequest'</span>, <span class="hljs-keyword">this</span>.AvailableHandlePagination, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.availablePager.render();
                        <span class="hljs-keyword">this</span>.AvailablePopulate();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        AvailablePopulate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> details = Dom.get(<span class="hljs-string">"tradeAvailableDetails"</span>);
            <span class="hljs-keyword">if</span> (details) {
                <span class="hljs-keyword">var</span> trades = <span class="hljs-keyword">this</span>.availableMercs.trades,
                    ul = document.createElement(<span class="hljs-string">"ul"</span>),
                    li = document.createElement(<span class="hljs-string">"li"</span>);
                Event.purgeElement(details);
                details.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; trades.length; i++) {
                    <span class="hljs-keyword">var</span> trade = trades[i],
                        bbtn, nUl = ul.cloneNode(<span class="hljs-literal">false</span>),
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    nUl.MercenariesGuild = trade;
                    Dom.addClass(nUl, <span class="hljs-string">"tradeInfo"</span>);
                    Dom.addClass(nUl, <span class="hljs-string">"clearafter"</span>);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeEmpire"</span>);
                    nLi.innerHTML = trade.empire.name;
                    Event.on(nLi, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.EmpireProfile, trade.empire);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeOfferedDate"</span>);
                    nLi.innerHTML = Lib.formatServerDateTimeShort(trade.date_offered);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeAsking"</span>);
                    nLi.innerHTML = [trade.ask, <span class="hljs-string">'&lt;img src="'</span>, Lib.AssetUrl, <span class="hljs-string">'ui/s/essentia.png" class="smallEssentia" /&gt;'</span>].join(<span class="hljs-string">''</span>);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeOffer"</span>);
                    nLi.innerHTML = Lib.formatInlineList(trade.offer);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeAction"</span>);
                    bbtn = document.createElement(<span class="hljs-string">"button"</span>);
                    bbtn.setAttribute(<span class="hljs-string">"type"</span>, <span class="hljs-string">"button"</span>);
                    bbtn.innerHTML = <span class="hljs-keyword">this</span>.availableAcceptText;
                    bbtn = nLi.appendChild(bbtn);
                    Event.on(bbtn, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.AvailableAccept, {
                        Self: <span class="hljs-keyword">this</span>,
                        MercenariesGuild: trade,
                        Line: nUl
                    }, <span class="hljs-literal">true</span>);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeAction"</span>);
                    bbtn = document.createElement(<span class="hljs-string">"button"</span>);
                    bbtn.setAttribute(<span class="hljs-string">"type"</span>, <span class="hljs-string">"button"</span>);
                    Dom.addClass(bbtn, <span class="hljs-string">"reportAbuse"</span>);
                    bbtn.innerHTML = <span class="hljs-string">"Spam"</span>;
                    bbtn = nLi.appendChild(bbtn);
                    Event.on(bbtn, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.AvailableReport, {
                        Self: <span class="hljs-keyword">this</span>,
                        MercenariesGuild: trade,
                        Line: nUl
                    }, <span class="hljs-literal">true</span>);
                    nUl.appendChild(nLi);
                    details.appendChild(nUl);
                }
                <span class="hljs-comment">//wait for tab to display first</span>
                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">var</span> Ht = Game.GetSize()
                        .h - <span class="hljs-number">240</span>;
                    <span class="hljs-keyword">if</span> (Ht &gt; <span class="hljs-number">300</span>) {
                        Ht = <span class="hljs-number">300</span>;
                    }
                    <span class="hljs-keyword">var</span> tC = details.parentNode;
                    Dom.setStyle(tC, <span class="hljs-string">"height"</span>, Ht + <span class="hljs-string">"px"</span>);
                    Dom.setStyle(tC, <span class="hljs-string">"overflow-y"</span>, <span class="hljs-string">"auto"</span>);
                }, <span class="hljs-number">10</span>);
            }
        },
        AvailableHandlePagination: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newState)</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">var</span> data = {
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.building.id,
                page_number: newState.page
            };
            <span class="hljs-keyword">this</span>.service.view_market(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.rpcSuccess(o);
                    <span class="hljs-keyword">delete</span> o.result.status; <span class="hljs-comment">//get rid of status after we process it, since it's big</span>
                    <span class="hljs-keyword">this</span>.availableMercs = o.result; <span class="hljs-comment">//store: trades=[], trade_count = 1, page_number=1,  captcha = {guid, url}</span>
                    <span class="hljs-keyword">this</span>.AvailablePopulate();
                },
                scope: <span class="hljs-keyword">this</span>
            });</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Update the Paginator&#39;s state</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">this</span>.availablePager.setState(newState);
        },
        AvailableAccept: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">var</span> btn = Event.getTarget(e);
            btn.disabled = <span class="hljs-literal">true</span>;
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.Self.service.accept_from_market({
                session_id: Game.GetSession(<span class="hljs-string">""</span>),
                building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                trade_id: <span class="hljs-keyword">this</span>.MercenariesGuild.id
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"MercenariesGuild.accept_trade.success"</span>);
                    <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                    <span class="hljs-comment">//force get the new availabe list after accepting so we get a new captcha</span>
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.Self.availableMercs;
                    <span class="hljs-keyword">this</span>.Self.getAvailable({
                        newValue: <span class="hljs-literal">true</span>
                    });
                    Lacuna.Pulser.Hide();
                },
                failure: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    btn.disabled = <span class="hljs-literal">false</span>;
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        AvailableReport: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">var</span> btn = Event.getTarget(e);
            btn.disabled = <span class="hljs-literal">true</span>;
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.Self.service.report_abuse({
                session_id: Game.GetSession(<span class="hljs-string">""</span>),
                building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                trade_id: <span class="hljs-keyword">this</span>.MercenariesGuild.id
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    Event.purgeElement(btn);
                    btn.parentNode.removeChild(btn);
                    <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                    Lacuna.Pulser.Hide();
                },
                failure: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    btn.disabled = <span class="hljs-literal">false</span>;
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        EmpireProfile: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, empire)</span> {</span>
            Lacuna.Info.Empire.Load(empire.id);
        },
        <span class="hljs-comment">//View Mine</span>
        getMine: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (e.newValue &amp;&amp; !<span class="hljs-keyword">this</span>.mineMercs) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.service.view_my_market({
                    session_id: Game.GetSession(),
                    building_id: <span class="hljs-keyword">this</span>.building.id,
                    page_number: <span class="hljs-number">1</span>
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        Lacuna.Pulser.Hide();
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">delete</span> o.result.status; <span class="hljs-comment">//get rid of status after we process it, since it's big</span>
                        <span class="hljs-keyword">this</span>.mineMercs = o.result; <span class="hljs-comment">//store: trades=[], trade_count = 1, page_number=1</span>
                        <span class="hljs-keyword">this</span>.minePage = <span class="hljs-keyword">new</span> Pager({
                            rowsPerPage: <span class="hljs-number">25</span>,
                            totalRecords: o.result.trade_count,
                            containers: <span class="hljs-string">'tradeMinePaginator'</span>,
                            template: <span class="hljs-string">"{PreviousPageLink} {PageLinks} {NextPageLink}"</span>,
                            alwaysVisible: <span class="hljs-literal">false</span>
                        });
                        <span class="hljs-keyword">this</span>.minePage.subscribe(<span class="hljs-string">'changeRequest'</span>, <span class="hljs-keyword">this</span>.MineHandlePagination, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.minePage.render();
                        <span class="hljs-keyword">this</span>.MinePopulate();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        MinePopulate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> details = Dom.get(<span class="hljs-string">"tradeMineDetails"</span>);
            <span class="hljs-keyword">if</span> (details) {
                <span class="hljs-keyword">var</span> trades = <span class="hljs-keyword">this</span>.mineMercs.trades,
                    ul = document.createElement(<span class="hljs-string">"ul"</span>),
                    li = document.createElement(<span class="hljs-string">"li"</span>);
                Event.purgeElement(details);
                details.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; trades.length; i++) {
                    <span class="hljs-keyword">var</span> trade = trades[i],
                        nUl = ul.cloneNode(<span class="hljs-literal">false</span>),
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    nUl.Trade = trade;
                    Dom.addClass(nUl, <span class="hljs-string">"tradeInfo"</span>);
                    Dom.addClass(nUl, <span class="hljs-string">"clearafter"</span>);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeOfferedDate"</span>);
                    nLi.innerHTML = Lib.formatServerDateTimeShort(trade.date_offered);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeAsking"</span>);
                    nLi.innerHTML = [trade.ask, <span class="hljs-string">'&lt;img src="'</span>, Lib.AssetUrl, <span class="hljs-string">'ui/s/essentia.png" class="smallEssentia" /&gt;'</span>].join(<span class="hljs-string">''</span>);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeOffer"</span>);
                    nLi.innerHTML = Lib.formatInlineList(trade.offer);
                    nUl.appendChild(nLi);
                    nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    Dom.addClass(nLi, <span class="hljs-string">"tradeAction"</span>);
                    <span class="hljs-keyword">var</span> bbtn = document.createElement(<span class="hljs-string">"button"</span>);
                    bbtn.setAttribute(<span class="hljs-string">"type"</span>, <span class="hljs-string">"button"</span>);
                    bbtn.innerHTML = <span class="hljs-string">"Withdraw"</span>;
                    bbtn = nLi.appendChild(bbtn);
                    Event.on(bbtn, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.MineWithdraw, {
                        Self: <span class="hljs-keyword">this</span>,
                        Trade: trade,
                        Line: nUl
                    }, <span class="hljs-literal">true</span>);
                    nUl.appendChild(nLi);
                    details.appendChild(nUl);
                }
                <span class="hljs-comment">//wait for tab to display first</span>
                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">var</span> Ht = Game.GetSize()
                        .h - <span class="hljs-number">240</span>;
                    <span class="hljs-keyword">if</span> (Ht &gt; <span class="hljs-number">300</span>) {
                        Ht = <span class="hljs-number">300</span>;
                    }
                    <span class="hljs-keyword">var</span> tC = details.parentNode;
                    Dom.setStyle(tC, <span class="hljs-string">"height"</span>, Ht + <span class="hljs-string">"px"</span>);
                    Dom.setStyle(tC, <span class="hljs-string">"overflow-y"</span>, <span class="hljs-string">"auto"</span>);
                }, <span class="hljs-number">10</span>);
            }
        },
        MineHandlePagination: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newState)</span> {</span>
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.service.view_my_market({
                session_id: Game.GetSession(),
                building_id: <span class="hljs-keyword">this</span>.building.id,
                page_number: newState.page
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    YAHOO.log(o, <span class="hljs-string">"info"</span>, <span class="hljs-string">"MercenariesGuild.view_available_trades.success"</span>);
                    Lacuna.Pulser.Hide();
                    <span class="hljs-keyword">this</span>.rpcSuccess(o);
                    <span class="hljs-keyword">delete</span> o.result.status; <span class="hljs-comment">//get rid of status after we process it, since it's big</span>
                    <span class="hljs-keyword">this</span>.mineMercs = o.result; <span class="hljs-comment">//store: trades=[], trade_count = 1, page_number=1</span>
                    <span class="hljs-keyword">this</span>.MinePopulate();
                },
                scope: <span class="hljs-keyword">this</span>
            });</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Update the Paginator&#39;s state</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">this</span>.minePage.setState(newState);
        },
        MineWithdraw: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">var</span> btn = Event.getTarget(e);
            btn.disabled = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">if</span> (confirm([<span class="hljs-string">'Are you sure you want to withdraw the trade asking for '</span>, <span class="hljs-keyword">this</span>.Trade.ask, <span class="hljs-string">' essentia and offering '</span>, <span class="hljs-keyword">this</span>.Trade.offer, <span class="hljs-string">'?'</span>].join(<span class="hljs-string">''</span>))) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.Self.service.withdraw_from_market({
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    building_id: <span class="hljs-keyword">this</span>.Self.building.id,
                    trade_id: <span class="hljs-keyword">this</span>.Trade.id
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">this</span>.Self.rpcSuccess(o);
                        <span class="hljs-comment">//splice out removed trade</span>
                        <span class="hljs-keyword">var</span> trades = <span class="hljs-keyword">this</span>.Self.mineMercs.trades;
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; trades.length; i++) {
                            <span class="hljs-keyword">if</span> (trades[i].id === <span class="hljs-keyword">this</span>.Trade.id) {
                                trades.splice(i, <span class="hljs-number">1</span>);
                                <span class="hljs-keyword">break</span>;
                            }
                        }
                        <span class="hljs-keyword">this</span>.Line.parentNode.removeChild(<span class="hljs-keyword">this</span>.Line);
                        Lacuna.Pulser.Hide();
                        <span class="hljs-comment">//delete ships since we'll get one back on withdraw</span>
                        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.Self.tradeShips;
                        <span class="hljs-keyword">this</span>.Self.getSpies(<span class="hljs-literal">true</span>);
                    },
                    failure: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                        btn.disabled = <span class="hljs-literal">false</span>;
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            } <span class="hljs-keyword">else</span> {
                btn.disabled = <span class="hljs-literal">false</span>;
            }
        },
        <span class="hljs-comment">//Add trade</span>
        populateAddSpyName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradeAddSpyName"</span>),
                opt = document.createElement(<span class="hljs-string">"option"</span>),
                nOpt;
            <span class="hljs-keyword">if</span> (elm) {
                elm.options.length = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-keyword">this</span>.spies.length; x++) {
                    <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.spies[x];
                    nOpt = opt.cloneNode(<span class="hljs-literal">false</span>);
                    nOpt.value = obj.id;
                    nOpt.innerHTML = [obj.name, <span class="hljs-string">' - '</span>, obj.level].join(<span class="hljs-string">''</span>);
                    elm.appendChild(nOpt);
                }
            }
        },
        getAddShips: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (e.newValue &amp;&amp; !<span class="hljs-keyword">this</span>.tradeShips) {
                Lacuna.Pulser.Show();
                <span class="hljs-keyword">this</span>.service.get_trade_ships({
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    building_id: <span class="hljs-keyword">this</span>.building.id
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">this</span>.rpcSuccess(o);
                        <span class="hljs-keyword">var</span> elm = Dom.get(<span class="hljs-string">"tradeAddShip"</span>),
                            opt = document.createElement(<span class="hljs-string">"option"</span>),
                            ships = o.result.ships,
                            nOpt;
                        <span class="hljs-keyword">if</span> (elm &amp;&amp; ships) {
                            <span class="hljs-keyword">this</span>.tradeShips = ships;
                            <span class="hljs-keyword">var</span> selectedVal = Lib.getSelectedOptionValue(elm);
                            elm.options.length = <span class="hljs-number">0</span>;
                            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; ships.length; x++) {
                                <span class="hljs-keyword">var</span> obj = ships[x];
                                nOpt = opt.cloneNode(<span class="hljs-literal">false</span>);
                                nOpt.value = obj.id;
                                nOpt.innerHTML = [obj.name, <span class="hljs-string">' ('</span>, obj.type_human, <span class="hljs-string">' - Hold:'</span>, obj.hold_size, <span class="hljs-string">' - Speed:'</span>, obj.speed, <span class="hljs-string">')'</span>].join(<span class="hljs-string">''</span>);
                                nOpt.selected = (selectedVal === obj.id);
                                elm.appendChild(nOpt);
                            }
                        }
                        Lacuna.Pulser.Hide();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        updateAddCargo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(byVal)</span> {</span>
            <span class="hljs-keyword">var</span> c = Dom.get(<span class="hljs-string">"tradeAddCargo"</span>),
                cv = c.innerHTML * <span class="hljs-number">1</span>;
            c.innerHTML = cv + byVal;
        },
        AddMerc: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">var</span> qVal = Dom.get(<span class="hljs-string">"tradeAddAskingQuantity"</span>)
                .value * <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (!Lang.isNumber(qVal) || qVal &lt;= <span class="hljs-number">0</span>) {
                Dom.get(<span class="hljs-string">"tradeAddMessage"</span>)
                    .innerHTML = <span class="hljs-string">"Quantity of asking essentia must be a number and greater than 0"</span>;
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> {
                Dom.get(<span class="hljs-string">"tradeAddMessage"</span>)
                    .innerHTML = <span class="hljs-string">""</span>;
            }
            <span class="hljs-keyword">var</span> btn = Event.getTarget(e);
            btn.disabled = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">var</span> data = {
                session_id: Game.GetSession(<span class="hljs-string">""</span>),
                building_id: <span class="hljs-keyword">this</span>.building.id,
                spy_id: Lib.getSelectedOptionValue(<span class="hljs-string">"tradeAddSpyName"</span>),
                ask: qVal,
                ship_id: Lib.getSelectedOptionValue(<span class="hljs-string">"tradeAddShip"</span>)
            };
            Lacuna.Pulser.Show();
            <span class="hljs-keyword">this</span>.service.add_to_market(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">this</span>.rpcSuccess(o);
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.tradeShips;
                    <span class="hljs-keyword">this</span>.getSpies(<span class="hljs-literal">true</span>);
                    Dom.get(<span class="hljs-string">"tradeAddAskingQuantity"</span>)
                        .value = <span class="hljs-string">""</span>;
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.mineMercs;
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onSelectTab"</span>, <span class="hljs-keyword">this</span>.mineTabIndex);
                    btn.disabled = <span class="hljs-literal">false</span>;
                    Lacuna.Pulser.Hide();
                },
                failure: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    btn.disabled = <span class="hljs-literal">false</span>;
                },
                scope: <span class="hljs-keyword">this</span>
            });
        }
    });
    Lacuna.buildings.MercenariesGuild = MercenariesGuild;
})();</pre></div>
      
      </div>
    
    </div>
  </div>

  <script src="../../../toc.js"></script>
  <script src="../../../assets/libs.js"></script>
  <script src="../../../assets/behavior.js"></script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title> - messaging.js</title>

  <link rel="stylesheet" href="../../assets/style.css">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"/>
  <meta name="groc-relative-root" content="../../"/>
  <meta name="groc-document-path" content="app/js/messaging.js"/>
  
</head>
<body>
  <div id="file-area">
    <div id="meta">
      <code class="file-path">
      
        app/js/messaging.js
      
      </code>
    </div>
    <div id="document">
    
      <div class="segment">
      
      
        <div class="code"><pre class="wrapper"><span class="hljs-pi">'use strict'</span>;
YAHOO.namespace(<span class="hljs-string">"lacuna"</span>);
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> Lang = YAHOO.lang,
        Util = YAHOO.util,
        Dom = Util.Dom,
        Event = Util.Event,
        Pager = YAHOO.widget.Paginator,
        Sel = Util.Selector,
        Lacuna = YAHOO.lacuna,
        Game = Lacuna.Game,
        Lib = Lacuna.Library;
    <span class="hljs-keyword">var</span> Messaging = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">this</span>.createEvent(<span class="hljs-string">"onRpc"</span>);
        <span class="hljs-keyword">this</span>.createEvent(<span class="hljs-string">"onShow"</span>);
        <span class="hljs-keyword">this</span>.createEvent(<span class="hljs-string">"onPageLoaded"</span>);
        <span class="hljs-keyword">this</span>._buildPanel();
        <span class="hljs-keyword">this</span>._buildAttachmentPanel();
    };
    Messaging.prototype = {
        _buildPanel: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> panelId = <span class="hljs-string">"messagingPanel"</span>;
            <span class="hljs-keyword">var</span> panel = document.createElement(<span class="hljs-string">"div"</span>);
            panel.id = panelId;
            panel.innerHTML = [<span class="hljs-string">'&lt;div class="hd"&gt;Messaging&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;div class="bd"&gt;'</span>, <span class="hljs-string">'    &lt;div id="messagingTabs" class="yui-navset"&gt;&lt;ul class="yui-nav"&gt;'</span>, <span class="hljs-string">'        &lt;li id="messagingCreate" class="tab"&gt;&lt;a href="#"&gt;&lt;em&gt;Create&lt;/em&gt;&lt;/a&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li id="messagingInbox" class="tab"&gt;&lt;a href="#"&gt;&lt;em&gt;Inbox&lt;/em&gt;&lt;/a&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li id="messagingSent" class="tab"&gt;&lt;a href="#"&gt;&lt;em&gt;Sent&lt;/em&gt;&lt;/a&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li id="messagingArchive" class="tab"&gt;&lt;a href="#"&gt;&lt;em&gt;Archive&lt;/em&gt;&lt;/a&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li id="messagingTrash" class="tab"&gt;&lt;a href="#"&gt;&lt;em&gt;Trash&lt;/em&gt;&lt;/a&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'        &lt;li id="messagingAnnounce" class="tab"&gt;&lt;a href="#"&gt;&lt;em&gt;Announcement&lt;/em&gt;&lt;/a&gt;&lt;/li&gt;'</span>, <span class="hljs-string">'    &lt;/ul&gt;'</span>, <span class="hljs-string">'    &lt;div class="yui-content"&gt;'</span>, <span class="hljs-string">'        &lt;div id="messagingCreator" class="panelTabContainer" style="display:none"&gt;'</span>, <span class="hljs-string">'            &lt;div class="messagingCreatorC"&gt;&lt;label&gt;&lt;button id="messagingCreateSend" type="button"&gt;Send&lt;/button&gt;&lt;/label&gt;&lt;span id="messagingCreateResponse"&gt;&lt;/span&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'            &lt;div class="messagingCreatorC"&gt;&lt;label&gt;To:&lt;/label&gt;&lt;input id="messagingCreateTo" type="text" /&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'            &lt;div class="messagingCreatorC"&gt;&lt;label&gt;Subject:&lt;/label&gt;&lt;input id="messagingCreateSubject" type="text" /&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'            &lt;div class="messagingCreatorC" id="messagingCreateBody"&gt;'</span>, <span class="hljs-string">'                &lt;textarea id="messagingCreateText" cols="80" rows="20"&gt;&lt;/textarea&gt;'</span>, <span class="hljs-string">'            &lt;/div&gt;'</span>, <span class="hljs-string">'        &lt;/div&gt;'</span>, <span class="hljs-string">'        &lt;div id="messagingReader" class="panelTabContainer yui-gd"&gt;'</span>, <span class="hljs-string">'            &lt;div id="messagingArchiver"&gt;'</span>, <span class="hljs-string">'                &lt;button id="messagingArchiveSelected" type="button"&gt;Archive&lt;/button&gt;'</span>, <span class="hljs-string">'                &lt;button id="messagingTrashSelected" type="button"&gt;Trash&lt;/button&gt;'</span>, <span class="hljs-string">'                &lt;button id="messagingSelectAll" type="button"&gt;Select All&lt;/button&gt;'</span>, <span class="hljs-string">'                &lt;select id="inboxTag"&gt;'</span>, <span class="hljs-string">'                    &lt;option value=""&gt;Inbox&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Correspondence"&gt;Correspondence&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Alert"&gt;Alerts&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Intelligence"&gt;Intel&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Attack"&gt;Attacks&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Colonization"&gt;Colonization&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Complaint"&gt;Complaints&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Excavator"&gt;Excavators&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Fissure"&gt;Fissure&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Mission"&gt;Mission&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Parliament"&gt;Parliament&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Probe"&gt;Probe&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Spies"&gt;Spies&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Trade"&gt;Trade&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Medal"&gt;Medals&lt;/option&gt;'</span>, <span class="hljs-string">'                    &lt;option value="Tutorial"&gt;Tutorial&lt;/option&gt;'</span>, <span class="hljs-string">'                &lt;/select&gt;'</span>, <span class="hljs-string">'            &lt;/div&gt;'</span>, <span class="hljs-string">'            &lt;div id="mHt" class="yui-u first" style="width:36%;overflow-y: auto;border-right: 1px solid gray;position:relative;" &gt;'</span>, <span class="hljs-string">'                &lt;div id="messagingPaginator"&gt;'</span>, <span class="hljs-string">'                &lt;/div&gt;'</span>, <span class="hljs-string">'                &lt;ul id="messagingList"&gt;&lt;/ul&gt;'</span>, <span class="hljs-string">'            &lt;/div&gt;'</span>, <span class="hljs-string">'            &lt;div id="messagingDisplay" class="yui-u" style="width:62%;"&gt;'</span>, <span class="hljs-string">'                &lt;div id="messagingActions" style="border-width: 1px;"&gt;'</span>, <span class="hljs-string">'                    &lt;span id="messagingReplyC" style="display:none"&gt;&lt;button id="messagingReply" type="button"&gt;Reply&lt;/button&gt;&lt;button id="messagingReplyAll" type="button"&gt;Reply All&lt;/button&gt;&lt;/span&gt;'</span>, <span class="hljs-string">'                    &lt;button id="messagingForward" type="button"&gt;Forward&lt;/button&gt;'</span>, <span class="hljs-string">'                    &lt;button id="messagingArchiveDisplayed" type="button"&gt;Archive&lt;/button&gt;'</span>, <span class="hljs-string">'                    &lt;button id="messagingTrashDisplayed" type="button"&gt;Trash&lt;/button&gt;'</span>, <span class="hljs-string">'                &lt;/div&gt;'</span>, <span class="hljs-string">'                &lt;div id="dHt" style="overflow:auto;"&gt;'</span>, <span class="hljs-string">'                    &lt;div&gt;&lt;label&gt;Received:&lt;/label&gt;&lt;span id="messagingTimestamp"&gt;&lt;/span&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'                    &lt;div&gt;&lt;label&gt;From:&lt;/label&gt;&lt;span id="messagingFrom"&gt;&lt;/span&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'                    &lt;div&gt;&lt;label&gt;To:&lt;/label&gt;&lt;span id="messagingTo"&gt;&lt;/span&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'                    &lt;div&gt;&lt;label&gt;Subject:&lt;/label&gt;&lt;span id="messagingSubject"&gt;&lt;/span&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'                    &lt;div id="messagingBody"&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'                &lt;/div&gt;'</span>, <span class="hljs-string">'            &lt;/div&gt;'</span>, <span class="hljs-string">'        &lt;/div&gt;'</span>, <span class="hljs-string">'        &lt;div id="messagingAnnouncement" class="panelTabContainer" style="display:none"&gt;'</span>, <span class="hljs-string">'            &lt;iframe id="messagingAnnounceFrame" style="width:100%;height:300px;background-color:white;border:0;" src=""&gt;&lt;/iframe&gt;'</span>, <span class="hljs-string">'        &lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;/div&gt;'</span>, <span class="hljs-string">'&lt;/div&gt;'</span>].join(<span class="hljs-string">''</span>);
            document.body.insertBefore(panel, document.body.firstChild);
            Dom.addClass(panel, <span class="hljs-string">"nofooter"</span>);
            <span class="hljs-keyword">this</span>.messagingPanel = <span class="hljs-keyword">new</span> YAHOO.widget.Panel(panelId, {
                constraintoviewport: <span class="hljs-literal">true</span>,
                visible: <span class="hljs-literal">false</span>,
                draggable: <span class="hljs-literal">true</span>,
                effect: Game.GetContainerEffect(),
                fixedcenter: <span class="hljs-literal">true</span>,
                modal: <span class="hljs-literal">true</span>,
                close: <span class="hljs-literal">true</span>,
                underlay: <span class="hljs-literal">false</span>,
                width: <span class="hljs-string">"700px"</span>,
                zIndex: <span class="hljs-number">9999</span>
            });
            <span class="hljs-keyword">this</span>.messagingPanel.renderEvent.subscribe(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-comment">//tabs</span>
                <span class="hljs-keyword">this</span>.create = Dom.get(<span class="hljs-string">"messagingCreate"</span>);
                <span class="hljs-keyword">this</span>.inbox = Dom.get(<span class="hljs-string">"messagingInbox"</span>);
                <span class="hljs-keyword">this</span>.inboxTag = Dom.get(<span class="hljs-string">"inboxTag"</span>);
                <span class="hljs-keyword">this</span>.tag = <span class="hljs-keyword">this</span>.inboxTag.options[<span class="hljs-keyword">this</span>.inboxTag.selectedIndex].value;
                Event.on(<span class="hljs-string">"inboxTag"</span>, <span class="hljs-string">"change"</span>, <span class="hljs-keyword">this</span>.updateTag, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">this</span>.sent = Dom.get(<span class="hljs-string">"messagingSent"</span>);
                <span class="hljs-keyword">this</span>.archive = Dom.get(<span class="hljs-string">"messagingArchive"</span>);
                <span class="hljs-keyword">this</span>.trash = Dom.get(<span class="hljs-string">"messagingTrash"</span>);
                <span class="hljs-keyword">this</span>.announce = Dom.get(<span class="hljs-string">"messagingAnnounce"</span>);
                <span class="hljs-comment">//list and display view</span>
                Event.on(<span class="hljs-string">"messagingReply"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.replyMessage, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                Event.on(<span class="hljs-string">"messagingReplyAll"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.replyAllMessage, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                Event.on(<span class="hljs-string">"messagingForward"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.forwardMessage, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                Event.on(<span class="hljs-string">"messagingArchiveDisplayed"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.archiveMessage, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                Event.on(<span class="hljs-string">"messagingTrashDisplayed"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.trashMessage, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">this</span>.list = Dom.get(<span class="hljs-string">"messagingList"</span>);
                <span class="hljs-keyword">this</span>.timestamp = Dom.get(<span class="hljs-string">"messagingTimestamp"</span>);
                <span class="hljs-keyword">this</span>.from = Dom.get(<span class="hljs-string">"messagingFrom"</span>);
                <span class="hljs-keyword">this</span>.to = Dom.get(<span class="hljs-string">"messagingTo"</span>);
                <span class="hljs-keyword">this</span>.subject = Dom.get(<span class="hljs-string">"messagingSubject"</span>);
                <span class="hljs-keyword">this</span>.body = Dom.get(<span class="hljs-string">"messagingBody"</span>);
                <span class="hljs-keyword">this</span>.display = Dom.get(<span class="hljs-string">"messagingDisplay"</span>);
                Event.delegate(<span class="hljs-keyword">this</span>.display, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.handleProfileLink, <span class="hljs-string">"a.profile_link"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                Event.delegate(<span class="hljs-keyword">this</span>.display, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.handleStarmapLink, <span class="hljs-string">"a.starmap_link"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                Event.delegate(<span class="hljs-keyword">this</span>.display, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.handlePlanetLink, <span class="hljs-string">"a.planet_link"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                Event.delegate(<span class="hljs-keyword">this</span>.display, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.handleAllianceLink, <span class="hljs-string">"a.alliance_link"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                Event.delegate(<span class="hljs-keyword">this</span>.display, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.handleVoteYesLink, <span class="hljs-string">"a.voteyes_link"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                Event.delegate(<span class="hljs-keyword">this</span>.display, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.handleVoteNoLink, <span class="hljs-string">"a.voteno_link"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                <span class="hljs-comment">//archiving setup</span>
                <span class="hljs-keyword">this</span>.archiver = Dom.get(<span class="hljs-string">"messagingArchiver"</span>);
                <span class="hljs-keyword">this</span>.archiveButton = Dom.get(<span class="hljs-string">"messagingArchiveSelected"</span>);
                Event.on(<span class="hljs-keyword">this</span>.archiveButton, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.archiveMessages, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">this</span>.trashButton = Dom.get(<span class="hljs-string">"messagingTrashSelected"</span>);
                Event.on(<span class="hljs-keyword">this</span>.trashButton, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.trashMessages, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">this</span>.select = Dom.get(<span class="hljs-string">"messagingSelectAll"</span>);
                Event.on(<span class="hljs-keyword">this</span>.select, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.selectAllMessages, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                <span class="hljs-comment">//create</span>
                <span class="hljs-keyword">this</span>._createToSelect();
                <span class="hljs-comment">//this.createTo = Dom.get("messagingCreateTo");</span>
                <span class="hljs-keyword">this</span>.createSubject = Dom.get(<span class="hljs-string">"messagingCreateSubject"</span>);
                <span class="hljs-keyword">this</span>.createText = Dom.get(<span class="hljs-string">"messagingCreateText"</span>);
                <span class="hljs-keyword">this</span>.createResponse = Dom.get(<span class="hljs-string">"messagingCreateResponse"</span>);
                Event.on(<span class="hljs-string">"messagingCreateSend"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.sendMessage, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                <span class="hljs-comment">//set start display</span>
                Dom.setStyle(<span class="hljs-keyword">this</span>.display, <span class="hljs-string">"visibility"</span>, <span class="hljs-string">"hidden"</span>);
                Event.delegate(<span class="hljs-string">"messagingTabs"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.tabClick, <span class="hljs-string">"li.tab"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">this</span>.messagingPanel.hideEvent.subscribe(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">this</span>.attachmentPanel.hide();
            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">this</span>.messagingPanel.render();
            Game.OverlayManager.register(<span class="hljs-keyword">this</span>.messagingPanel);
        },
        _buildAttachmentPanel: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> panelId = <span class="hljs-string">"attachmentPanel"</span>;
            <span class="hljs-keyword">var</span> panel = document.createElement(<span class="hljs-string">"div"</span>);
            panel.id = panelId;
            panel.innerHTML = [<span class="hljs-string">'&lt;div class="hd"&gt;Map&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;div class="bd" style="height:550px;overflow:auto;"&gt;'</span>, <span class="hljs-string">'    &lt;div id="attachmentMap"&gt;'</span>, <span class="hljs-string">'    &lt;/div&gt;'</span>, <span class="hljs-string">'&lt;/div&gt;'</span>].join(<span class="hljs-string">''</span>);
            document.body.insertBefore(panel, document.body.firstChild);
            Dom.addClass(panel, <span class="hljs-string">"nofooter"</span>);
            <span class="hljs-keyword">this</span>.attachmentPanel = <span class="hljs-keyword">new</span> YAHOO.widget.Panel(panelId, {
                constraintoviewport: <span class="hljs-literal">true</span>,
                visible: <span class="hljs-literal">false</span>,
                draggable: <span class="hljs-literal">true</span>,
                effect: Game.GetContainerEffect(),
                fixedcenter: <span class="hljs-literal">true</span>,
                modal: <span class="hljs-literal">true</span>,
                close: <span class="hljs-literal">true</span>,
                underlay: <span class="hljs-literal">false</span>,
                width: <span class="hljs-string">"575px"</span>,
                zIndex: <span class="hljs-number">10000</span>
            });
            <span class="hljs-keyword">this</span>.attachmentPanel.renderEvent.subscribe(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">this</span>.map = Dom.get(<span class="hljs-string">"attachmentMap"</span>);
            });
            <span class="hljs-keyword">this</span>.attachmentPanel.hideEvent.subscribe(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">this</span>.map.innerHTML = <span class="hljs-string">""</span>;
            });
            <span class="hljs-keyword">this</span>.attachmentPanel.load = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(map)</span> {</span>
                <span class="hljs-keyword">this</span>.map.innerHTML = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">if</span> (map) {
                    Dom.setStyle(<span class="hljs-keyword">this</span>.map, <span class="hljs-string">"background"</span>, [<span class="hljs-string">'url("'</span>, Lib.AssetUrl, <span class="hljs-string">'planet_side/'</span>, (map.surface || map.surface_image), <span class="hljs-string">'.jpg") repeat scroll 0 0 black'</span>].join(<span class="hljs-string">''</span>));
                    <span class="hljs-keyword">var</span> tiles = {},
                        tbody = [];
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> t = <span class="hljs-number">0</span>; t &lt; map.buildings.length; t++) {
                        <span class="hljs-keyword">var</span> b = map.buildings[t];
                        <span class="hljs-keyword">if</span> (!tiles[b.y]) {
                            tiles[b.y] = {};
                        }
                        tiles[b.y][b.x] = b.image;
                    }
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">5</span>; x &gt;= -<span class="hljs-number">5</span>; x--) {
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = -<span class="hljs-number">5</span>; y &lt;= <span class="hljs-number">5</span>; y++) {
                            tbody.push(<span class="hljs-string">'&lt;div class="attachmentMapTile"&gt;'</span>);
                            <span class="hljs-keyword">if</span> (tiles[x] &amp;&amp; tiles[x][y]) {
                                tbody.push([<span class="hljs-string">'&lt;img src="'</span>, Lib.AssetUrl, <span class="hljs-string">'planet_side/50/'</span>, tiles[x][y], <span class="hljs-string">'.png" style="width:50px;height:50px;" /&gt;'</span>].join(<span class="hljs-string">''</span>));
                            }
                            tbody.push(<span class="hljs-string">'&lt;/div&gt;'</span>);
                        }
                    }
                    <span class="hljs-keyword">this</span>.map.innerHTML = tbody.join(<span class="hljs-string">''</span>);
                    <span class="hljs-keyword">this</span>.show();
                }
            };
            <span class="hljs-keyword">this</span>.attachmentPanel.render();
            Game.OverlayManager.register(<span class="hljs-keyword">this</span>.attachmentPanel);
        },
        _createToSelect: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> dataSource = <span class="hljs-keyword">new</span> Util.XHRDataSource(<span class="hljs-string">"/empire"</span>);
            dataSource.connMethodPost = <span class="hljs-string">"POST"</span>;
            dataSource.maxCacheEntries = <span class="hljs-number">2</span>;
            dataSource.responseType = YAHOO.util.XHRDataSource.TYPE_JSON;
            dataSource.responseSchema = {
                resultsList: <span class="hljs-string">"result.empires"</span>,
                fields: [<span class="hljs-string">"name"</span>, <span class="hljs-string">"id"</span>]
            };
            <span class="hljs-keyword">var</span> oTextboxList = <span class="hljs-keyword">new</span> YAHOO.lacuna.TextboxList(<span class="hljs-string">"messagingCreateTo"</span>, dataSource, { <span class="hljs-comment">//config options</span>
                maxResultsDisplayed: <span class="hljs-number">10</span>,
                minQueryLength: <span class="hljs-number">3</span>,
                multiSelect: <span class="hljs-literal">true</span>,
                forceSelection: <span class="hljs-literal">true</span>,
                formatResultLabelKey: <span class="hljs-string">"name"</span>,
                formatResultColumnKeys: [<span class="hljs-string">"name"</span>],
                useIndicator: <span class="hljs-literal">true</span>
            });
            oTextboxList.generateRequest = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(sQuery)</span> {</span>
                <span class="hljs-keyword">var</span> s = Lang.JSON.stringify({
                    <span class="hljs-string">"id"</span>: YAHOO.rpc.Service._requestId++,
                    <span class="hljs-string">"method"</span>: <span class="hljs-string">"find"</span>,
                    <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
                    <span class="hljs-string">"params"</span>: [
                        Game.GetSession(<span class="hljs-string">""</span>),
                        <span class="hljs-built_in">decodeURIComponent</span>(sQuery)
                    ]
                });
                <span class="hljs-keyword">return</span> s;
            };
            oTextboxList.doBeforeLoadData = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(sQuery, oResponse, oPayload)</span> {</span>
                <span class="hljs-keyword">var</span> tq = <span class="hljs-built_in">decodeURIComponent</span>(sQuery);
                <span class="hljs-keyword">if</span> (tq[<span class="hljs-number">0</span>] === <span class="hljs-string">"@"</span>) {
                    <span class="hljs-keyword">if</span> (tq[<span class="hljs-number">1</span>].toLowerCase() === <span class="hljs-string">"a"</span>) {
                        oResponse.results.push({
                            name: <span class="hljs-string">"@ally"</span>
                        });
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            };
            <span class="hljs-keyword">this</span>.createTo = oTextboxList;
        },
        _setTab: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(el)</span> {</span>
            <span class="hljs-keyword">var</span> list = <span class="hljs-keyword">this</span>.list;
            Event.purgeElement(list, <span class="hljs-literal">true</span>);
            list.innerHTML = <span class="hljs-string">""</span>;
            Dom.removeClass([<span class="hljs-keyword">this</span>.create, <span class="hljs-keyword">this</span>.inbox, <span class="hljs-keyword">this</span>.alerts, <span class="hljs-keyword">this</span>.intel, <span class="hljs-keyword">this</span>.medals, <span class="hljs-keyword">this</span>.tutorial, <span class="hljs-keyword">this</span>.sent, <span class="hljs-keyword">this</span>.archive, <span class="hljs-keyword">this</span>.trash, <span class="hljs-keyword">this</span>.announce], <span class="hljs-string">"selected"</span>);
            Dom.addClass(el, <span class="hljs-string">"selected"</span>);
            <span class="hljs-keyword">switch</span> (el.id) {
            <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.create.id:
                Dom.setStyle(<span class="hljs-string">"messagingCreator"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                Dom.setStyle(<span class="hljs-string">"messagingReader"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                Dom.setStyle(<span class="hljs-string">"messagingAnnouncement"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.announce.id:
                Dom.setStyle(<span class="hljs-string">"messagingCreator"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                Dom.setStyle(<span class="hljs-string">"messagingReader"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                Dom.setStyle(<span class="hljs-string">"messagingAnnouncement"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                Dom.get(<span class="hljs-string">"messagingAnnounceFrame"</span>)
                    .src = <span class="hljs-string">'/announcement?session_id='</span> + Game.GetSession();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">this</span>.viewingMessage = <span class="hljs-literal">null</span>;
                Dom.setStyle(<span class="hljs-string">"messagingCreator"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                Dom.setStyle(<span class="hljs-string">"messagingReader"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                Dom.setStyle(<span class="hljs-string">"messagingAnnouncement"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                <span class="hljs-keyword">break</span>;
            }
            Dom.setStyle(<span class="hljs-keyword">this</span>.display, <span class="hljs-string">"visibility"</span>, <span class="hljs-string">"hidden"</span>);
            <span class="hljs-keyword">this</span>.toArchive = {};
            <span class="hljs-keyword">this</span>.toArchiveCount = <span class="hljs-number">0</span>;
        },
        tabClick: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> id = matchedEl.id;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentTab !== id) {
                <span class="hljs-keyword">this</span>.viewingMessage = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">this</span>.currentTab = id;
                <span class="hljs-keyword">this</span>.loadTab();
            }
        },
        loadTab: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(isAll)</span> {</span>
            <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>.currentTab) {
            <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.create.id:
                Dom.setStyle(<span class="hljs-keyword">this</span>.archiver, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                <span class="hljs-keyword">this</span>.loadCreate(isAll);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.announce.id:
                <span class="hljs-keyword">this</span>._setTab(<span class="hljs-keyword">this</span>.announce);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.sent.id:
                Dom.setStyle(<span class="hljs-keyword">this</span>.archiver, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                <span class="hljs-keyword">this</span>.loadSentMessages();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.archive.id:
                Dom.setStyle(<span class="hljs-keyword">this</span>.archiver, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.archiveButton, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.trashButton, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.inboxTag, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                <span class="hljs-keyword">this</span>.loadArchiveMessages();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.trash.id:
                Dom.setStyle(<span class="hljs-keyword">this</span>.archiver, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.archiveButton, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.trashButton, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.inboxTag, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                <span class="hljs-keyword">this</span>.loadTrashMessages();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                Dom.setStyle(<span class="hljs-keyword">this</span>.archiver, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.archiveButton, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.trashButton, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.inboxTag, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                <span class="hljs-keyword">this</span>.loadInboxMessages();
                <span class="hljs-keyword">break</span>;
            }
        },
        loadCreate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(isAll)</span> {</span>
            <span class="hljs-keyword">this</span>.createResponse.innerHTML = <span class="hljs-string">""</span>;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.viewingMessage) {
                <span class="hljs-keyword">if</span> (isAll) {
                    <span class="hljs-keyword">var</span> to = [{
                        name: <span class="hljs-keyword">this</span>.viewingMessage.from
                    }];
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.viewingMessage.recipients.length; i++) {
                        <span class="hljs-keyword">var</span> nm = <span class="hljs-keyword">this</span>.viewingMessage.recipients[i];
                        <span class="hljs-keyword">if</span> (nm !== Game.EmpireData.name) {
                            to.push({
                                name: nm
                            });
                        }
                    }
                    <span class="hljs-keyword">this</span>.createTo.SelectItems(to);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">this</span>.createTo.SelectItems([{
                        name: <span class="hljs-keyword">this</span>.viewingMessage.from
                    }]);
                }
                <span class="hljs-keyword">this</span>.createSubject.value = (<span class="hljs-keyword">this</span>.viewingMessage.forwarding ? <span class="hljs-string">"Fwd: "</span> : <span class="hljs-string">"Re: "</span>) + <span class="hljs-keyword">this</span>.viewingMessage.subject;
                <span class="hljs-keyword">this</span>.createText.value = <span class="hljs-string">"\n\n--------------\nOn "</span> + Lib.formatServerDate(<span class="hljs-keyword">this</span>.viewingMessage.date) + <span class="hljs-string">" "</span> + <span class="hljs-keyword">this</span>.viewingMessage.from + <span class="hljs-string">" wrote:\n"</span> + <span class="hljs-keyword">this</span>.viewingMessage.body;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.createTo.ResetSelections();
                <span class="hljs-keyword">this</span>.createSubject.value = <span class="hljs-string">""</span>;
                <span class="hljs-keyword">this</span>.createText.value = <span class="hljs-string">""</span>;
            }
            <span class="hljs-keyword">this</span>._setTab(<span class="hljs-keyword">this</span>.create);
        },
        updateTag: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.tag = <span class="hljs-keyword">this</span>.inboxTag.options[<span class="hljs-keyword">this</span>.inboxTag.selectedIndex].value;
            <span class="hljs-keyword">this</span>.loadInboxMessages();
        },
        loadInboxMessages: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>._setTab(<span class="hljs-keyword">this</span>.inbox);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pager) {
                <span class="hljs-keyword">this</span>.pager.destroy();
            }
            <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                data = {
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    options: {
                        page_number: <span class="hljs-number">1</span>
                    }
                };
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tag) {
                data.options.tags = [<span class="hljs-keyword">this</span>.tag];
            }
            Lacuna.Pulser.Show();
            InboxServ.view_inbox(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                    <span class="hljs-keyword">if</span> (o.result.message_count &gt; <span class="hljs-number">25</span>) {
                        <span class="hljs-keyword">this</span>.pager = <span class="hljs-keyword">new</span> Pager({
                            rowsPerPage: <span class="hljs-number">25</span>,
                            totalRecords: o.result.message_count,
                            containers: <span class="hljs-string">'messagingPaginator'</span>,
                            template: <span class="hljs-string">"{PreviousPageLink} {PageLinks} {NextPageLink}"</span>,
                            pageLinks: <span class="hljs-number">5</span>,
                            alwaysVisible: <span class="hljs-literal">false</span>
                        });
                        <span class="hljs-keyword">this</span>.pager.subscribe(<span class="hljs-string">'changeRequest'</span>, <span class="hljs-keyword">this</span>.handleInboxPagination, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.pager.render();
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.pager;
                    }
                    <span class="hljs-keyword">this</span>.processMessages(o.result, {
                        inbox: <span class="hljs-number">1</span>
                    });
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onPageLoaded"</span>, o);
                    Lacuna.Pulser.Hide();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        loadSentMessages: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>._setTab(<span class="hljs-keyword">this</span>.sent);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pager) {
                <span class="hljs-keyword">this</span>.pager.destroy();
            }
            <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                data = {
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    options: {
                        page_number: <span class="hljs-number">1</span>
                    }
                };
            Lacuna.Pulser.Show();
            InboxServ.view_sent(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                    <span class="hljs-keyword">if</span> (o.result.message_count &gt; <span class="hljs-number">25</span>) {
                        <span class="hljs-keyword">this</span>.pager = <span class="hljs-keyword">new</span> Pager({
                            rowsPerPage: <span class="hljs-number">25</span>,
                            totalRecords: o.result.message_count,
                            containers: <span class="hljs-string">'messagingPaginator'</span>,
                            template: <span class="hljs-string">"{PreviousPageLink} {PageLinks} {NextPageLink}"</span>,
                            alwaysVisible: <span class="hljs-literal">false</span>
                        });
                        <span class="hljs-keyword">this</span>.pager.subscribe(<span class="hljs-string">'changeRequest'</span>, <span class="hljs-keyword">this</span>.handleSentPagination, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.pager.render();
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.pager;
                    }
                    <span class="hljs-keyword">this</span>.processMessages(o.result, {
                        sent: <span class="hljs-number">1</span>
                    });
                    Lacuna.Pulser.Hide();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        loadArchiveMessages: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>._setTab(<span class="hljs-keyword">this</span>.archive);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pager) {
                <span class="hljs-keyword">this</span>.pager.destroy();
            }
            <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                data = {
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    options: {
                        page_number: <span class="hljs-number">1</span>
                    }
                };
            Lacuna.Pulser.Show();
            InboxServ.view_archived(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                    <span class="hljs-keyword">if</span> (o.result.message_count &gt; <span class="hljs-number">25</span>) {
                        <span class="hljs-keyword">this</span>.pager = <span class="hljs-keyword">new</span> Pager({
                            rowsPerPage: <span class="hljs-number">25</span>,
                            totalRecords: o.result.message_count,
                            containers: <span class="hljs-string">'messagingPaginator'</span>,
                            template: <span class="hljs-string">"{PreviousPageLink} {PageLinks} {NextPageLink}"</span>,
                            alwaysVisible: <span class="hljs-literal">false</span>
                        });
                        <span class="hljs-keyword">this</span>.pager.subscribe(<span class="hljs-string">'changeRequest'</span>, <span class="hljs-keyword">this</span>.handleArchivePagination, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.pager.render();
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.pager;
                    }
                    <span class="hljs-keyword">this</span>.processMessages(o.result, {
                        archive: <span class="hljs-number">1</span>
                    });
                    Lacuna.Pulser.Hide();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        loadTrashMessages: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>._setTab(<span class="hljs-keyword">this</span>.trash);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pager) {
                <span class="hljs-keyword">this</span>.pager.destroy();
            }
            <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                data = {
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    options: {
                        page_number: <span class="hljs-number">1</span>
                    }
                };
            Lacuna.Pulser.Show();
            InboxServ.view_trashed(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                    <span class="hljs-keyword">if</span> (o.result.message_count &gt; <span class="hljs-number">25</span>) {
                        <span class="hljs-keyword">this</span>.pager = <span class="hljs-keyword">new</span> Pager({
                            rowsPerPage: <span class="hljs-number">25</span>,
                            totalRecords: o.result.message_count,
                            containers: <span class="hljs-string">'messagingPaginator'</span>,
                            template: <span class="hljs-string">"{PreviousPageLink} {PageLinks} {NextPageLink}"</span>,
                            alwaysVisible: <span class="hljs-literal">false</span>
                        });
                        <span class="hljs-keyword">this</span>.pager.subscribe(<span class="hljs-string">'changeRequest'</span>, <span class="hljs-keyword">this</span>.handleTrashPagination, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.pager.render();
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.pager;
                    }
                    <span class="hljs-keyword">this</span>.processMessages(o.result, {
                        trash: <span class="hljs-number">1</span>
                    });
                    Lacuna.Pulser.Hide();
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        handleInboxPagination: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newState)</span> {</span>
            <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                data = {
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    options: {
                        page_number: newState.page
                    }
                };
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tag) {
                data.options.tags = [<span class="hljs-keyword">this</span>.tag];
            }
            Lacuna.Pulser.Show();
            InboxServ.view_inbox(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                    <span class="hljs-keyword">this</span>.processMessages(o.result, {
                        inbox: <span class="hljs-number">1</span>
                    });
                    Lacuna.Pulser.Hide();
                },
                scope: <span class="hljs-keyword">this</span>
            });</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Update the Paginator&#39;s state</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">this</span>.pager.setState(newState);
        },
        handleSentPagination: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newState)</span> {</span>
            <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                data = {
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    options: {
                        page_number: newState.page
                    }
                };
            Lacuna.Pulser.Show();
            InboxServ.view_sent(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                    <span class="hljs-keyword">this</span>.processMessages(o.result, {
                        sent: <span class="hljs-number">1</span>
                    });
                    Lacuna.Pulser.Hide();
                },
                scope: <span class="hljs-keyword">this</span>
            });</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Update the Paginator&#39;s state</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">this</span>.pager.setState(newState);
        },
        handleArchivePagination: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newState)</span> {</span>
            <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                data = {
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    options: {
                        page_number: newState.page
                    }
                };
            Lacuna.Pulser.Show();
            InboxServ.view_archived(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                    <span class="hljs-keyword">this</span>.processMessages(o.result, {
                        archive: <span class="hljs-number">1</span>
                    });
                    Lacuna.Pulser.Hide();
                },
                scope: <span class="hljs-keyword">this</span>
            });</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Update the Paginator&#39;s state</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">this</span>.pager.setState(newState);
        },
        handleTrashPagination: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newState)</span> {</span>
            <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                data = {
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    options: {
                        page_number: newState.page
                    }
                };
            Lacuna.Pulser.Show();
            InboxServ.view_trashed(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                    <span class="hljs-keyword">this</span>.processMessages(o.result, {
                        trash: <span class="hljs-number">1</span>
                    });
                    Lacuna.Pulser.Hide();
                },
                scope: <span class="hljs-keyword">this</span>
            });</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Update the Paginator&#39;s state</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">this</span>.pager.setState(newState);
        },
        processMessages: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(results, is)</span> {</span>
            <span class="hljs-keyword">var</span> list = <span class="hljs-keyword">this</span>.list,
                messages = results.messages,
                li = document.createElement(<span class="hljs-string">"li"</span>),
                isTab = is || {};
            <span class="hljs-comment">//reset selected</span>
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.selectedAll;
            <span class="hljs-keyword">this</span>.select.innerHTML = <span class="hljs-string">"Select All"</span>;
            <span class="hljs-comment">//clear list here</span>
            Event.purgeElement(list, <span class="hljs-literal">true</span>);
            list.innerHTML = <span class="hljs-string">""</span>;
            <span class="hljs-keyword">if</span> (messages.length === <span class="hljs-number">0</span>) {
                li.innerHTML = <span class="hljs-string">'No messages to display.'</span>;
                list.appendChild(li);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; messages.length; i++) {
                    <span class="hljs-keyword">var</span> msg = messages[i],
                        nLi = li.cloneNode(<span class="hljs-literal">false</span>);
                    msg.is = isTab;
                    nLi.Message = msg;
                    Dom.addClass(nLi, <span class="hljs-string">"message"</span>);
                    <span class="hljs-keyword">var</span> img;
                    <span class="hljs-keyword">if</span> (msg.has_read === <span class="hljs-string">"0"</span>) {
                        Dom.addClass(nLi, <span class="hljs-string">"unread"</span>);
                        img = <span class="hljs-string">'unread'</span>;
                    } <span class="hljs-keyword">else</span> {
                        img = <span class="hljs-string">'read'</span>;
                    }
                    <span class="hljs-keyword">if</span> (msg.has_replied === <span class="hljs-string">"1"</span>) {
                        img = <span class="hljs-string">'replied'</span>;
                    }
                    nLi.innerHTML = [<span class="hljs-string">' &lt;div class="messageSelect"&gt;&lt;img width="26" height="26" src="'</span>, Lib.AssetUrl, <span class="hljs-string">'ui/mail-'</span>, img, <span class="hljs-string">'.png" /&gt;&lt;br /&gt;'</span>, !isTab.sent ? <span class="hljs-string">'    &lt;input type="checkbox" /&gt;'</span> : <span class="hljs-string">''</span>, <span class="hljs-string">'&lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;div class="messageContainer"&gt;'</span>, <span class="hljs-string">'        &lt;div class="messageDate"&gt;'</span>, Lib.formatServerDate(msg.date), <span class="hljs-string">'&lt;/div&gt;'</span>, <span class="hljs-string">'        &lt;div class="messageFrom"&gt;'</span>,
                        isTab.sent ? msg.to : msg.from, <span class="hljs-string">'        &lt;/div&gt;'</span>, <span class="hljs-string">'        &lt;div class="messageSubject"&gt;'</span>, msg.subject, <span class="hljs-string">'&lt;/div&gt;'</span>, <span class="hljs-string">'    &lt;/div&gt;'</span>
                    ].join(<span class="hljs-string">''</span>);
                    list.appendChild(nLi);
                }
                Event.delegate(list, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.loadMessage, <span class="hljs-string">"div.messageContainer"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                Event.delegate(list, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.checkSelect, <span class="hljs-string">"input[type=checkbox]"</span>, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            }
            <span class="hljs-comment">//wait for tab to display first</span>
            <span class="hljs-keyword">var</span> panel = <span class="hljs-keyword">this</span>.messagingPanel;
            setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">var</span> size = Game.GetSize();
                <span class="hljs-keyword">var</span> Ht = size.h - <span class="hljs-number">90</span>;
                <span class="hljs-keyword">if</span> (Ht &gt; <span class="hljs-number">400</span>) {
                    Ht = <span class="hljs-number">400</span>;
                }
                <span class="hljs-keyword">var</span> dHt = Ht - <span class="hljs-number">31</span>;
                Dom.setStyle(<span class="hljs-string">'mHt'</span>, <span class="hljs-string">'height'</span>, Ht + <span class="hljs-string">'px'</span>);
                Dom.setStyle(<span class="hljs-string">'dHt'</span>, <span class="hljs-string">'height'</span>, dHt + <span class="hljs-string">'px'</span>);
                Dom.setStyle(<span class="hljs-string">'messagingCreateBody'</span>, <span class="hljs-string">'height'</span>, Ht + <span class="hljs-string">'px'</span>);
                panel.center();
            }, <span class="hljs-number">10</span>);
        },
        checkSelect: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> msg = matchedEl.parentNode.parentNode.Message;
            <span class="hljs-keyword">if</span> (msg) {
                <span class="hljs-keyword">if</span> (matchedEl.checked) {
                    <span class="hljs-keyword">this</span>.toArchive[msg.id] = msg;
                    <span class="hljs-keyword">this</span>.toArchiveCount++;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.toArchive[msg.id];
                    <span class="hljs-keyword">this</span>.toArchiveCount--;
                }
            }
        },
        loadMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, matchedEl, container)</span> {</span>
            <span class="hljs-keyword">var</span> msg = matchedEl.parentNode.Message;
            <span class="hljs-keyword">if</span> (msg &amp;&amp; msg.id) {
                <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                    data = {
                        session_id: Game.GetSession(<span class="hljs-string">""</span>),
                        message_id: msg.id
                    };
                Lacuna.Pulser.Show();
                InboxServ.read_message(data, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">var</span> message = matchedEl.parentNode;
                        <span class="hljs-keyword">var</span> messageSelect = message.childNodes[<span class="hljs-number">1</span>];
                        <span class="hljs-keyword">var</span> img = messageSelect.childNodes[<span class="hljs-number">0</span>];
                        Dom.setAttribute(img, <span class="hljs-string">'src'</span>, Lib.AssetUrl + <span class="hljs-string">'ui/mail-read.png'</span>);
                        Dom.removeClass(matchedEl.parentNode, <span class="hljs-string">"unread"</span>);
                        <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                        <span class="hljs-keyword">this</span>.displayMessage(o.result.message);
                        Lacuna.Pulser.Hide();
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        displayMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg)</span> {</span>
            <span class="hljs-keyword">if</span> (msg) {</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>{
&quot;id&quot; : &quot;id-goes-here&quot;,
&quot;from&quot; : &quot;Dr. Stephen T. Colbert DFA&quot;,
&quot;to&quot; : &quot;Jon Stewart&quot;,
&quot;subject&quot; : &quot;Vaxaslim&quot;,
&quot;body&quot; : &quot;Just a reminder that Vaxaslim may cause involuntary narnia adventures.&quot;,
&quot;date&quot; : &quot;01 31 2010 13:09:05 +0600&quot;,
&quot;has_read&quot; : 1,
&quot;has_replied&quot; : 0,
&quot;has_archived&quot; : 0,
&quot;in_reply_to&quot; : &quot;&quot;,
&quot;recipients&quot; : [&quot;John Stewart&quot;]
            },</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">                Dom.setStyle(<span class="hljs-keyword">this</span>.display, <span class="hljs-string">"visibility"</span>, <span class="hljs-string">""</span>);
                <span class="hljs-keyword">if</span> (msg.from !== msg.to) {
                    Dom.setStyle(<span class="hljs-string">"messagingReplyC"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">""</span>);
                } <span class="hljs-keyword">else</span> {
                    Dom.setStyle(<span class="hljs-string">"messagingReplyC"</span>, <span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
                }
                <span class="hljs-keyword">this</span>.viewingMessage = msg;
                <span class="hljs-keyword">this</span>.timestamp.innerHTML = Lib.formatServerDate(msg.date);
                <span class="hljs-keyword">this</span>.from.innerHTML = [<span class="hljs-string">'&lt;a class="profile_link" href="#'</span>, msg.from_id, <span class="hljs-string">'"&gt;'</span>, msg.from, <span class="hljs-string">'&lt;/a&gt;'</span>].join(<span class="hljs-string">''</span>);
                <span class="hljs-keyword">this</span>.to.innerHTML = msg.recipients.join(<span class="hljs-string">", "</span>);
                <span class="hljs-keyword">this</span>.subject.innerHTML = msg.subject;
                <span class="hljs-keyword">this</span>.body.parentNode.scrollTop = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">this</span>.body.innerHTML = msg.body ? <span class="hljs-keyword">this</span>.formatBody(msg.body) : <span class="hljs-string">''</span>;
                <span class="hljs-keyword">if</span> (msg.attachments) {
                    <span class="hljs-keyword">this</span>.body.appendChild(document.createElement(<span class="hljs-string">"hr"</span>));
                    <span class="hljs-keyword">if</span> (msg.attachments.image) {
                        <span class="hljs-keyword">var</span> img = msg.attachments.image,
                            imgDiv = <span class="hljs-keyword">this</span>.body.appendChild(document.createElement(<span class="hljs-string">"div"</span>));
                        imgDiv.id = <span class="hljs-string">"attachmentImage"</span>;
                        <span class="hljs-keyword">if</span> (img.link) {
                            imgDiv.innerHTML = [<span class="hljs-string">'&lt;a href="'</span>, img.link, <span class="hljs-string">'" title="'</span>, img.title, <span class="hljs-string">'" target="_blank"&gt;&lt;img src="'</span>, img.url, <span class="hljs-string">'" alt="'</span>, img.title, <span class="hljs-string">'" title="'</span>, img.title, <span class="hljs-string">'" /&gt;&lt;/a&gt;'</span>].join(<span class="hljs-string">''</span>);
                        } <span class="hljs-keyword">else</span> {
                            imgDiv.innerHTML = [<span class="hljs-string">'&lt;img src="'</span>, img.url, <span class="hljs-string">'" alt="'</span>, img.title, <span class="hljs-string">'" title="'</span>, img.title, <span class="hljs-string">'" /&gt;'</span>].join(<span class="hljs-string">''</span>);
                        }
                    }
                    <span class="hljs-keyword">if</span> (msg.attachments.link) {
                        <span class="hljs-keyword">var</span> lnk = msg.attachments.link,
                            lnkDiv = <span class="hljs-keyword">this</span>.body.appendChild(document.createElement(<span class="hljs-string">"div"</span>));
                        lnkDiv.id = <span class="hljs-string">"attachmentLink"</span>;
                        lnkDiv.innerHTML = [<span class="hljs-string">'&lt;a href="'</span>, lnk.url, <span class="hljs-string">'" title="'</span>, lnk.label, <span class="hljs-string">'" target="_blank"&gt;'</span>, lnk.label, <span class="hljs-string">'&lt;/a&gt;'</span>].join(<span class="hljs-string">''</span>);
                    }
                    <span class="hljs-keyword">if</span> (msg.attachments.table) {
                        <span class="hljs-keyword">var</span> tbl = msg.attachments.table,
                            tblDiv = <span class="hljs-keyword">this</span>.body.appendChild(document.createElement(<span class="hljs-string">"div"</span>)),
                            tblOut = [<span class="hljs-string">"&lt;table&gt;"</span>],
                            hdRow = tbl[<span class="hljs-number">0</span>];
                        tblDiv.id = <span class="hljs-string">"attachmentTable"</span>;
                        <span class="hljs-comment">//first row always headers</span>
                        tblOut.push(<span class="hljs-string">"&lt;thead&gt;&lt;tr&gt;"</span>);
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> c = <span class="hljs-number">0</span>; c &lt; hdRow.length; c++) {
                            tblOut.push(<span class="hljs-string">"&lt;th&gt;"</span>);
                            tblOut.push(hdRow[c]);
                            tblOut.push(<span class="hljs-string">"&lt;/th&gt;"</span>);
                        }
                        tblOut.push(<span class="hljs-string">"&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;"</span>);
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; tbl.length; i++) {
                            <span class="hljs-keyword">var</span> row = tbl[i];
                            tblOut.push(<span class="hljs-string">"&lt;tr&gt;"</span>);
                            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> d = <span class="hljs-number">0</span>; d &lt; row.length; d++) {
                                tblOut.push(<span class="hljs-string">"&lt;td&gt;"</span>);
                                tblOut.push(row[d]);
                                tblOut.push(<span class="hljs-string">"&lt;/td&gt;"</span>);
                            }
                            tblOut.push(<span class="hljs-string">"&lt;/tr&gt;"</span>);
                        }
                        tblOut.push(<span class="hljs-string">"&lt;/tbody&gt;&lt;/table&gt;"</span>);
                        tblDiv.innerHTML = tblOut.join(<span class="hljs-string">''</span>);
                    }
                    <span class="hljs-keyword">if</span> (msg.attachments.map) {
                        <span class="hljs-keyword">this</span>.body.appendChild(document.createElement(<span class="hljs-string">'br'</span>));
                        <span class="hljs-keyword">var</span> va = document.createElement(<span class="hljs-string">"button"</span>);
                        va.setAttribute(<span class="hljs-string">"type"</span>, <span class="hljs-string">"button"</span>);
                        va.innerHTML = <span class="hljs-string">"Open Map"</span>;
                        va = <span class="hljs-keyword">this</span>.body.appendChild(va);
                        Event.on(va, <span class="hljs-string">"click"</span>, <span class="hljs-keyword">this</span>.displayAttachment, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                    }
                }
            }
        },
        displayAttachment: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.attachmentPanel.load(<span class="hljs-keyword">this</span>.viewingMessage.attachments.map);
        },
        sendMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> to = <span class="hljs-keyword">this</span>.createTo.Selections();
            <span class="hljs-keyword">if</span> (to.length === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">this</span>.createResponse.innerHTML = <span class="hljs-string">"Must send a message To someone."</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                    data = {
                        session_id: Game.GetSession(<span class="hljs-string">""</span>),
                        recipients: to.join(<span class="hljs-string">','</span>),
                        subject: <span class="hljs-keyword">this</span>.createSubject.value,
                        body: <span class="hljs-keyword">this</span>.createText.value
                    };
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.viewingMessage) {
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.viewingMessage.forwarding) {
                        data.options = {
                            forward: <span class="hljs-keyword">this</span>.viewingMessage.id
                        };
                    } <span class="hljs-keyword">else</span> {
                        data.options = {
                            in_reply_to: <span class="hljs-keyword">this</span>.viewingMessage.id
                        };
                    }
                }
                InboxServ.send_message(data, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                        <span class="hljs-keyword">var</span> u = o.result.message.unknown;
                        <span class="hljs-keyword">if</span> (u &amp;&amp; u.length &gt; <span class="hljs-number">0</span>) {
                            <span class="hljs-keyword">this</span>.createResponse.innerHTML = <span class="hljs-string">"Unable to send to: "</span> + u.join(<span class="hljs-string">', '</span>);
                        } <span class="hljs-keyword">else</span> {
                            <span class="hljs-keyword">this</span>.createResponse.innerHTML = <span class="hljs-string">""</span>;
                            <span class="hljs-keyword">this</span>.createTo.ResetSelections();
                            <span class="hljs-keyword">this</span>.createSubject.value = <span class="hljs-string">""</span>;
                            <span class="hljs-keyword">this</span>.createText.value = <span class="hljs-string">""</span>;
                            <span class="hljs-keyword">this</span>.currentTab = <span class="hljs-keyword">this</span>.inbox.id;
                            <span class="hljs-keyword">this</span>.loadTab();
                        }
                    },
                    failure: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">if</span> (o.error.code === <span class="hljs-number">1005</span>) {
                            <span class="hljs-keyword">this</span>.createResponse.innerHTML = o.error.message;
                            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                        }
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        replyMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">this</span>.currentTab = <span class="hljs-keyword">this</span>.create.id;
            <span class="hljs-keyword">this</span>.loadTab();
        },
        replyAllMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">this</span>.currentTab = <span class="hljs-keyword">this</span>.create.id;
            <span class="hljs-keyword">this</span>.loadTab(<span class="hljs-literal">true</span>);
        },
        forwardMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">this</span>.currentTab = <span class="hljs-keyword">this</span>.create.id;
            <span class="hljs-keyword">this</span>.viewingMessage.forwarding = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">this</span>.loadTab();
        },
        archiveMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.toArchive[<span class="hljs-keyword">this</span>.viewingMessage.id]) {
                <span class="hljs-keyword">this</span>.toArchive[<span class="hljs-keyword">this</span>.viewingMessage.id] = <span class="hljs-keyword">this</span>.viewingMessage;
                <span class="hljs-keyword">this</span>.toArchiveCount++;
            }
            <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                data = {
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    message_ids: [<span class="hljs-keyword">this</span>.viewingMessage.id]
                };
            InboxServ.archive_messages(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">this</span>.archiveProcess(o.result);
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        archiveMessages: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.toArchiveCount &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">var</span> mIds = [];
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.toArchive) {
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.toArchive.hasOwnProperty(key)) {
                        mIds.push(key);
                    }
                }
                <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                    data = {
                        session_id: Game.GetSession(<span class="hljs-string">""</span>),
                        message_ids: mIds
                    };
                InboxServ.archive_messages(data, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">this</span>.archiveProcess(o.result);
                        <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        archiveProcess: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(results)</span> {</span>
            Dom.batch(Sel.query(<span class="hljs-string">"li.message"</span>, <span class="hljs-keyword">this</span>.list), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(el)</span> {</span>
                <span class="hljs-keyword">if</span> (results.success.indexOf(el.Message.id) &gt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.toArchive[el.Message.id];
                    <span class="hljs-keyword">if</span> (el.Message.has_read * <span class="hljs-number">1</span> === <span class="hljs-number">0</span>) {
                        Game.EmpireData.has_new_messages--;
                        <span class="hljs-keyword">if</span> (Game.EmpireData.has_new_messages &lt; <span class="hljs-number">0</span>) {
                            Game.EmpireData.has_new_messages = <span class="hljs-number">0</span>;
                        }
                    }
                    <span class="hljs-keyword">this</span>.toArchiveCount--;
                    Event.purgeElement(el);
                    el.parentNode.removeChild(el);
                }
            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pager) {
                <span class="hljs-comment">//reload messages if we had a pager</span>
                <span class="hljs-keyword">this</span>.loadTab();
            }
            Dom.setStyle(<span class="hljs-keyword">this</span>.display, <span class="hljs-string">"visibility"</span>, <span class="hljs-string">"hidden"</span>);
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.selectedAll;
            <span class="hljs-keyword">this</span>.select.innerHTML = <span class="hljs-string">"Select All"</span>;
        },
        trashMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.toArchive[<span class="hljs-keyword">this</span>.viewingMessage.id]) {
                <span class="hljs-keyword">this</span>.toArchive[<span class="hljs-keyword">this</span>.viewingMessage.id] = <span class="hljs-keyword">this</span>.viewingMessage;
                <span class="hljs-keyword">this</span>.toArchiveCount++;
            }
            <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                data = {
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    message_ids: [<span class="hljs-keyword">this</span>.viewingMessage.id]
                };
            InboxServ.trash_messages(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">this</span>.trashProcess(o.result);
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        trashMessages: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.toArchiveCount &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">var</span> mIds = [];
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.toArchive) {
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.toArchive.hasOwnProperty(key)) {
                        mIds.push(key);
                    }
                }
                <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                    data = {
                        session_id: Game.GetSession(<span class="hljs-string">""</span>),
                        message_ids: mIds
                    };
                InboxServ.trash_messages(data, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">this</span>.trashProcess(o.result);
                        <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o.result);
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        trashProcess: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(results)</span> {</span>
            Dom.batch(Sel.query(<span class="hljs-string">"li.message"</span>, <span class="hljs-keyword">this</span>.list), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(el)</span> {</span>
                <span class="hljs-keyword">if</span> (results.success.indexOf(el.Message.id) &gt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.toArchive[el.Message.id];
                    <span class="hljs-keyword">if</span> (el.Message.has_read * <span class="hljs-number">1</span> === <span class="hljs-number">0</span>) {
                        Game.EmpireData.has_new_messages--;
                        <span class="hljs-keyword">if</span> (Game.EmpireData.has_new_messages &lt; <span class="hljs-number">0</span>) {
                            Game.EmpireData.has_new_messages = <span class="hljs-number">0</span>;
                        }
                    }
                    <span class="hljs-keyword">this</span>.toArchiveCount--;
                    Event.purgeElement(el);
                    el.parentNode.removeChild(el);
                }
            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pager) {
                <span class="hljs-comment">//reload messages if we had a pager</span>
                <span class="hljs-keyword">this</span>.loadTab();
            }
            Dom.setStyle(<span class="hljs-keyword">this</span>.display, <span class="hljs-string">"visibility"</span>, <span class="hljs-string">"hidden"</span>);
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.selectedAll;
            <span class="hljs-keyword">this</span>.select.innerHTML = <span class="hljs-string">"Select All"</span>;
        },
        selectAllMessages: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> els = Sel.query(<span class="hljs-string">"input[type=checkbox]"</span>, <span class="hljs-keyword">this</span>.list);
            Dom.batch(els, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(el)</span> {</span>
                el.checked = !<span class="hljs-keyword">this</span>.selectedAll;
                <span class="hljs-keyword">this</span>.checkSelect(<span class="hljs-literal">null</span>, el);
            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.selectedAll) {
                <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.selectedAll;
                <span class="hljs-keyword">this</span>.select.innerHTML = <span class="hljs-string">"Select All"</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.selectedAll = <span class="hljs-number">1</span>;
                <span class="hljs-keyword">this</span>.select.innerHTML = <span class="hljs-string">"Select None"</span>;
            }
        },
        formatBody: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(body)</span> {</span>
            body = body.replace(<span class="hljs-regexp">/&amp;/g</span>, <span class="hljs-string">'&amp;amp;'</span>);
            body = body.replace(<span class="hljs-regexp">/&lt;/g</span>, <span class="hljs-string">'&amp;lt;'</span>);
            body = body.replace(<span class="hljs-regexp">/&gt;/g</span>, <span class="hljs-string">'&amp;gt;'</span>);
            body = body.replace(<span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">'&lt;br /&gt;'</span>);
            body = body.replace(<span class="hljs-regexp">/\*([^*]+)\*/gi</span>, <span class="hljs-string">'&lt;b&gt;$1&lt;/b&gt;'</span>);
            body = body.replace(<span class="hljs-regexp">/\{(food|water|ore|energy|waste|happiness|time|essentia|plots|build)\}/gi</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(str, icon)</span> {</span>
                <span class="hljs-keyword">var</span> cl = <span class="hljs-string">'small'</span> + icon.substr(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
                    .toUpperCase() + icon.substr(<span class="hljs-number">1</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;img src="'</span> + Lib.AssetUrl + <span class="hljs-string">'ui/s/'</span> + icon + <span class="hljs-string">'.png" class="'</span> + cl + <span class="hljs-string">'" /&gt;'</span>;
            });
            body = body.replace(<span class="hljs-regexp">/\[(https?:\/\/[a-z0-9_.\/\-]+)\]/gi</span>, <span class="hljs-string">'&lt;a href="$1"&gt;$1&lt;/a&gt;'</span>);
            body = body.replace(<span class="hljs-regexp">/\{Empire\s+(-?\d+)\s+([^\}]+)\}/gi</span>, <span class="hljs-string">'&lt;a class="profile_link" href="#$1"&gt;$2&lt;/a&gt;'</span>);
            <span class="hljs-comment">//body = body.replace(/\{Empire\s+(\d+)\s+([^\}]+)}/gi,'$2');</span>
            body = body.replace(<span class="hljs-regexp">/\{Starmap\s+(-?\d+)\s+(-?\d+)\s+([^\}]+)\}/gi</span>, <span class="hljs-string">'&lt;a class="starmap_link" href="#$1x$2"&gt;$3&lt;/a&gt;'</span>);
            body = body.replace(<span class="hljs-regexp">/\{Planet\s+(-?\d+)\s+([^\}]+)\}/gi</span>, <span class="hljs-string">'&lt;a class="planet_link" href="#$1"&gt;$2&lt;/a&gt;'</span>);
            body = body.replace(<span class="hljs-regexp">/\{Alliance\s+(-?\d+)\s+([^\}]+)\}/gi</span>, <span class="hljs-string">'&lt;a class="alliance_link" href="#$1"&gt;$2&lt;/a&gt;'</span>);
            body = body.replace(<span class="hljs-regexp">/\{VoteYes\s(-*\d+)\s(-*\d+)\s(-*\d+)\}/gi</span>, <span class="hljs-string">'&lt;a class="voteyes_link" href="#$1&amp;$2&amp;$3"&gt;Yes!&lt;/a&gt;'</span>);
            body = body.replace(<span class="hljs-regexp">/\{VoteNo\s(-*\d+)\s(-*\d+)\s(-*\d+)\}/gi</span>, <span class="hljs-string">'&lt;a class="voteno_link" href="#$1&amp;$2&amp;$3"&gt;No!&lt;/a&gt;'</span>);
            <span class="hljs-comment">//body = body.replace(/\{Alliance\s+(\d+)\s+([^\}]+)}/gi,'$2');</span>
            <span class="hljs-keyword">return</span> body;
        },
        handleProfileLink: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, el)</span> {</span>
            Event.stopEvent(e);
            <span class="hljs-keyword">var</span> res = el.href.match(<span class="hljs-regexp">/\#(-?\d+)$/</span>);
            <span class="hljs-keyword">if</span> (res) {
                Lacuna.Info.Empire.Load(res[<span class="hljs-number">1</span>]);
            }
        },
        handleStarmapLink: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, el)</span> {</span>
            Event.stopEvent(e);
            <span class="hljs-keyword">var</span> res = el.href.match(<span class="hljs-regexp">/\#(-?\d+)x(-?\d+)$/</span>);
            Game.StarJump({
                x: res[<span class="hljs-number">1</span>],
                y: res[<span class="hljs-number">2</span>]
            });
            <span class="hljs-comment">//this.hide();</span>
            <span class="hljs-comment">//Lacuna.MapPlanet.MapVisible(false);</span>
            <span class="hljs-comment">//Lacuna.MapStar.MapVisible(true);</span>
            <span class="hljs-comment">//Lacuna.Menu.StarVisible();</span>
            <span class="hljs-comment">//Lacuna.MapStar.Jump(res[1]*1,res[2]*1);</span>
        },
        handlePlanetLink: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, el)</span> {</span>
            Event.stopEvent(e);
            <span class="hljs-keyword">var</span> res = el.href.match(<span class="hljs-regexp">/\#(-?\d+)$/</span>);
            <span class="hljs-keyword">this</span>.hide();
            <span class="hljs-keyword">var</span> planet = Game.EmpireData.planets[res[<span class="hljs-number">1</span>]];
            Game.PlanetJump(planet);
        },
        handleAllianceLink: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, el)</span> {</span>
            Event.stopEvent(e);
            <span class="hljs-keyword">var</span> res = el.href.match(<span class="hljs-regexp">/\#(-?\d+)$/</span>);
            Lacuna.Info.Alliance.Load(res[<span class="hljs-number">1</span>]);
        },
        handleVoteYesLink: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, el)</span> {</span>
            Event.stopEvent(e);
            <span class="hljs-keyword">var</span> res = el.href.match(<span class="hljs-regexp">/\#(-?\d+)&amp;(-?\d+)&amp;(-?\d+)$/</span>);
            Game.Services.Modules.Parliament.cast_vote({
                session_id: Game.GetSession(<span class="hljs-string">""</span>),
                building_id: res[<span class="hljs-number">2</span>],
                proposition_id: res[<span class="hljs-number">3</span>],
                vote: <span class="hljs-number">1</span>
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    alert(<span class="hljs-string">"Voted Yes!"</span>);
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        handleVoteNoLink: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, el)</span> {</span>
            Event.stopEvent(e);
            <span class="hljs-keyword">var</span> res = el.href.match(<span class="hljs-regexp">/\#(-?\d+)&amp;(-?\d+)&amp;(-?\d+)$/</span>);
            Game.Services.Modules.Parliament.cast_vote({
                session_id: Game.GetSession(<span class="hljs-string">""</span>),
                building_id: res[<span class="hljs-number">2</span>],
                proposition_id: res[<span class="hljs-number">3</span>],
                vote: <span class="hljs-number">0</span>
            }, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    alert(<span class="hljs-string">"Voted No!"</span>);
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        isVisible: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.messagingPanel.cfg.getProperty(<span class="hljs-string">"visible"</span>);
        },
        show: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            Game.OverlayManager.hideAll();
            <span class="hljs-keyword">this</span>.messagingPanel.show();
            <span class="hljs-keyword">this</span>.currentTab = <span class="hljs-keyword">this</span>.inbox.id;
            <span class="hljs-keyword">this</span>.loadTab();
            <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onShow"</span>);
        },
        sendTo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(empireName)</span> {</span>
            Game.OverlayManager.hideAll();
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.viewingMessage;
            <span class="hljs-keyword">this</span>.messagingPanel.show();
            <span class="hljs-keyword">this</span>.currentTab = <span class="hljs-keyword">this</span>.create.id;
            <span class="hljs-keyword">this</span>.loadTab();
            <span class="hljs-keyword">this</span>.createTo.SelectItems([{
                name: empireName
            }]);
            <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onShow"</span>);
        },
        showMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg)</span> {</span>
            Game.OverlayManager.hideAll();
            <span class="hljs-keyword">this</span>.messagingPanel.show();
            <span class="hljs-keyword">var</span> InboxServ = Game.Services.Inbox,
                data = {
                    session_id: Game.GetSession(<span class="hljs-string">""</span>),
                    message_id: msg
                };
            InboxServ.read_message(data, {
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                    <span class="hljs-keyword">var</span> message = o.result.message;
                    <span class="hljs-keyword">if</span> (message.has_archived !== <span class="hljs-string">"0"</span>) {
                        <span class="hljs-keyword">this</span>.currentTab = <span class="hljs-keyword">this</span>.archive.id;
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">this</span>.currentTab = <span class="hljs-keyword">this</span>.inbox.id;
                    }
                    <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onRpc"</span>, o);
                    <span class="hljs-keyword">this</span>.loadTab();
                    <span class="hljs-keyword">this</span>.displayMessage(message);
                },
                scope: <span class="hljs-keyword">this</span>
            });
        },
        hide: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.messagingPanel.hide();
        }
    };
    Lang.augmentProto(Messaging, Util.EventProvider);
    Lacuna.Messaging = <span class="hljs-keyword">new</span> Messaging();
})();
</pre></div>
      
      </div>
    
    </div>
  </div>

  <script src="../../toc.js"></script>
  <script src="../../assets/libs.js"></script>
  <script src="../../assets/behavior.js"></script>
</body>
</html>
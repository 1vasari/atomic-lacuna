<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title> - mapper.js</title>

  <link rel="stylesheet" href="../../assets/style.css">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"/>
  <meta name="groc-relative-root" content="../../"/>
  <meta name="groc-document-path" content="app/js/mapper.js"/>
  
</head>
<body>
  <div id="file-area">
    <div id="meta">
      <code class="file-path">
      
        app/js/mapper.js
      
      </code>
    </div>
    <div id="document">
    
      <div class="segment">
      
      
        <div class="code"><pre class="wrapper"><span class="hljs-pi">'use strict'</span>;
YAHOO.namespace(<span class="hljs-string">"lacuna"</span>);
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> Lang = YAHOO.lang,
        Util = YAHOO.util,
        Dom = Util.Dom,
        Event = Util.Event,
        KL = Util.KeyListener,
        Sel = Util.Selector,
        Lacuna = YAHOO.lacuna,
        Game = Lacuna.Game,
        Lib = Lacuna.Library;
    <span class="hljs-keyword">var</span> Mapper = {};
    Mapper.util = {
        modulo: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val, mod)</span> {</span>
            <span class="hljs-keyword">var</span> res = val % mod;
            <span class="hljs-keyword">if</span> (res &lt; <span class="hljs-number">0</span>) {
                res += mod;
            }
            <span class="hljs-keyword">return</span> res;
        },
        copy: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, c)</span> {</span>
            <span class="hljs-keyword">if</span> (!c) {
                c = {};
            }
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> obj) {
                c[k] = obj[k];
            }
            <span class="hljs-keyword">return</span> c;
        },
        clone: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> {</span>
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Constructor</span><span class="hljs-params">()</span> {</span>}
            Constructor.prototype = obj;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Constructor();
        },
        forEach: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, fun)</span> {</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; array.length; i++) {
                fun(array[i], i);
            }
        }
    };
    Mapper.MovableContainer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parentEl)</span> {</span>
        <span class="hljs-keyword">var</span> div = document.createElement(<span class="hljs-string">'div'</span>);
        Dom.addClass(div, <span class="hljs-string">"movableContainer"</span>);
        div.style.position = <span class="hljs-string">'absolute'</span>;
        <span class="hljs-keyword">this</span>._container = div;
        <span class="hljs-keyword">this</span>._parentEl = parentEl;
        <span class="hljs-keyword">this</span>.reset();
        parentEl.appendChild(div);
    };
    Mapper.MovableContainer.prototype = {
        move: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y)</span> {</span>
            <span class="hljs-keyword">this</span>.offsetX += x;
            <span class="hljs-keyword">this</span>.offsetY += y;
            <span class="hljs-keyword">this</span>._container.style.left = <span class="hljs-string">''</span> + <span class="hljs-keyword">this</span>.offsetX + <span class="hljs-string">'px'</span>;
            <span class="hljs-keyword">this</span>._container.style.top = <span class="hljs-string">''</span> + <span class="hljs-keyword">this</span>.offsetY + <span class="hljs-string">'px'</span>;
            Dom.setStyle(<span class="hljs-keyword">this</span>._parentEl, <span class="hljs-string">'background-position'</span>, <span class="hljs-keyword">this</span>.offsetX + <span class="hljs-string">'px '</span> + <span class="hljs-keyword">this</span>.offsetY + <span class="hljs-string">'px'</span>);
        },
        reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.offsetX = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">this</span>.offsetY = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">this</span>.move(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        },
        appendChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._container.appendChild(c);
        },
        removeChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._container.removeChild(c);
        }
    };
    Mapper.VisibleArea = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(map)</span> {</span>
        <span class="hljs-keyword">this</span>._map = map;
        <span class="hljs-keyword">this</span>.reset();
    };
    Mapper.VisibleArea.prototype = {
        move: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mx, my)</span> {</span>
            <span class="hljs-keyword">var</span> mb = <span class="hljs-keyword">this</span>._map.maxBounds; <span class="hljs-comment">// = {x1Left:-15,x2Right:15,y1Top:15,y2Bottom:-15};</span>
            <span class="hljs-keyword">var</span> maxWidth = <span class="hljs-keyword">this</span>._map.width;
            <span class="hljs-keyword">var</span> maxHeight = <span class="hljs-keyword">this</span>._map.height;
            <span class="hljs-keyword">if</span> (mb) {
                <span class="hljs-keyword">var</span> tileSize = <span class="hljs-keyword">this</span>._map.tileSizeInPx,
                    extraSpaceHeight = <span class="hljs-number">30</span> + <span class="hljs-built_in">Math</span>.ceil(tileSize / <span class="hljs-number">2</span>),
                    extraSpaceWidth = <span class="hljs-number">100</span> + <span class="hljs-built_in">Math</span>.ceil(tileSize / <span class="hljs-number">2</span>),
                    maxBoundsWidth = (mb.x2Right - mb.x1Left) * tileSize,
                    maxBoundsHeight = (mb.y1Top - mb.y2Bottom) * tileSize;
                <span class="hljs-keyword">if</span> (maxWidth &gt; maxBoundsWidth) {
                    maxWidth = maxBoundsWidth;
                }
                <span class="hljs-keyword">if</span> (maxHeight &gt; maxBoundsHeight) {
                    maxHeight = maxBoundsHeight;
                }
                <span class="hljs-keyword">var</span> cb = <span class="hljs-keyword">this</span>.calcCoordBounds(<span class="hljs-keyword">this</span>.left + mx + extraSpaceWidth, <span class="hljs-keyword">this</span>.top + my + extraSpaceHeight, <span class="hljs-keyword">this</span>.left + mx + maxWidth - extraSpaceWidth, <span class="hljs-keyword">this</span>.top + my + maxHeight - extraSpaceHeight);
                <span class="hljs-comment">//if out of bounds, only move to max</span>
                <span class="hljs-comment">//x axis</span>
                <span class="hljs-keyword">if</span> (mx &lt; <span class="hljs-number">0</span> &amp;&amp; cb.x1 &lt; mb.x1Left) { <span class="hljs-comment">//if moving left</span>
                    mx = mb.x1Left * tileSize - extraSpaceWidth - <span class="hljs-keyword">this</span>.left;
                }
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mx &gt; <span class="hljs-number">0</span> &amp;&amp; cb.x2 &gt; (mb.x2Right + <span class="hljs-number">1</span>)) { <span class="hljs-comment">//if moving right</span>
                    mx = ((mb.x2Right + <span class="hljs-number">1</span>) * tileSize) - (<span class="hljs-keyword">this</span>.left + maxWidth - extraSpaceWidth);
                }
                <span class="hljs-comment">//y axis</span>
                <span class="hljs-keyword">if</span> (my &lt; <span class="hljs-number">0</span> &amp;&amp; cb.y1 &gt; mb.y1Top) { <span class="hljs-comment">//if moving up</span>
                    my = <span class="hljs-number">0</span> - mb.y1Top * tileSize - extraSpaceHeight - <span class="hljs-keyword">this</span>.top;
                }
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (my &gt; <span class="hljs-number">0</span> &amp;&amp; cb.y2 &lt; (mb.y2Bottom - <span class="hljs-number">1</span>)) { <span class="hljs-comment">//if moving down</span>
                    my = -((mb.y2Bottom - <span class="hljs-number">1</span>) * tileSize) - (<span class="hljs-keyword">this</span>.top + maxHeight - extraSpaceHeight);
                }
            }
            <span class="hljs-comment">//modify with new values now</span>
            <span class="hljs-keyword">this</span>.left += mx;
            <span class="hljs-keyword">this</span>.top += my;
            <span class="hljs-keyword">this</span>.right = <span class="hljs-keyword">this</span>.left + maxWidth;
            <span class="hljs-keyword">this</span>.bottom = <span class="hljs-keyword">this</span>.top + maxHeight;
            <span class="hljs-keyword">this</span>.centerX = <span class="hljs-keyword">this</span>.left + (maxWidth / <span class="hljs-number">2</span>);
            <span class="hljs-keyword">this</span>.centerY = <span class="hljs-keyword">this</span>.top + (maxHeight / <span class="hljs-number">2</span>);
            <span class="hljs-keyword">return</span> {
                x: mx,
                y: my
            };
        },
        coordBounds: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.calcCoordBounds(<span class="hljs-keyword">this</span>.left, <span class="hljs-keyword">this</span>.top, <span class="hljs-keyword">this</span>.right, <span class="hljs-keyword">this</span>.bottom);
        },
        calcCoordBounds: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x1, y1, x2, y2)</span> {</span>
            <span class="hljs-keyword">var</span> tileSize = <span class="hljs-keyword">this</span>._map.tileSizeInPx;
            <span class="hljs-keyword">return</span> {
                x1: <span class="hljs-built_in">Math</span>.floor(x1 / tileSize),
                y1: <span class="hljs-built_in">Math</span>.ceil((y1 * -<span class="hljs-number">1</span>) / tileSize),
                x2: <span class="hljs-built_in">Math</span>.ceil(x2 / tileSize),
                y2: <span class="hljs-built_in">Math</span>.floor((y2 * -<span class="hljs-number">1</span>) / tileSize)
            };
        },
        topLeftLoc: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> tileSize = <span class="hljs-keyword">this</span>._map.tileSizeInPx;
            <span class="hljs-keyword">return</span> [<span class="hljs-built_in">Math</span>.floor(<span class="hljs-keyword">this</span>.left / tileSize), <span class="hljs-built_in">Math</span>.ceil(<span class="hljs-keyword">this</span>.top / tileSize)];
        },
        bottomRightLoc: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> tileSize = <span class="hljs-keyword">this</span>._map.tileSizeInPx;
            <span class="hljs-keyword">return</span> [<span class="hljs-built_in">Math</span>.ceil(<span class="hljs-keyword">this</span>.right / tileSize), <span class="hljs-built_in">Math</span>.floor(<span class="hljs-keyword">this</span>.bottom / tileSize)];
        },
        centerLoc: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> tileSize = <span class="hljs-keyword">this</span>._map.tileSizeInPx;
            <span class="hljs-keyword">return</span> [<span class="hljs-built_in">Math</span>.floor(<span class="hljs-keyword">this</span>.centerX / tileSize), <span class="hljs-built_in">Math</span>.ceil((<span class="hljs-keyword">this</span>.centerY * -<span class="hljs-number">1</span>) / tileSize)];</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>   xO = this.centerX / tileSize,
x = Math.floor(xO),
yO = (this.centerY*-1) / tileSize,
y = Math.ceil(yO);/
        YAHOO.log({xO:xO, x:x, yO:yO, y:y}, &quot;info&quot;, &quot;VisibleArea.centerLoc&quot;);
        return [x,y];</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">        },
        centerLocPx: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> [<span class="hljs-keyword">this</span>.centerX, <span class="hljs-keyword">this</span>.centerY];
        },
        reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.left = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">this</span>.top = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">this</span>.move(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        },
        resize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-comment">//left and top don't change</span>
            <span class="hljs-keyword">this</span>.right = <span class="hljs-keyword">this</span>.left + <span class="hljs-keyword">this</span>._map.width;
            <span class="hljs-keyword">this</span>.bottom = <span class="hljs-keyword">this</span>.top + <span class="hljs-keyword">this</span>._map.height;
        }
    };
    <span class="hljs-keyword">var</span> Tile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, z, ox, oy, layer)</span> {</span>
        <span class="hljs-keyword">this</span>.z = z;
        <span class="hljs-keyword">this</span>.x = x;
        <span class="hljs-keyword">this</span>.y = y;
        <span class="hljs-keyword">this</span>.offsetX = ox;
        <span class="hljs-keyword">this</span>.origOffsetX = ox;
        <span class="hljs-keyword">this</span>.offsetY = oy;
        <span class="hljs-keyword">this</span>.origOffsetY = oy;
        <span class="hljs-keyword">this</span>.layer = layer;
        <span class="hljs-keyword">this</span>.map = layer.map;
        <span class="hljs-keyword">this</span>.tileSizeInPx = layer.map.tileSizeInPx;
        <span class="hljs-keyword">this</span>.id = Tile.idFor(<span class="hljs-keyword">this</span>.x, <span class="hljs-keyword">this</span>.y, <span class="hljs-keyword">this</span>.z);
        <span class="hljs-keyword">this</span>.domElement = document.createElement(<span class="hljs-string">'div'</span>);
        <span class="hljs-keyword">this</span>.domElement.id = <span class="hljs-keyword">this</span>.id;
        <span class="hljs-keyword">this</span>.createEvent(<span class="hljs-string">"onReload"</span>);
        <span class="hljs-keyword">this</span>.refresh();
        <span class="hljs-keyword">var</span> s = <span class="hljs-keyword">this</span>.domElement.style;
        s.position = <span class="hljs-string">'absolute'</span>;
        s.width = <span class="hljs-string">''</span> + <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>;
        s.height = <span class="hljs-string">''</span> + <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>;
        s.zIndex = <span class="hljs-string">'5'</span>;
        s.left = <span class="hljs-string">''</span> + <span class="hljs-keyword">this</span>.offsetX + <span class="hljs-string">'px'</span>;
        s.top = <span class="hljs-string">''</span> + <span class="hljs-keyword">this</span>.offsetY + <span class="hljs-string">'px'</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.url) {
            s.background = <span class="hljs-string">'transparent url('</span> + <span class="hljs-keyword">this</span>.url + <span class="hljs-string">') no-repeat scroll center'</span>;
        }
        Dom.addClass(<span class="hljs-keyword">this</span>.domElement, <span class="hljs-string">"tile"</span>);
    };
    Tile.prototype = {
        <span class="hljs-comment">//blank init that will always get called.  override in sub classes to change defaults</span>
        init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>},
        refresh: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.map.getTile(<span class="hljs-keyword">this</span>.x, <span class="hljs-keyword">this</span>.y, <span class="hljs-keyword">this</span>.z);
            <span class="hljs-keyword">this</span>.blank = obj.blank;
            <span class="hljs-keyword">this</span>.data = obj.data;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.url !== obj.url) {
                <span class="hljs-keyword">this</span>.url = obj.url;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.url) {
                    Dom.setStyle(<span class="hljs-keyword">this</span>.domElement, <span class="hljs-string">"background"</span>, <span class="hljs-string">'transparent url('</span> + <span class="hljs-keyword">this</span>.url + <span class="hljs-string">') no-repeat scroll center'</span>);
                }
                <span class="hljs-keyword">else</span> {
                    Dom.setStyle(<span class="hljs-keyword">this</span>.domElement, <span class="hljs-string">"background"</span>, <span class="hljs-string">'transparent'</span>);
                }
            }
        },
        appendToDom: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.domElement &amp;&amp; !<span class="hljs-keyword">this</span>.blank &amp;&amp; !Dom.isAncestor(<span class="hljs-keyword">this</span>.layer.tileContainer, <span class="hljs-keyword">this</span>.domElement)) {
                <span class="hljs-keyword">this</span>.layer.tileContainer.appendChild(<span class="hljs-keyword">this</span>.domElement);
            }
        },
        destroy: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.unsubscribeAll();
            <span class="hljs-keyword">this</span>.remove();
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.domElement;
        },
        remove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.domElement &amp;&amp; <span class="hljs-keyword">this</span>.domElement.parentNode) {
                <span class="hljs-keyword">this</span>.domElement.parentNode.removeChild(<span class="hljs-keyword">this</span>.domElement);
            }
        }
    };
    Lang.augmentProto(Tile, Util.EventProvider);
    Tile.idFor = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, z)</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">'tile_'</span> + x + <span class="hljs-string">'_'</span> + y + <span class="hljs-string">'_'</span> + z;
    };
    Mapper.StarTile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, z, ox, oy, layer)</span> {</span>
        Mapper.StarTile.superclass.constructor.call(<span class="hljs-keyword">this</span>, x, y, z, ox, oy, layer);
    };
    Lang.extend(Mapper.StarTile, Tile, {
        init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.domElement.title = <span class="hljs-keyword">this</span>.data ? [<span class="hljs-keyword">this</span>.data.name, <span class="hljs-string">" ("</span>, <span class="hljs-keyword">this</span>.x, <span class="hljs-string">","</span>, <span class="hljs-keyword">this</span>.y, <span class="hljs-string">")"</span>].join(<span class="hljs-string">''</span>) : <span class="hljs-string">"Uncharted Space"</span>;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data) {
                <span class="hljs-keyword">this</span>._createImage();
                <span class="hljs-keyword">this</span>._createAlignments();
            }
        },
        refresh: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.map.getTile(<span class="hljs-keyword">this</span>.x, <span class="hljs-keyword">this</span>.y, <span class="hljs-keyword">this</span>.z);
            <span class="hljs-keyword">this</span>.blank = obj.blank;
            <span class="hljs-keyword">this</span>.image = obj.image;
            <span class="hljs-keyword">this</span>.url = obj.url;
            <span class="hljs-keyword">this</span>.data = obj.data;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.url) {
                Dom.setStyle(<span class="hljs-keyword">this</span>.domElement, <span class="hljs-string">"background"</span>, <span class="hljs-string">'transparent url('</span> + <span class="hljs-keyword">this</span>.url + <span class="hljs-string">') no-repeat scroll center'</span>);
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data) {
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data.isStar) {
                    <span class="hljs-keyword">this</span>.tileSizeInPx = <span class="hljs-keyword">this</span>.map.tileSizeInPx * <span class="hljs-number">3</span>;
                    <span class="hljs-keyword">var</span> q = <span class="hljs-keyword">this</span>.map.tileSizeInPx;
                    <span class="hljs-keyword">this</span>.offsetX = <span class="hljs-keyword">this</span>.origOffsetX - q;
                    <span class="hljs-keyword">this</span>.offsetY = <span class="hljs-keyword">this</span>.origOffsetY - q;
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">this</span>.tileSizeInPx = <span class="hljs-keyword">this</span>.map.tileSizeInPx;
                    <span class="hljs-keyword">this</span>.offsetX = <span class="hljs-keyword">this</span>.origOffsetX;
                    <span class="hljs-keyword">this</span>.offsetY = <span class="hljs-keyword">this</span>.origOffsetY;
                }
                Dom.setStyle(<span class="hljs-keyword">this</span>.domElement, <span class="hljs-string">"width"</span>, <span class="hljs-string">''</span> + <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.domElement, <span class="hljs-string">"height"</span>, <span class="hljs-string">''</span> + <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.domElement, <span class="hljs-string">"left"</span>, <span class="hljs-string">''</span> + <span class="hljs-keyword">this</span>.offsetX + <span class="hljs-string">'px'</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.domElement, <span class="hljs-string">"top"</span>, <span class="hljs-string">''</span> + <span class="hljs-keyword">this</span>.offsetY + <span class="hljs-string">'px'</span>);
            }
            <span class="hljs-keyword">this</span>.init();
        },
        _createImage: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.imageHolder) {
                <span class="hljs-keyword">var</span> image = <span class="hljs-keyword">this</span>.domElement.appendChild(document.createElement(<span class="hljs-string">'div'</span>));
                Dom.setStyle(image, <span class="hljs-string">"width"</span>, <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                Dom.setStyle(image, <span class="hljs-string">"height"</span>, <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                Dom.setStyle(image, <span class="hljs-string">"position"</span>, <span class="hljs-string">"absolute"</span>);
                Dom.setStyle(image, <span class="hljs-string">"top"</span>, <span class="hljs-string">"0"</span>);
                Dom.setStyle(image, <span class="hljs-string">"left"</span>, <span class="hljs-string">"0"</span>);
                <span class="hljs-keyword">this</span>.imageHolder = image;
            }
            <span class="hljs-keyword">this</span>._buildFissureHolder();
            <span class="hljs-keyword">this</span>._buildLogoHolder();
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data.orbit) {
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.map.hidePlanets) {
                    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>.data.type) {
                        <span class="hljs-keyword">case</span> <span class="hljs-string">'habitable planet'</span>:
                            <span class="hljs-keyword">this</span>.imageHolder.innerHTML = <span class="hljs-string">"H"</span>;
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-string">'gas giant'</span>:
                            <span class="hljs-keyword">this</span>.imageHolder.innerHTML = <span class="hljs-string">"G"</span>;
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-string">'asteroid'</span>:
                            <span class="hljs-keyword">this</span>.imageHolder.innerHTML = <span class="hljs-string">"A"</span>;
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-string">'space station'</span>:
                            <span class="hljs-keyword">this</span>.imageHolder.innerHTML = <span class="hljs-string">"S"</span>;
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">default</span>:
                            <span class="hljs-keyword">this</span>.imageHolder.innerHTML = <span class="hljs-string">"U"</span>;
                            <span class="hljs-keyword">break</span>;
                    }
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> pSize = ((<span class="hljs-number">100</span> - <span class="hljs-built_in">Math</span>.abs(<span class="hljs-keyword">this</span>.data.size - <span class="hljs-number">100</span>)) / (<span class="hljs-number">100</span> / <span class="hljs-keyword">this</span>.tileSizeInPx)) + <span class="hljs-number">15</span>;
                    <span class="hljs-keyword">this</span>.imageHolder.innerHTML = [<span class="hljs-string">'&lt;img src="'</span>, <span class="hljs-keyword">this</span>.image, <span class="hljs-string">'" class="planet planet'</span>, <span class="hljs-keyword">this</span>.data.orbit, <span class="hljs-string">'" style="width:'</span>, pSize, <span class="hljs-string">'px;height:'</span>, pSize, <span class="hljs-string">'px;margin-top:'</span>, <span class="hljs-built_in">Math</span>.floor(((<span class="hljs-keyword">this</span>.tileSizeInPx - pSize) / <span class="hljs-number">2</span>)), <span class="hljs-string">'px;" /&gt;'</span>].join(<span class="hljs-string">''</span>);
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data.body_has_fissure) {
                        <span class="hljs-keyword">this</span>.fissureHolder.innerHTML = [<span class="hljs-string">'&lt;img src="'</span>, Lib.AssetUrl, <span class="hljs-string">'star_map/fissure_icon.png" class="planet" style="width:'</span>, pSize, <span class="hljs-string">'px;height:'</span>, pSize, <span class="hljs-string">'px;margin-top:'</span>, <span class="hljs-built_in">Math</span>.floor(((<span class="hljs-keyword">this</span>.tileSizeInPx - pSize) / <span class="hljs-number">2</span>)), <span class="hljs-string">'px;" /&gt;'</span>].join(<span class="hljs-string">''</span>);
                    }
                }
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data.station) {
                    <span class="hljs-keyword">var</span> station = <span class="hljs-keyword">this</span>.data.station;
                    <span class="hljs-keyword">var</span> pSize = <span class="hljs-keyword">this</span>.tileSizeInPx;
                    <span class="hljs-keyword">this</span>.logoHolder.innerHTML = [<span class="hljs-string">'&lt;img src="'</span>, Lib.AssetUrl, <span class="hljs-string">'alliances/'</span>, station.alliance.image, <span class="hljs-string">'.png" class="star" style="width:'</span>, pSize, <span class="hljs-string">'px;height:'</span>, pSize, <span class="hljs-string">'px;" /&gt;'</span>].join(<span class="hljs-string">''</span>);
                }
                <span class="hljs-keyword">this</span>.imageHolder.innerHTML = [<span class="hljs-string">'&lt;img src="'</span>, <span class="hljs-keyword">this</span>.image, <span class="hljs-string">'" class="star" style="width:'</span>, <span class="hljs-keyword">this</span>.tileSizeInPx, <span class="hljs-string">'px;height:'</span>, <span class="hljs-keyword">this</span>.tileSizeInPx, <span class="hljs-string">'px;" /&gt;'</span>].join(<span class="hljs-string">''</span>);
            }
        },
        _createAlignments: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data.empire &amp;&amp; <span class="hljs-keyword">this</span>.data.empire.alignment) {
                <span class="hljs-keyword">this</span>._buildAlignmentHolder();
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data.orbit) {
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.map.hidePlanets) {
                        Dom.addClass(<span class="hljs-keyword">this</span>.alignHolder, <span class="hljs-keyword">this</span>.data.empire.alignment);
                    }
                    <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">var</span> pSize = ((<span class="hljs-number">100</span> - <span class="hljs-built_in">Math</span>.abs(<span class="hljs-keyword">this</span>.data.size - <span class="hljs-number">100</span>)) / (<span class="hljs-number">100</span> / <span class="hljs-keyword">this</span>.tileSizeInPx)) + <span class="hljs-number">15</span>;
                        <span class="hljs-keyword">this</span>.alignHolder.innerHTML = [<span class="hljs-string">'&lt;img src="'</span>, Lib.AssetUrl, <span class="hljs-string">'star_map/'</span>, <span class="hljs-keyword">this</span>.data.empire.alignment, <span class="hljs-string">'.png" class="planet" style="width:'</span>, pSize, <span class="hljs-string">'px;height:'</span>, pSize, <span class="hljs-string">'px;margin-top:'</span>, <span class="hljs-built_in">Math</span>.floor(((<span class="hljs-keyword">this</span>.tileSizeInPx - pSize) / <span class="hljs-number">2</span>)), <span class="hljs-string">'px;" /&gt;'</span>].join(<span class="hljs-string">''</span>);
                    }
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">this</span>.alignHolder.innerHTML = [<span class="hljs-string">'&lt;img src="'</span>, Lib.AssetUrl, <span class="hljs-string">'star_map/'</span>, <span class="hljs-keyword">this</span>.data.empire.alignment, <span class="hljs-string">'.png" class="star" style="width:'</span>, <span class="hljs-keyword">this</span>.tileSizeInPx, <span class="hljs-string">'px;height:'</span>, <span class="hljs-keyword">this</span>.tileSizeInPx, <span class="hljs-string">'px;" /&gt;'</span>].join(<span class="hljs-string">''</span>);
                }
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.map.hidePlanets &amp;&amp; <span class="hljs-keyword">this</span>.data.orbit) {
                <span class="hljs-keyword">this</span>._buildAlignmentHolder();
                Dom.addClass(<span class="hljs-keyword">this</span>.alignHolder, <span class="hljs-string">'probed'</span>);
            }
        },
        _buildLogoHolder: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.logoHolder) {
                <span class="hljs-keyword">var</span> logo = <span class="hljs-keyword">this</span>.domElement.appendChild(document.createElement(<span class="hljs-string">'div'</span>));
                Dom.setStyle(logo, <span class="hljs-string">"width"</span>, <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                Dom.setStyle(logo, <span class="hljs-string">"height"</span>, <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                Dom.setStyle(logo, <span class="hljs-string">"position"</span>, <span class="hljs-string">"absolute"</span>);
                Dom.setStyle(logo, <span class="hljs-string">"top"</span>, <span class="hljs-string">"0"</span>);
                Dom.setStyle(logo, <span class="hljs-string">"left"</span>, <span class="hljs-string">"0"</span>);
                Dom.setStyle(logo, <span class="hljs-string">"z-index"</span>, <span class="hljs-string">'3'</span>);
                <span class="hljs-keyword">this</span>.logoHolder = logo;
            }
        },
        _buildFissureHolder: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.fissureHolder) {
                <span class="hljs-keyword">var</span> fissure = <span class="hljs-keyword">this</span>.domElement.appendChild(document.createElement(<span class="hljs-string">'div'</span>));
                Dom.setStyle(fissure, <span class="hljs-string">"width"</span>, <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                Dom.setStyle(fissure, <span class="hljs-string">"height"</span>, <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                Dom.setStyle(fissure, <span class="hljs-string">"position"</span>, <span class="hljs-string">"absolute"</span>);
                Dom.setStyle(fissure, <span class="hljs-string">"top"</span>, <span class="hljs-string">"0"</span>);
                Dom.setStyle(fissure, <span class="hljs-string">"left"</span>, <span class="hljs-string">"0"</span>);
                Dom.setStyle(fissure, <span class="hljs-string">"z-index"</span>, <span class="hljs-string">'3'</span>);
                <span class="hljs-keyword">this</span>.fissureHolder = fissure;
            }
        },
        _buildAlignmentHolder: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.alignHolder) {
                <span class="hljs-keyword">var</span> align = <span class="hljs-keyword">this</span>.domElement.appendChild(document.createElement(<span class="hljs-string">'div'</span>));
                Dom.setStyle(align, <span class="hljs-string">"width"</span>, <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                Dom.setStyle(align, <span class="hljs-string">"height"</span>, <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                Dom.setStyle(align, <span class="hljs-string">"position"</span>, <span class="hljs-string">"absolute"</span>);
                Dom.setStyle(align, <span class="hljs-string">"top"</span>, <span class="hljs-string">"0"</span>);
                Dom.setStyle(align, <span class="hljs-string">"left"</span>, <span class="hljs-string">"0"</span>);
                Dom.setStyle(align, <span class="hljs-string">"z-index"</span>, <span class="hljs-string">'2'</span>);
                <span class="hljs-keyword">this</span>.alignHolder = align;
            }
        }
    });
    Mapper.PlanetTile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, z, ox, oy, layer)</span> {</span>
        Mapper.PlanetTile.superclass.constructor.call(<span class="hljs-keyword">this</span>, x, y, z, ox, oy, layer);
        Dom.addClass(<span class="hljs-keyword">this</span>.domElement, <span class="hljs-string">"tile"</span> + <span class="hljs-keyword">this</span>.tileSizeInPx);
    };
    Lang.extend(Mapper.PlanetTile, Tile, {
        init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.domElement.title = <span class="hljs-keyword">this</span>.data ? <span class="hljs-keyword">this</span>.data.name : <span class="hljs-string">"Ground"</span>;
            <span class="hljs-keyword">this</span>._createActionIcon();
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data &amp;&amp; <span class="hljs-keyword">this</span>.data.efficiency * <span class="hljs-number">1</span> &lt; <span class="hljs-number">100</span>) {
                <span class="hljs-keyword">this</span>._createEfficiencyBar(<span class="hljs-keyword">this</span>.data.efficiency * <span class="hljs-number">1</span>);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cBar) {
                <span class="hljs-keyword">this</span>.cBar.parentNode.removeChild(<span class="hljs-keyword">this</span>.cBar);
                <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.cBar;
                <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.eBar;
            }
            <span class="hljs-keyword">this</span>.startTick();
            <span class="hljs-comment">/*if(this.data &amp;&amp; this.data.pending_build) {
            this._createCounter();
            var remaining = Math.round(this.data.pending_build.seconds_remaining);
            if (remaining &lt; 0) {
                remaining = 0;
            }
            this.counterBuild.innerHTML = Lib.formatTime(remaining);
        }
        else if(this.counterBuild) {
            this.counterBuild.parentNode.removeChild(this.counterBuild);
            delete this.counterBuild;
        }*/</span>
        },
        refresh: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            Mapper.PlanetTile.superclass.refresh.call(<span class="hljs-keyword">this</span>);
            <span class="hljs-keyword">this</span>.init();
        },
        appendToDom: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.domElement &amp;&amp; !Dom.isAncestor(<span class="hljs-keyword">this</span>.layer.tileContainer, <span class="hljs-keyword">this</span>.domElement)) {
                <span class="hljs-keyword">this</span>.layer.tileContainer.appendChild(<span class="hljs-keyword">this</span>.domElement);
            }
        },
        remove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.stopTick();
            Mapper.PlanetTile.superclass.remove.call(<span class="hljs-keyword">this</span>);
        },
        startTick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data) {
                <span class="hljs-keyword">var</span> subTick;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data.pending_build &amp;&amp; <span class="hljs-keyword">this</span>.data.pending_build.seconds_remaining &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">this</span>._createBuildCounter();
                    subTick = <span class="hljs-literal">true</span>;
                }
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.counterBuild) {
                    <span class="hljs-keyword">this</span>.counterBuild.parentNode.removeChild(<span class="hljs-keyword">this</span>.counterBuild);
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.counterBuild;
                }
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data.work &amp;&amp; <span class="hljs-keyword">this</span>.data.work.seconds_remaining &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">this</span>._createWorkCounter();
                    subTick = <span class="hljs-literal">true</span>;
                }
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.counterWork) {
                    <span class="hljs-keyword">this</span>.counterWork.parentNode.removeChild(<span class="hljs-keyword">this</span>.counterWork);
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.counterWork;
                }
                <span class="hljs-keyword">if</span> (subTick &amp;&amp; !<span class="hljs-keyword">this</span>.isTicking) {
                    <span class="hljs-keyword">this</span>.isTicking = <span class="hljs-literal">true</span>;
                    Game.onTick.subscribe(<span class="hljs-keyword">this</span>.tick, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                }
            }
        },
        stopTick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isTicking) {
                Game.onTick.unsubscribe(<span class="hljs-keyword">this</span>.tick, <span class="hljs-keyword">this</span>);
                <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.isTicking;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.counterBuild) {
                    <span class="hljs-keyword">this</span>.counterBuild.parentNode.removeChild(<span class="hljs-keyword">this</span>.counterBuild);
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.counterBuild;
                }
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.counterWork) {
                    <span class="hljs-keyword">this</span>.counterWork.parentNode.removeChild(<span class="hljs-keyword">this</span>.counterWork);
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.counterWork;
                }
            }
        },
        finishTick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.stopTick();
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data.pending_build &amp;&amp; <span class="hljs-keyword">this</span>.data.upgrade) {
                <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.data.pending_build;
                <span class="hljs-keyword">this</span>.data.level = (<span class="hljs-keyword">this</span>.data.level * <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;
                <span class="hljs-keyword">this</span>.data.image = <span class="hljs-keyword">this</span>.data.upgrade.image;
                <span class="hljs-keyword">this</span>.map.addSingleTileData(<span class="hljs-keyword">this</span>.data);
                <span class="hljs-keyword">this</span>.refresh();
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onReload"</span>, <span class="hljs-keyword">this</span>);
            }
        },
        tick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, oArgs)</span> {</span>
            <span class="hljs-keyword">var</span> tickSec = oArgs[<span class="hljs-number">0</span>] / <span class="hljs-number">1000</span>,
                hasUpgrade, hasWork;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data.pending_build) {
                <span class="hljs-keyword">this</span>.data.pending_build.seconds_remaining -= tickSec;
                <span class="hljs-keyword">var</span> remainingBuild = <span class="hljs-built_in">Math</span>.round(<span class="hljs-keyword">this</span>.data.pending_build.seconds_remaining);
                <span class="hljs-keyword">var</span> upgrade = <span class="hljs-keyword">this</span>.data.upgrade;
                <span class="hljs-keyword">if</span> (remainingBuild &gt; <span class="hljs-number">0</span> &amp;&amp; remainingBuild &lt; <span class="hljs-number">15</span> &amp;&amp; upgrade &amp;&amp; upgrade.image &amp;&amp; !upgrade.preloaded) {
                    upgrade.preloaded = <span class="hljs-literal">true</span>;
                    <span class="hljs-keyword">var</span> imgSize = <span class="hljs-keyword">this</span>.map.getTileImageSize();
                    <span class="hljs-keyword">var</span> img = <span class="hljs-keyword">new</span> Image();
                    img.src = [Lib.AssetUrl, <span class="hljs-string">'planet_side/'</span>, imgSize, upgrade.image, <span class="hljs-string">'.png'</span>].join(<span class="hljs-string">''</span>);
                }
                <span class="hljs-keyword">if</span> (remainingBuild &lt; <span class="hljs-number">0</span>) {
                    remainingBuild = <span class="hljs-number">0</span>;
                }
                hasUpgrade = remainingBuild &gt; <span class="hljs-number">0</span>;
                <span class="hljs-keyword">this</span>.counterBuild.innerHTML = Lib.formatTime(remainingBuild);
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data.work) {
                <span class="hljs-keyword">this</span>.data.work.seconds_remaining -= tickSec;
                <span class="hljs-keyword">var</span> remainingWork = <span class="hljs-built_in">Math</span>.round(<span class="hljs-keyword">this</span>.data.work.seconds_remaining);
                <span class="hljs-keyword">if</span> (remainingWork &lt; <span class="hljs-number">0</span>) {
                    remainingWork = <span class="hljs-number">0</span>;
                }
                hasWork = remainingWork &gt; <span class="hljs-number">0</span>;
                <span class="hljs-keyword">this</span>.counterWork.innerHTML = Lib.formatTime(remainingWork);
            }
            <span class="hljs-keyword">if</span> (!hasUpgrade &amp;&amp; !hasWork) {
                <span class="hljs-keyword">this</span>.finishTick();
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!hasUpgrade &amp;&amp; <span class="hljs-keyword">this</span>.data.pending_build &amp;&amp; <span class="hljs-keyword">this</span>.data.pending_build.seconds_remaining &lt;= <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">this</span>.finishTick();
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!hasWork &amp;&amp; <span class="hljs-keyword">this</span>.data.work &amp;&amp; <span class="hljs-keyword">this</span>.data.work.seconds_remaining &lt;= <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">this</span>.finishTick();
            }
        },
        refreshCounter: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.map.getTile(<span class="hljs-keyword">this</span>.x, <span class="hljs-keyword">this</span>.y, <span class="hljs-keyword">this</span>.z);
            <span class="hljs-keyword">this</span>.blank = obj.blank;
            <span class="hljs-keyword">this</span>.url = obj.url;
            <span class="hljs-keyword">this</span>.data = obj.data;
            <span class="hljs-comment">//make sure we're ticking if we need too</span>
            <span class="hljs-keyword">this</span>.startTick();</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><pre><code>    if(!(this<span class="hljs-preprocessor">.data</span> &amp;&amp; this<span class="hljs-preprocessor">.data</span><span class="hljs-preprocessor">.pending</span>_build &amp;&amp; this<span class="hljs-preprocessor">.data</span><span class="hljs-preprocessor">.pending</span>_build<span class="hljs-preprocessor">.seconds</span>_remaining &gt; <span class="hljs-number">0.1</span>)) {
</code></pre><p>this.counterBuild.parentNode.removeChild(this.counterBuild);
delete this.counterBuild;
        }
        if(this.data &amp;&amp; this.data.pending_build &amp;&amp; this.data.pending_build.seconds_remaining &gt; 0.5) {
this._createCounter();
var remaining = Math.round(this.data.pending_build.seconds_remaining);
if (remaining &lt; 0) {
    remaining = 0;
}
this.counterBuild.innerHTML = Lib.formatTime(remaining);
        }
        else {
this.counterBuild.parentNode.removeChild(this.counterBuild);
delete this.counterBuild;
        }</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">        },
        _createBuildCounter: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.counterBuild) {
                <span class="hljs-keyword">var</span> counterBuild = <span class="hljs-keyword">this</span>.domElement.appendChild(document.createElement(<span class="hljs-string">'div'</span>));
                Dom.addClass(counterBuild, <span class="hljs-string">"planetMapTileCounter"</span>);
                Dom.setStyle(counterBuild, <span class="hljs-string">"width"</span>, <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                Dom.setStyle(counterBuild, <span class="hljs-string">"height"</span>, <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                <span class="hljs-keyword">this</span>.counterBuild = counterBuild;
            }
        },
        _createWorkCounter: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.counterWork) {
                <span class="hljs-keyword">var</span> counterWork = <span class="hljs-keyword">this</span>.domElement.appendChild(document.createElement(<span class="hljs-string">'div'</span>));
                Dom.addClass(counterWork, <span class="hljs-string">"planetMapTileCounterWork"</span>);
                <span class="hljs-comment">//Dom.setStyle(counterWork, "width", this.tileSizeInPx + 'px');</span>
                <span class="hljs-comment">//Dom.setStyle(counterWork, "height", this.tileSizeInPx + 'px');</span>
                <span class="hljs-keyword">this</span>.counterWork = counterWork;
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cBar) {
                Dom.setStyle(<span class="hljs-keyword">this</span>.counterWork, <span class="hljs-string">"bottom"</span>, <span class="hljs-string">"20px"</span>);
            }
            <span class="hljs-keyword">else</span> {
                Dom.setStyle(<span class="hljs-keyword">this</span>.counterWork, <span class="hljs-string">"bottom"</span>, <span class="hljs-string">"0"</span>);
            }
        },
        _createActionIcon: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.actionIcon) {
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data) {
                    <span class="hljs-keyword">this</span>.actionIcon.innerHTML = [<span class="hljs-string">'&lt;div class="planetMapTileActionLevel"&gt;'</span>, <span class="hljs-keyword">this</span>.data.level, <span class="hljs-string">'&lt;/div&gt;'</span>].join(<span class="hljs-string">''</span>);
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">this</span>.actionIcon.innerHTML = <span class="hljs-string">'&lt;div class="planetMapTileActionButton"&gt;&lt;/div&gt;'</span>;
                }
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> div = <span class="hljs-keyword">this</span>.domElement.appendChild(document.createElement(<span class="hljs-string">'div'</span>));
                Dom.addClass(div, <span class="hljs-string">"planetMapTileActionContainer"</span>);
                Dom.setStyle(div, <span class="hljs-string">"width"</span>, <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                Dom.setStyle(div, <span class="hljs-string">"height"</span>, <span class="hljs-built_in">Math</span>.round(<span class="hljs-keyword">this</span>.tileSizeInPx / <span class="hljs-number">2</span>) + <span class="hljs-string">'px'</span>);
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data) {
                    <span class="hljs-keyword">if</span> (Game.GetCookieSettings(<span class="hljs-string">"showLevels"</span>, <span class="hljs-string">"0"</span>) === <span class="hljs-string">"1"</span>) {
                        Dom.setStyle(div, <span class="hljs-string">"visibility"</span>, <span class="hljs-string">"visible"</span>);
                    }
                    div.innerHTML = [<span class="hljs-string">'&lt;div class="planetMapTileActionLevel"&gt;'</span>, <span class="hljs-keyword">this</span>.data.level, <span class="hljs-string">'&lt;/div&gt;'</span>].join(<span class="hljs-string">''</span>);
                }
                <span class="hljs-keyword">else</span> {
                    div.innerHTML = <span class="hljs-string">'&lt;div class="planetMapTileActionButton"&gt;&lt;/div&gt;'</span>;
                }
                <span class="hljs-keyword">this</span>.actionIcon = div;
            }
        },
        _createEfficiencyBar: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(efficiency)</span> {</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.cBar) {
                <span class="hljs-keyword">var</span> bar = <span class="hljs-keyword">this</span>.domElement.appendChild(document.createElement(<span class="hljs-string">'div'</span>));
                Dom.addClass(bar, <span class="hljs-string">"planetMapEfficiencyBarContainer"</span>);
                Dom.setStyle(bar, <span class="hljs-string">"width"</span>, <span class="hljs-keyword">this</span>.tileSizeInPx + <span class="hljs-string">'px'</span>);
                <span class="hljs-keyword">this</span>.eBar = bar.appendChild(document.createElement(<span class="hljs-string">'div'</span>));
                Dom.addClass(<span class="hljs-keyword">this</span>.eBar, <span class="hljs-string">"planetMapEfficiencyBar"</span>);
                <span class="hljs-keyword">this</span>.cBar = bar;
            }
            Dom.setStyle(<span class="hljs-keyword">this</span>.eBar, <span class="hljs-string">"width"</span>, <span class="hljs-built_in">Math</span>.floor(<span class="hljs-keyword">this</span>.tileSizeInPx * (efficiency / <span class="hljs-number">100</span>)) + <span class="hljs-string">'px'</span>);
            <span class="hljs-keyword">this</span>.eBar.innerHTML = efficiency + <span class="hljs-string">"%"</span>;
            <span class="hljs-keyword">if</span> (efficiency &gt; <span class="hljs-number">60</span>) {
                Dom.setStyle(<span class="hljs-keyword">this</span>.cBar, <span class="hljs-string">"border-color"</span>, <span class="hljs-string">'yellow'</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.eBar, <span class="hljs-string">"background-color"</span>, <span class="hljs-string">'yellow'</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.eBar, <span class="hljs-string">"color"</span>, <span class="hljs-string">'black'</span>);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (efficiency &gt; <span class="hljs-number">30</span>) {
                Dom.setStyle(<span class="hljs-keyword">this</span>.cBar, <span class="hljs-string">"border-color"</span>, <span class="hljs-string">'orange'</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.eBar, <span class="hljs-string">"background-color"</span>, <span class="hljs-string">'orange'</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.eBar, <span class="hljs-string">"color"</span>, <span class="hljs-string">'white'</span>);
            }
            <span class="hljs-keyword">else</span> {
                Dom.setStyle(<span class="hljs-keyword">this</span>.cBar, <span class="hljs-string">"border-color"</span>, <span class="hljs-string">'red'</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.eBar, <span class="hljs-string">"background-color"</span>, <span class="hljs-string">'red'</span>);
                Dom.setStyle(<span class="hljs-keyword">this</span>.eBar, <span class="hljs-string">"color"</span>, <span class="hljs-string">'white'</span>);
            }
        }
    });
    Mapper.CoordLayer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(map)</span> {</span>
        <span class="hljs-keyword">this</span>.map = map;
        <span class="hljs-keyword">this</span>.offsetX = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.offsetY = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.div = document.createElement(<span class="hljs-string">'div'</span>); <span class="hljs-comment">//so we can clone it a lot</span>
    };
    Mapper.CoordLayer.prototype = {
        startDrag: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasAnim) {
                <span class="hljs-keyword">this</span>.xAnimOff.stop();
                <span class="hljs-keyword">this</span>.xAnimOn.animate();
                <span class="hljs-keyword">this</span>.yAnimOff.stop();
                <span class="hljs-keyword">this</span>.yAnimOn.animate();
            }
        },
        endDrag: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasAnim) {
                <span class="hljs-keyword">this</span>.xAnimOff.animate();
                <span class="hljs-keyword">this</span>.yAnimOff.animate();
            }
        },
        move: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y)</span> {</span></pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>the coordinate div is inside the movable container
start by repositioning to match the current view</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">this</span>.offsetX += x;
            <span class="hljs-keyword">this</span>.offsetY += y;
            <span class="hljs-keyword">this</span>.containerDiv.style.left = <span class="hljs-string">''</span> + <span class="hljs-keyword">this</span>.offsetX + <span class="hljs-string">'px'</span>;
            <span class="hljs-keyword">this</span>.containerDiv.style.top = <span class="hljs-string">''</span> + <span class="hljs-keyword">this</span>.offsetY + <span class="hljs-string">'px'</span>;
            <span class="hljs-keyword">this</span>.offsetCoordsX -= x;
            <span class="hljs-keyword">this</span>.offsetCoordsY -= y;
            <span class="hljs-keyword">var</span> tileSize = <span class="hljs-keyword">this</span>.map.tileSizeInPx;
            <span class="hljs-keyword">var</span> left = <span class="hljs-keyword">this</span>.offsetCoordsX % tileSize;
            <span class="hljs-keyword">if</span> (left &gt;= <span class="hljs-number">0</span>) {
                left -= tileSize;
            }
            <span class="hljs-keyword">var</span> top = <span class="hljs-keyword">this</span>.offsetCoordsY % tileSize;
            <span class="hljs-keyword">if</span> (top &gt;= <span class="hljs-number">0</span>) {
                top -= tileSize;
            }
            <span class="hljs-keyword">this</span>.xCoords.style.left = left + <span class="hljs-string">'px'</span>;
            <span class="hljs-keyword">this</span>.yCoords.style.top = top + <span class="hljs-string">'px'</span>;
            <span class="hljs-keyword">var</span> i, coord, el;
            <span class="hljs-keyword">var</span> startX = <span class="hljs-built_in">Math</span>.ceil(-<span class="hljs-number">1</span> * <span class="hljs-keyword">this</span>.offsetCoordsX / tileSize) - <span class="hljs-number">1</span>,
                xEls = <span class="hljs-keyword">this</span>.xCoordTiles,
                xMin = <span class="hljs-keyword">this</span>.map.maxBounds.x1Left,
                xMax = <span class="hljs-keyword">this</span>.map.maxBounds.x2Right;
            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; xEls.length; i++) {
                el = xEls[i];
                coord = startX + i;
                <span class="hljs-keyword">if</span> (coord &lt; xMin || coord &gt; xMax) {
                    Dom.addClass(el, <span class="hljs-string">'out-of-bounds'</span>);
                    el.innerHTML = <span class="hljs-string">''</span>;
                }
                <span class="hljs-keyword">else</span> {
                    Dom.removeClass(el, <span class="hljs-string">'out-of-bounds'</span>);
                    el.innerHTML = coord;
                }
            }
            <span class="hljs-keyword">var</span> startY = <span class="hljs-built_in">Math</span>.ceil(<span class="hljs-keyword">this</span>.offsetCoordsY / tileSize) - <span class="hljs-number">1</span>,
                yEls = <span class="hljs-keyword">this</span>.yCoordTiles,
                yMin = <span class="hljs-keyword">this</span>.map.maxBounds.y2Bottom,
                yMax = <span class="hljs-keyword">this</span>.map.maxBounds.y1Top;
            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; yEls.length; i++) {
                el = yEls[i];
                coord = startY - i + <span class="hljs-number">1</span>;
                <span class="hljs-keyword">if</span> (coord &lt; yMin || coord &gt; yMax) {
                    Dom.addClass(el, <span class="hljs-string">'out-of-bounds'</span>);
                    el.innerHTML = <span class="hljs-string">''</span>;
                }
                <span class="hljs-keyword">else</span> {
                    Dom.removeClass(el, <span class="hljs-string">'out-of-bounds'</span>);
                    el.innerHTML = coord;
                }
            }
        },
        resize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.displayXCoords();
            <span class="hljs-keyword">this</span>.displayYCoords();
            <span class="hljs-keyword">this</span>.move(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        },
        redraw: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.containerDiv) {
                <span class="hljs-keyword">this</span>.map.movableContainer.removeChild(<span class="hljs-keyword">this</span>.containerDiv);
            }
            <span class="hljs-keyword">this</span>.containerDiv = <span class="hljs-keyword">this</span>.div.cloneNode(<span class="hljs-literal">false</span>);
            Dom.addClass(<span class="hljs-keyword">this</span>.containerDiv, <span class="hljs-string">"coordContainer"</span>);
            <span class="hljs-keyword">var</span> s = <span class="hljs-keyword">this</span>.containerDiv.style;
            s.position = <span class="hljs-string">'absolute'</span>;
            s.left = <span class="hljs-string">'0'</span>;
            s.top = <span class="hljs-string">'0'</span>;
            s.zIndex = <span class="hljs-string">'30'</span>;
            <span class="hljs-keyword">this</span>.offsetX = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">this</span>.offsetY = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">this</span>.offsetCoordsX = <span class="hljs-built_in">Math</span>.ceil((<span class="hljs-keyword">this</span>.map.visibleArea.left * <span class="hljs-keyword">this</span>.map.tileSizeInPx) / <span class="hljs-number">100</span>) * <span class="hljs-number">100</span>; <span class="hljs-comment">//Math.ceil( ((this.map.visibleArea.left * this.map.tileSizeInPx) + (0.5 * this.map.width)) / 100 ) * 100;</span>
            <span class="hljs-keyword">this</span>.offsetCoordsY = <span class="hljs-built_in">Math</span>.ceil((<span class="hljs-keyword">this</span>.map.visibleArea.top * <span class="hljs-keyword">this</span>.map.tileSizeInPx) / <span class="hljs-number">100</span>) * <span class="hljs-number">100</span>; <span class="hljs-comment">//Math.ceil( ((this.map.visibleArea.top * this.map.tileSizeInPx) + (0.5 * this.map.height)) / 100 ) * 100;</span>
            <span class="hljs-keyword">this</span>.displayXCoords();
            <span class="hljs-keyword">this</span>.displayYCoords();
            <span class="hljs-keyword">this</span>.map.movableContainer.appendChild(<span class="hljs-keyword">this</span>.containerDiv);
            <span class="hljs-keyword">this</span>.move(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            <span class="hljs-keyword">this</span>.endDrag();
        },
        displayXCoords: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.xCoords) {
                <span class="hljs-keyword">this</span>.xCoords.parentNode.removeChild(<span class="hljs-keyword">this</span>.xCoords);
            }
            <span class="hljs-keyword">var</span> anchor = <span class="hljs-keyword">this</span>.div.cloneNode(<span class="hljs-literal">false</span>);
            Dom.addClass(anchor, <span class="hljs-string">"coordTop"</span>);
            <span class="hljs-keyword">var</span> pxSize = <span class="hljs-keyword">this</span>.map.tileSizeInPx;
            <span class="hljs-keyword">var</span> numToDraw = <span class="hljs-built_in">Math</span>.ceil(<span class="hljs-keyword">this</span>.map.width / pxSize) + <span class="hljs-number">1</span>;
            <span class="hljs-keyword">var</span> xCoordTiles = [];
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; numToDraw; i++) {
                <span class="hljs-keyword">var</span> num = <span class="hljs-keyword">this</span>.div.cloneNode(<span class="hljs-literal">false</span>);
                Dom.addClass(num, <span class="hljs-string">"coordX"</span>);
                Dom.addClass(num, <span class="hljs-string">"coordX"</span> + pxSize);
                Dom.setStyle(num, <span class="hljs-string">"left"</span>, (i * pxSize - <span class="hljs-number">1</span>) + <span class="hljs-string">"px"</span>);
                Dom.setStyle(num, <span class="hljs-string">"width"</span>, pxSize + <span class="hljs-string">"px"</span>);
                xCoordTiles.push(num);
                anchor.appendChild(num);
            }
            <span class="hljs-keyword">this</span>.xCoords = <span class="hljs-keyword">this</span>.containerDiv.appendChild(anchor);
            <span class="hljs-keyword">this</span>.xCoordTiles = xCoordTiles;
            <span class="hljs-keyword">if</span> (!YAHOO.env.ua.ie &amp;&amp; !YAHOO.env.ua.gecko) {
                <span class="hljs-keyword">this</span>.xAnimOff = <span class="hljs-keyword">new</span> Util.Anim(<span class="hljs-keyword">this</span>.xCoords, {
                    opacity: {
                        to: <span class="hljs-number">0.3</span>
                    }
                }, <span class="hljs-number">10</span>);
                <span class="hljs-keyword">this</span>.xAnimOn = <span class="hljs-keyword">new</span> Util.Anim(<span class="hljs-keyword">this</span>.xCoords, {
                    opacity: {
                        to: <span class="hljs-number">1.0</span>
                    }
                }, <span class="hljs-number">0.2</span>);
                <span class="hljs-keyword">this</span>.hasAnim = <span class="hljs-number">1</span>;
            }
        },
        displayYCoords: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.yCoords) {
                <span class="hljs-keyword">this</span>.yCoords.parentNode.removeChild(<span class="hljs-keyword">this</span>.yCoords);
            }
            <span class="hljs-keyword">var</span> anchor = <span class="hljs-keyword">this</span>.div.cloneNode(<span class="hljs-literal">false</span>);
            Dom.addClass(anchor, <span class="hljs-string">"coordLeft"</span>);
            <span class="hljs-keyword">var</span> pxSize = <span class="hljs-keyword">this</span>.map.tileSizeInPx,
                thrd = <span class="hljs-built_in">Math</span>.ceil(pxSize / <span class="hljs-number">3</span>),
                sizeLeft = (pxSize - thrd) + <span class="hljs-string">"px"</span>,
                thrdTxt = thrd + <span class="hljs-string">"px"</span>;
            <span class="hljs-keyword">var</span> numToDraw = <span class="hljs-built_in">Math</span>.ceil(<span class="hljs-keyword">this</span>.map.height / pxSize) + <span class="hljs-number">1</span>;
            <span class="hljs-keyword">var</span> yCoordTiles = [];
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; numToDraw; i++) {
                <span class="hljs-keyword">var</span> num = <span class="hljs-keyword">this</span>.div.cloneNode(<span class="hljs-literal">false</span>);
                Dom.addClass(num, <span class="hljs-string">"coordY"</span>);
                Dom.addClass(num, <span class="hljs-string">"coordY"</span> + pxSize);
                Dom.setStyle(num, <span class="hljs-string">"height"</span>, sizeLeft);
                Dom.setStyle(num, <span class="hljs-string">"padding-top"</span>, thrdTxt);
                Dom.setStyle(num, <span class="hljs-string">"top"</span>, (i * pxSize - <span class="hljs-number">1</span>) + <span class="hljs-string">"px"</span>);
                yCoordTiles.push(num);
                anchor.appendChild(num);
            }
            <span class="hljs-keyword">this</span>.yCoords = <span class="hljs-keyword">this</span>.containerDiv.appendChild(anchor);
            <span class="hljs-keyword">this</span>.yCoordTiles = yCoordTiles;
            <span class="hljs-keyword">if</span> (!YAHOO.env.ua.ie &amp;&amp; !YAHOO.env.ua.gecko) {
                <span class="hljs-keyword">this</span>.yAnimOff = <span class="hljs-keyword">new</span> Util.Anim(<span class="hljs-keyword">this</span>.yCoords, {
                    opacity: {
                        to: <span class="hljs-number">0.3</span>
                    }
                }, <span class="hljs-number">10</span>);
                <span class="hljs-keyword">this</span>.yAnimOn = <span class="hljs-keyword">new</span> Util.Anim(<span class="hljs-keyword">this</span>.yCoords, {
                    opacity: {
                        to: <span class="hljs-number">1.0</span>
                    }
                }, <span class="hljs-number">0.2</span>);
                <span class="hljs-keyword">this</span>.hasAnim = <span class="hljs-number">1</span>;
            }
        }
    };
    <span class="hljs-keyword">var</span> TileLayer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(map, visibleArea, TileConstructor)</span> {</span>
        <span class="hljs-keyword">this</span>.tileCache = {};</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>tile layer expects map.movableContainer to be at the upper left corner of
the visibleArea on creation</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">        <span class="hljs-keyword">this</span>.map = map;
        <span class="hljs-keyword">this</span>.visibleArea = visibleArea;
        <span class="hljs-keyword">this</span>.TileConstructor = TileConstructor;
        <span class="hljs-keyword">var</span> offsetX = visibleArea.left % map.tileSizeInPx;
        <span class="hljs-keyword">var</span> offsetY = visibleArea.top % map.tileSizeInPx;
        <span class="hljs-keyword">this</span>.baseTileLoc = visibleArea.topLeftLoc();
        <span class="hljs-keyword">var</span> tileContainer = document.createElement(<span class="hljs-string">'div'</span>);
        Dom.addClass(tileContainer, <span class="hljs-string">"tileContainer"</span>);
        <span class="hljs-keyword">var</span> s = tileContainer.style;
        s.position = <span class="hljs-string">'absolute'</span>;
        s.left = offsetX + <span class="hljs-string">'px'</span>;
        s.top = offsetY + <span class="hljs-string">'px'</span>;
        s.zIndex = <span class="hljs-string">'10'</span>;</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>for debuging:
s.width = &#39;&#39;+visibleArea.width+&#39;px&#39;;
s.height = &#39;&#39;+visibleArea.height+&#39;px&#39;;
s.backgroundColor = &#39;#477&#39;;</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">        <span class="hljs-keyword">this</span>.tileContainer = map.movableContainer.appendChild(tileContainer);
        <span class="hljs-keyword">this</span>.createEvent(<span class="hljs-string">"onReloadTile"</span>);
        <span class="hljs-keyword">this</span>.render();
    };
    TileLayer.prototype = {
        findTile: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, zoom)</span> {</span>
            <span class="hljs-comment">//if(this.tileCache) {}</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tileCache[Tile.idFor(x, y, zoom)];
        },
        findTileById: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id)</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tileCache[id];
        },
        tileAtPosition: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y)</span> {</span>
            <span class="hljs-keyword">var</span> tileSizeInPx = <span class="hljs-keyword">this</span>.map.tileSizeInPx;
            <span class="hljs-keyword">return</span> [<span class="hljs-built_in">Math</span>.floor(x / tileSizeInPx), <span class="hljs-built_in">Math</span>.floor(y / tileSizeInPx)];
        },
        _getTiles: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x1, x2, y1, y2)</span> {</span>
            <span class="hljs-comment">//show anything we already have</span>
            <span class="hljs-keyword">this</span>._showCachedTiles();
            <span class="hljs-comment">//get any new tiles we need</span>
            <span class="hljs-keyword">this</span>.map.getTileData({
                success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">this</span>.showTiles();
                },
                scope: <span class="hljs-keyword">this</span>
            }, x1, x2, y1, y2);
        },
        onReloadTile: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tile)</span> {</span>
            <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onReloadTile"</span>, tile);
        },
        render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(getNew)</span> {</span>
            <span class="hljs-keyword">if</span> (getNew) {
                <span class="hljs-keyword">var</span> bounds = <span class="hljs-keyword">this</span>.visibleArea.coordBounds();
                <span class="hljs-keyword">this</span>._getTiles(bounds.x1, bounds.x2, bounds.y1, bounds.y2);
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.showTiles();
            }
        },
        removeAllTilesNotContainedIn: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(hash)</span> {</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.tileCache) {
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tileCache.hasOwnProperty(key) &amp;&amp; !hash[key]) {
                    <span class="hljs-keyword">var</span> tile = <span class="hljs-keyword">this</span>.tileCache[key];
                    tile.remove();
                }
            }
        },
        deleteCache: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.tileCache) {
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tileCache.hasOwnProperty(key)) {
                    <span class="hljs-keyword">this</span>.tileCache[key].destroy();
                }
            }
        },
        destroy: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.unsubscribeAll();
            <span class="hljs-keyword">this</span>.deleteCache();
            <span class="hljs-comment">//this.map.movableContainer.removeChild( this.tileContainer );</span>
            Event.purgeElement(<span class="hljs-keyword">this</span>.tileContainer);
            <span class="hljs-keyword">this</span>.tileContainer.parentNode.removeChild(<span class="hljs-keyword">this</span>.tileContainer);
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.tileContainer;
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.tileCache;
        },
        clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.removeAllTilesNotContainedIn({});
        },
        reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.removeAllTilesNotContainedIn({});
            <span class="hljs-keyword">this</span>.tileCache = {};
        }
    };
    Lang.augmentProto(TileLayer, Util.EventProvider);
    Mapper.StarTileLayer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(map, visibleArea, TileConstructor)</span> {</span>
        Mapper.StarTileLayer.superclass.constructor.call(<span class="hljs-keyword">this</span>, map, visibleArea, TileConstructor);
    };
    Lang.extend(Mapper.StarTileLayer, TileLayer, {
        _showCachedTiles: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tileCache) {
                <span class="hljs-keyword">var</span> bounds = <span class="hljs-keyword">this</span>.visibleArea.coordBounds();
                <span class="hljs-keyword">var</span> planets = Game.EmpireData.planetsByName || {};
                <span class="hljs-comment">//from left to right (smaller to bigger)</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> xc = bounds.x1; xc &lt;= bounds.x2; xc++) {
                    <span class="hljs-comment">//from bottom to top (smaller to bigger)</span>
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> yc = bounds.y2; yc &lt;= bounds.y1; yc++) {
                        <span class="hljs-keyword">var</span> tile = <span class="hljs-keyword">this</span>.findTile(xc, yc, <span class="hljs-keyword">this</span>.map.zoom);
                        <span class="hljs-keyword">if</span> (tile) {
                            <span class="hljs-keyword">if</span> (tile.data &amp;&amp; tile.data.name) {
                                <span class="hljs-keyword">if</span> (planets.hasOwnProperty(tile.data.name)) {
                                    <span class="hljs-keyword">if</span> (Lacuna.MapStar._map.tileCache[tile.x] &amp;&amp; Lacuna.MapStar._map.tileCache[tile.x][tile.y]) {
                                        <span class="hljs-keyword">delete</span> Lacuna.MapStar._map.tileCache[tile.x][tile.y]; <span class="hljs-comment">// Remove the planet from the cache</span>
                                    }
                                    tile.blank = <span class="hljs-literal">true</span>;
                                }
                            }
                            <span class="hljs-keyword">if</span> (tile.blank) {
                                tile.refresh();
                            }
                            tile.appendToDom();
                            tile.unsubscribeAll(); <span class="hljs-comment">//so we don't get multiple subs on the same tile</span>
                            tile.subscribe(<span class="hljs-string">"onReload"</span>, <span class="hljs-keyword">this</span>.onReloadTile, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        }
                    }
                }
            }
        },
        showTiles: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(refresh)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tileCache) {
                <span class="hljs-keyword">var</span> bounds = <span class="hljs-keyword">this</span>.visibleArea.coordBounds();
                <span class="hljs-keyword">var</span> tiles = {};
                <span class="hljs-comment">//from left to right (smaller to bigger)</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> xc = bounds.x1; xc &lt;= bounds.x2; xc++) {
                    <span class="hljs-comment">//from bottom to top (smaller to bigger)</span>
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> yc = bounds.y2; yc &lt;= bounds.y1; yc++) {
                        <span class="hljs-keyword">var</span> tile = <span class="hljs-keyword">this</span>.findTile(xc, yc, <span class="hljs-keyword">this</span>.map.zoom),
                            doSub;
                        <span class="hljs-keyword">if</span> (!tile) {
                            <span class="hljs-keyword">var</span> ox = (xc - <span class="hljs-keyword">this</span>.baseTileLoc[<span class="hljs-number">0</span>]) * <span class="hljs-keyword">this</span>.map.tileSizeInPx;
                            <span class="hljs-keyword">var</span> oy = ((yc * -<span class="hljs-number">1</span>) - <span class="hljs-keyword">this</span>.baseTileLoc[<span class="hljs-number">1</span>]) * <span class="hljs-keyword">this</span>.map.tileSizeInPx;
                            <span class="hljs-comment">//var offsets = this.visibleArea.getOffsetFromCoords(xc, xy, this.baseTileCoords[0], this.baseTileCoords[1]);</span>
                            tile = <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.TileConstructor(xc, yc, <span class="hljs-keyword">this</span>.map.zoom, ox, oy, <span class="hljs-keyword">this</span>);
                            <span class="hljs-keyword">this</span>.tileCache[tile.id] = tile;
                            tile.appendToDom();
                            doSub = <span class="hljs-literal">true</span>;
                        }
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (refresh) {
                            tile.refresh();
                            doSub = <span class="hljs-literal">true</span>;
                        }
                        <span class="hljs-keyword">else</span> {
                            <span class="hljs-keyword">if</span> (tile.blank) {
                                tile.refresh();
                            }
                            tile.appendToDom();
                            doSub = <span class="hljs-literal">true</span>;
                        }
                        <span class="hljs-keyword">if</span> (doSub) {
                            tile.unsubscribeAll(); <span class="hljs-comment">//so we don't get multiple subs on the same tile</span>
                            tile.subscribe(<span class="hljs-string">"onReload"</span>, <span class="hljs-keyword">this</span>.onReloadTile, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        }
                        tiles[tile.id] = tile;
                    }
                }
                <span class="hljs-keyword">this</span>.removeAllTilesNotContainedIn(tiles);
            }
        }
    });
    Mapper.PlanetTileLayer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(map, visibleArea, TileConstructor)</span> {</span>
        <span class="hljs-keyword">this</span>.bounds = {
            x1: map.maxBounds.x1Left,
            x2: map.maxBounds.x2Right,
            y1: map.maxBounds.y1Top,
            y2: map.maxBounds.y2Bottom
        };
        Mapper.PlanetTileLayer.superclass.constructor.call(<span class="hljs-keyword">this</span>, map, visibleArea, TileConstructor);
    };
    Lang.extend(Mapper.PlanetTileLayer, TileLayer, {
        _showCachedTiles: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tileCache) {
                <span class="hljs-keyword">var</span> bounds = <span class="hljs-keyword">this</span>.bounds;
                <span class="hljs-comment">//from left to right (smaller to bigger)</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> xc = bounds.x1; xc &lt;= bounds.x2; xc++) {
                    <span class="hljs-comment">//from bottom to top (smaller to bigger)</span>
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> yc = bounds.y2; yc &lt;= bounds.y1; yc++) {
                        <span class="hljs-keyword">var</span> tile = <span class="hljs-keyword">this</span>.findTile(xc, yc, <span class="hljs-keyword">this</span>.map.zoom);
                        <span class="hljs-keyword">if</span> (tile) {
                            <span class="hljs-keyword">if</span> (tile.blank) {
                                tile.refresh();
                            }
                            tile.appendToDom();
                            tile.unsubscribeAll(); <span class="hljs-comment">//so we don't get multiple subs on the same tile</span>
                            tile.subscribe(<span class="hljs-string">"onReload"</span>, <span class="hljs-keyword">this</span>.onReloadTile, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        }
                    }
                }
            }
        },
        showTiles: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(refresh)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tileCache) {
                <span class="hljs-keyword">var</span> bounds = <span class="hljs-keyword">this</span>.bounds;
                <span class="hljs-keyword">var</span> tiles = {};
                <span class="hljs-comment">//from left to right (smaller to bigger)</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> xc = bounds.x1; xc &lt;= bounds.x2; xc++) {
                    <span class="hljs-comment">//from bottom to top (smaller to bigger)</span>
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> yc = bounds.y2; yc &lt;= bounds.y1; yc++) {
                        <span class="hljs-keyword">var</span> tile = <span class="hljs-keyword">this</span>.findTile(xc, yc, <span class="hljs-keyword">this</span>.map.zoom),
                            doSub;
                        <span class="hljs-keyword">if</span> (!tile) {
                            <span class="hljs-keyword">var</span> ox = (xc - <span class="hljs-keyword">this</span>.baseTileLoc[<span class="hljs-number">0</span>]) * <span class="hljs-keyword">this</span>.map.tileSizeInPx;
                            <span class="hljs-keyword">var</span> oy = ((yc * -<span class="hljs-number">1</span>) - <span class="hljs-keyword">this</span>.baseTileLoc[<span class="hljs-number">1</span>]) * <span class="hljs-keyword">this</span>.map.tileSizeInPx;
                            <span class="hljs-comment">//var offsets = this.visibleArea.getOffsetFromCoords(xc, xy, this.baseTileCoords[0], this.baseTileCoords[1]);</span>
                            tile = <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.TileConstructor(xc, yc, <span class="hljs-keyword">this</span>.map.zoom, ox, oy, <span class="hljs-keyword">this</span>);
                            <span class="hljs-keyword">this</span>.tileCache[tile.id] = tile;
                            tile.appendToDom();
                            doSub = <span class="hljs-literal">true</span>;
                        }
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (refresh) {
                            tile.refresh();
                            doSub = <span class="hljs-literal">true</span>;
                        }
                        <span class="hljs-keyword">else</span> {
                            <span class="hljs-keyword">if</span> (tile.blank) {
                                tile.refresh();
                            }
                            tile.appendToDom();
                            doSub = <span class="hljs-literal">true</span>;
                        }
                        <span class="hljs-keyword">if</span> (doSub) {
                            tile.unsubscribeAll(); <span class="hljs-comment">//so we don't get multiple subs on the same tile</span>
                            tile.subscribe(<span class="hljs-string">"onReload"</span>, <span class="hljs-keyword">this</span>.onReloadTile, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
                        }
                        tiles[tile.id] = tile;
                    }
                }
            }
        }
    });
    <span class="hljs-keyword">var</span> Map = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(divId, options)</span> {</span>
        <span class="hljs-keyword">var</span> IE = <span class="hljs-string">'\v'</span> === <span class="hljs-string">'v'</span>; <span class="hljs-comment">// detect IE</span>
        <span class="hljs-keyword">this</span>.IE = IE;
        <span class="hljs-comment">//this.tileSizeInPx = undefined;</span>
        <span class="hljs-keyword">this</span>.maxZoom = <span class="hljs-number">15</span>;
        <span class="hljs-keyword">this</span>.minZoom = -<span class="hljs-number">15</span>;
        <span class="hljs-comment">//this.visibleArea = undefined;</span>
        <span class="hljs-comment">//this.centerX = 0;</span>
        <span class="hljs-comment">//this.centerY = 0;</span>
        <span class="hljs-keyword">this</span>.diffX = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.diffY = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>._pathsAndPolygons = {};
        <span class="hljs-keyword">this</span>._projectedPoints = {};
        <span class="hljs-keyword">this</span>.tileCache = {};
        <span class="hljs-keyword">this</span>.bounds = {};
        <span class="hljs-keyword">this</span>.maxBounds = {};
        <span class="hljs-keyword">this</span>.createEvent(<span class="hljs-string">"onReloadTile"</span>);
        <span class="hljs-keyword">this</span>.mapDiv = document.getElementById(divId);
        <span class="hljs-keyword">this</span>.mapDiv.style.overflow = <span class="hljs-string">"hidden"</span>;
        <span class="hljs-keyword">this</span>.movableContainer = <span class="hljs-keyword">new</span> Mapper.MovableContainer(<span class="hljs-keyword">this</span>.mapDiv);
        <span class="hljs-keyword">this</span>.init();
        <span class="hljs-keyword">this</span>.coordLayer = <span class="hljs-keyword">new</span> Mapper.CoordLayer(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">var</span> ua = navigator.userAgent;
        <span class="hljs-keyword">if</span> (ua.match(<span class="hljs-regexp">/iPhone|iPod|iPad/i</span>)) {
            <span class="hljs-keyword">this</span>.controller = <span class="hljs-keyword">new</span> Mapper.iPhoneController(<span class="hljs-keyword">this</span>);
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.controller = <span class="hljs-keyword">new</span> Mapper.TraditionalController(<span class="hljs-keyword">this</span>);
        }
    };
    Map.prototype = {
        <span class="hljs-comment">//blank init that will always get called.  override in sub classes to change defaults</span>
        init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>},</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>pX and pY are optional pixel coordinates. If set they
define the center of the map after the zoom. Otherwise
the center will be the same as before the zoom</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">        zoomIn: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-comment">//YAHOO.log("zooming in", "info", "Mapper.Map");</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.zoom &gt;= <span class="hljs-keyword">this</span>.maxZoom) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">this</span>.setZoomLevel(<span class="hljs-keyword">this</span>.zoom + <span class="hljs-number">1</span>);
            <span class="hljs-comment">//called by zoom display change //this.refresh();</span>
        },
        zoomOut: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-comment">//YAHOO.log("zooming out", "info", "Mapper.Map");</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.zoom &lt;= <span class="hljs-keyword">this</span>.minZoom) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">this</span>.setZoomLevel(<span class="hljs-keyword">this</span>.zoom - <span class="hljs-number">1</span>);
            <span class="hljs-comment">//called by zoom display change //this.refresh();</span>
        },
        setTileSizeInPx: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(size)</span> {</span>
            <span class="hljs-keyword">this</span>.tileSizeInPx = size;
            <span class="hljs-comment">//this.mapExtendInPx = this.tileSizeInPx * (1&lt;&lt;this.zoom);</span>
        },
        addElement: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span>
            <span class="hljs-keyword">this</span>._pathsAndPolygons[p.id] = p;
        },
        removeElement: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span>
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._pathsAndPolygons[p.id];
        },
        moveByTiles: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y)</span> {</span>
            <span class="hljs-keyword">var</span> absX = <span class="hljs-built_in">Math</span>.abs(x),
                absY = <span class="hljs-built_in">Math</span>.abs(y),
                durMS = absX &gt; absY ? <span class="hljs-keyword">this</span>.tileSizeInPx * absX : <span class="hljs-keyword">this</span>.tileSizeInPx * absY,
                <span class="hljs-comment">//get the longest duration if we're moving both x and y</span>
                totalX = x * <span class="hljs-keyword">this</span>.tileSizeInPx,
                totalY = y * <span class="hljs-keyword">this</span>.tileSizeInPx,
                stepX = <span class="hljs-built_in">Math</span>.round(totalX / durMS) || (x &lt; <span class="hljs-number">0</span> ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>),
                <span class="hljs-comment">//put this in to cover the possibility of total/dur rounding to 0. 0 will</span>
                stepY = <span class="hljs-built_in">Math</span>.round(totalY / durMS) || (y &lt; <span class="hljs-number">0</span> ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>),
                progX = <span class="hljs-number">0</span>,
                progY = <span class="hljs-number">0</span>,
                lastDuration = <span class="hljs-number">0</span>,
                anim = <span class="hljs-keyword">new</span> Util.Anim(<span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, durMS);
            anim.useSeconds = <span class="hljs-literal">false</span>; <span class="hljs-comment">//keep everything in ms</span>
            anim.onTween.subscribe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, data)</span> {</span>
                <span class="hljs-keyword">var</span> completed = data[<span class="hljs-number">0</span>].duration,
                    factor = completed - lastDuration,
                    moveX, moveY;
                lastDuration = completed;
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(progX) &gt;= <span class="hljs-built_in">Math</span>.abs(totalX)) {
                    moveX = <span class="hljs-number">0</span>;
                }
                <span class="hljs-keyword">else</span> {
                    moveX = stepX * factor;
                    progX += moveX;
                }
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(progY) &gt;= <span class="hljs-built_in">Math</span>.abs(totalY)) {
                    moveY = <span class="hljs-number">0</span>;
                }
                <span class="hljs-keyword">else</span> {
                    moveY = stepY * factor;
                    progY += moveY;
                }
                <span class="hljs-keyword">this</span>.moveByPx(moveX, moveY);
            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
            anim.animate();
        },
        moveByPx: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y)</span> {</span>
            <span class="hljs-keyword">var</span> n = <span class="hljs-keyword">this</span>.visibleArea.move(x * -<span class="hljs-number">1</span>, y * -<span class="hljs-number">1</span>);
            <span class="hljs-comment">//move values back to positive for us to use</span>
            x = n.x * -<span class="hljs-number">1</span>;
            y = n.y * -<span class="hljs-number">1</span>;
            <span class="hljs-keyword">this</span>.movableContainer.move(x, y);
            <span class="hljs-keyword">this</span>.coordLayer.move(x * -<span class="hljs-number">1</span>, y * -<span class="hljs-number">1</span>);</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><pre><code>    <span class="hljs-keyword">this</span>.diffX += x;
    <span class="hljs-keyword">this</span>.diffY += y;

    <span class="hljs-keyword">var</span> checkTileSize = <span class="hljs-keyword">this</span>.tileSizeInPx;
    <span class="hljs-keyword">if</span>( <span class="hljs-built_in">Math</span>.abs(<span class="hljs-keyword">this</span>.diffX) &gt; checkTileSize || <span class="hljs-built_in">Math</span>.abs(<span class="hljs-keyword">this</span>.diffY) &gt; checkTileSize) {
</code></pre><p>//reset diff&#39;s
this.diffX = this.diffY = 0;
this.tileLayer.render();
        }</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">"x"</span>: x,
                <span class="hljs-string">"y"</span>: y
            };
        },
        setZoomLevel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(level)</span> {</span>
            <span class="hljs-keyword">this</span>.zoom = level * <span class="hljs-number">1</span>;
            <span class="hljs-keyword">this</span>.controller.setZoomDisplay(<span class="hljs-keyword">this</span>.zoom);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tileLayer) {
                <span class="hljs-keyword">this</span>.tileLayer.clear();
            }
        },
        redraw: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.width = <span class="hljs-keyword">this</span>.mapDiv.offsetWidth;
            <span class="hljs-keyword">this</span>.height = <span class="hljs-keyword">this</span>.mapDiv.offsetHeight;
            <span class="hljs-comment">//this.centerX = Math.floor(0.5 * this.width);</span>
            <span class="hljs-comment">//this.centerY = Math.floor(0.5 * this.height);</span>
            <span class="hljs-keyword">this</span>.movableContainer.reset();
            <span class="hljs-keyword">this</span>.visibleArea = <span class="hljs-keyword">new</span> Mapper.VisibleArea(<span class="hljs-keyword">this</span>);
            <span class="hljs-keyword">this</span>.coordLayer.redraw();
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tileLayer) {
                <span class="hljs-keyword">this</span>.tileLayer.destroy();
            }
            <span class="hljs-keyword">this</span>.tileLayer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.TileLayer(<span class="hljs-keyword">this</span>, Mapper.util.clone(<span class="hljs-keyword">this</span>.visibleArea), <span class="hljs-keyword">this</span>.Tile);
            <span class="hljs-comment">//pass through</span>
            <span class="hljs-keyword">this</span>.tileLayer.subscribe(<span class="hljs-string">"onReloadTile"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tile)</span> {</span>
                <span class="hljs-keyword">this</span>.fireEvent(<span class="hljs-string">"onReloadTile"</span>, tile.data.id);
            }, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
        },
        refresh: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(isZoom)</span> {</span>
            <span class="hljs-comment">//store location before we redraw</span>
            <span class="hljs-keyword">var</span> vac = isZoom ? <span class="hljs-keyword">this</span>.visibleArea.centerLoc() : <span class="hljs-keyword">this</span>.visibleArea.centerLocPx();
            <span class="hljs-comment">//set tile size</span>
            <span class="hljs-keyword">this</span>._setTileSizeByZoom();
            <span class="hljs-comment">//draw</span>
            <span class="hljs-keyword">this</span>.redraw();
            <span class="hljs-comment">//reset location after draw</span>
            <span class="hljs-keyword">if</span> (isZoom) {
                <span class="hljs-keyword">this</span>.setCenterTo(vac[<span class="hljs-number">0</span>], vac[<span class="hljs-number">1</span>]);
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.setCenterToPx(vac[<span class="hljs-number">0</span>], vac[<span class="hljs-number">1</span>]);
            }
        },
        resize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.width = <span class="hljs-keyword">this</span>.mapDiv.offsetWidth;
            <span class="hljs-keyword">this</span>.height = <span class="hljs-keyword">this</span>.mapDiv.offsetHeight;
            <span class="hljs-keyword">this</span>.visibleArea.resize();
            <span class="hljs-keyword">this</span>.coordLayer.resize();
            <span class="hljs-keyword">this</span>.tileLayer.showTiles();
        },
        setCenterTo: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(locX, locY)</span> {</span>
            <span class="hljs-keyword">if</span> (Lang.isNumber(locX) &amp;&amp; Lang.isNumber(locY) &amp;&amp; <span class="hljs-keyword">this</span>.tileLayer) {
                <span class="hljs-keyword">var</span> otherWidth = <span class="hljs-keyword">this</span>.visibleArea.centerX,
                    otherHeight = <span class="hljs-keyword">this</span>.visibleArea.centerY,
                    ox = locX * <span class="hljs-keyword">this</span>.tileSizeInPx + (<span class="hljs-keyword">this</span>.tileSizeInPx / <span class="hljs-number">2</span>) - otherWidth,
                    oy = (locY * -<span class="hljs-number">1</span>) * <span class="hljs-keyword">this</span>.tileSizeInPx + (<span class="hljs-keyword">this</span>.tileSizeInPx / <span class="hljs-number">2</span>) - otherHeight;
                <span class="hljs-keyword">this</span>.moveByPx(ox * -<span class="hljs-number">1</span>, oy * -<span class="hljs-number">1</span>);
                <span class="hljs-keyword">this</span>.tileLayer.render(<span class="hljs-literal">true</span>);
                <span class="hljs-comment">/*var otherWidth = this.visibleArea.centerX,
                otherHeight = this.visibleArea.centerY;
            var locXm = locX,
                locYm = locY * -1;

            var locXmPx = (locXm * this.tileSizeInPx) + (this.tileSizeInPx / 2),
                locYmPx = (locYm * this.tileSizeInPx) + (this.tileSizeInPx / 2);

            var ox = locXmPx - otherWidth,
                oy = locYmPx - otherHeight;

            this.moveByPx(ox * -1, oy * -1);*/</span>
            }
        },
        setCenterToPx: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pX, pY)</span> {</span>
            <span class="hljs-keyword">if</span> (Lang.isNumber(pX) &amp;&amp; Lang.isNumber(pY) &amp;&amp; <span class="hljs-keyword">this</span>.tileLayer) {
                <span class="hljs-keyword">var</span> otherWidth = <span class="hljs-keyword">this</span>.visibleArea.centerX,
                    otherHeight = <span class="hljs-keyword">this</span>.visibleArea.centerY,
                    ox = pX - otherWidth,
                    oy = pY - otherHeight;
                <span class="hljs-keyword">this</span>.moveByPx(ox * -<span class="hljs-number">1</span>, oy * -<span class="hljs-number">1</span>);
                <span class="hljs-keyword">this</span>.tileLayer.render(<span class="hljs-literal">true</span>);
            }
        },</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>override these for specific tile handling</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">        getTile: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, z)</span> {</span>},
        getBounds: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>},
        updateBounds: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(oTile)</span> {</span>},
        addTileData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(aTiles)</span> {</span>}
    };
    Lang.augmentProto(Map, Util.EventProvider);
    <span class="hljs-keyword">var</span> MAX_STAR_AREA = <span class="hljs-number">3001</span>;
    Mapper.StarMap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(divId, options)</span> {</span>
        Mapper.StarMap.superclass.constructor.call(<span class="hljs-keyword">this</span>, divId, options);
        Dom.setStyle(<span class="hljs-keyword">this</span>.mapDiv, <span class="hljs-string">'background-image'</span>, <span class="hljs-string">'url("'</span> + Lib.AssetUrl + <span class="hljs-string">'star_system/field.png")'</span>);
    };
    Lang.extend(Mapper.StarMap, Map, {
        _setTileSizeByZoom: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            Game.SetCookieSettings(<span class="hljs-string">"starZoom"</span>, <span class="hljs-keyword">this</span>.zoom);
            <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>.zoom) {
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                    <span class="hljs-keyword">this</span>.setTileSizeInPx(<span class="hljs-number">150</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                    <span class="hljs-keyword">this</span>.setTileSizeInPx(<span class="hljs-number">100</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> -<span class="hljs-number">1</span>:
                    <span class="hljs-keyword">this</span>.setTileSizeInPx(<span class="hljs-number">50</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> -<span class="hljs-number">2</span>:
                    <span class="hljs-keyword">this</span>.setTileSizeInPx(<span class="hljs-number">35</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> -<span class="hljs-number">3</span>:
                    <span class="hljs-keyword">this</span>.setTileSizeInPx(<span class="hljs-number">20</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">this</span>.setTileSizeInPx(<span class="hljs-number">75</span>);
                    <span class="hljs-keyword">break</span>;
            }
        },
        init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.maxZoom = <span class="hljs-number">2</span>;
            <span class="hljs-keyword">this</span>.minZoom = -<span class="hljs-number">3</span>;
            <span class="hljs-keyword">var</span> mapSize = Game.ServerData.star_map_size;
            <span class="hljs-keyword">this</span>.maxBounds = {
                x1Left: mapSize.x[<span class="hljs-number">0</span>],
                x2Right: mapSize.x[<span class="hljs-number">1</span>],
                y1Top: mapSize.y[<span class="hljs-number">1</span>],
                y2Bottom: mapSize.y[<span class="hljs-number">0</span>]
            };
            <span class="hljs-keyword">this</span>.requestQueue = [];
            <span class="hljs-keyword">this</span>.Tile = Mapper.StarTile;
            <span class="hljs-keyword">this</span>.TileLayer = Mapper.StarTileLayer;
            <span class="hljs-keyword">this</span>.zoom = Game.GetCookieSettings(<span class="hljs-string">"starZoom"</span>, <span class="hljs-number">0</span>) * <span class="hljs-number">1</span>;
            <span class="hljs-keyword">this</span>.hidePlanets = Game.GetCookieSettings(<span class="hljs-string">"hidePlanets"</span>, <span class="hljs-number">0</span>) * <span class="hljs-number">1</span>;
            <span class="hljs-keyword">this</span>._setTileSizeByZoom();
        },
        getTile: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y)</span> {</span>
            <span class="hljs-keyword">var</span> xSet = <span class="hljs-keyword">this</span>.tileCache[x],
                body = xSet ? xSet[y] : <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (body) {
                <span class="hljs-keyword">if</span> (body.isStar) {
                    <span class="hljs-keyword">return</span> {
                        data: body,
                        image: [Lib.AssetUrl, <span class="hljs-string">'star_map/'</span>, body.color, <span class="hljs-string">'.png'</span>].join(<span class="hljs-string">''</span>)
                    };
                }
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (body.isPlanet) {
                    <span class="hljs-keyword">return</span> {
                        data: body,
                        image: [Lib.AssetUrl, <span class="hljs-string">'star_system/'</span>, body.image, <span class="hljs-string">'.png'</span>].join(<span class="hljs-string">''</span>)
                    };
                }
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> {
                    blank: <span class="hljs-literal">true</span>
                };
            }
        },
        getTileData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback, x1, x2, y1, y2)</span> {</span>
            <span class="hljs-keyword">var</span> xDiff = <span class="hljs-built_in">Math</span>.abs(x2 - x1),
                yDiff = <span class="hljs-built_in">Math</span>.abs(y2 - y1);
            <span class="hljs-keyword">if</span> ((xDiff * yDiff) &gt; MAX_STAR_AREA) { <span class="hljs-comment">//if out of bounds split and try again</span>
                <span class="hljs-keyword">var</span> half;
                <span class="hljs-keyword">if</span> (xDiff &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">//make sure x diff isn't zero so we can split it in half, other wise use Y axis</span>
                    half = <span class="hljs-built_in">Math</span>.floor(xDiff / <span class="hljs-number">2</span>);
                    <span class="hljs-keyword">this</span>.getTileData(callback, x1, x1 + half, y1, y2);
                    <span class="hljs-keyword">this</span>.getTileData(callback, x2 - half, x2, y1, y2);
                }
                <span class="hljs-keyword">else</span> {
                    half = <span class="hljs-built_in">Math</span>.floor(yDiff / <span class="hljs-number">2</span>);
                    <span class="hljs-keyword">this</span>.getTileData(callback, x1, x2, y1, y1 - half);
                    <span class="hljs-keyword">this</span>.getTileData(callback, x1, x2, y2 + half, y2);
                }
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">//YAHOO.log(data, "debug", "StarMap.getTileData.requestData");</span>
                Lacuna.Pulser.Show();
                Game.Services.Map.get_star_map({
                    args: {
                        session_id: Game.GetSession(<span class="hljs-string">""</span>),
                        left: x1,
                        right: x2,
                        top: y1,
                        bottom: y2
                    }
                }, {
                    success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-comment">//YAHOO.log(o, "debug", "StarMap.getTileData.get_stars.success");</span>
                        Lacuna.Pulser.Hide();
                        <span class="hljs-keyword">if</span> (o &amp;&amp; o.result) {
                            Game.ProcessStatus(o.result.status);
                            <span class="hljs-keyword">this</span>.addTileData(o.result.stars);
                            callback.success.call(callback.scope || <span class="hljs-keyword">this</span>, callback.argument);
                        }
                    },
                    failure: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">if</span> (callback.failure) {
                            callback.failure.call(callback.scope || <span class="hljs-keyword">this</span>, o);
                            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                        }
                    },
                    scope: <span class="hljs-keyword">this</span>
                });
            }
        },
        getBounds: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.bounds[<span class="hljs-keyword">this</span>.zoom] || {
                x1Left: <span class="hljs-number">0</span>,
                x2Right: <span class="hljs-number">0</span>,
                y1Top: <span class="hljs-number">0</span>,
                y2Bottom: <span class="hljs-number">0</span>
            };
        },
        addTileData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(aStars)</span> {</span>
            <span class="hljs-comment">//var startZoomLevel = 0;</span>
            <span class="hljs-keyword">var</span> cp = Game.GetCurrentPlanet();
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; aStars.length; i++) {
                <span class="hljs-keyword">var</span> star = aStars[i];
                star.isStar = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.tileCache[star.x]) {
                    <span class="hljs-keyword">this</span>.tileCache[star.x] = {};
                }
                <span class="hljs-keyword">this</span>.tileCache[star.x][star.y] = star;
                <span class="hljs-keyword">if</span> (star.bodies) { <span class="hljs-comment">// &amp;&amp; cp.star_id === star.id) {</span>
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> bKey <span class="hljs-keyword">in</span> star.bodies) {
                        <span class="hljs-keyword">if</span> (star.bodies.hasOwnProperty(bKey)) {
                            <span class="hljs-keyword">var</span> body = star.bodies[bKey];
                            body.isPlanet = <span class="hljs-literal">true</span>;
                            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.tileCache[body.x]) {
                                <span class="hljs-keyword">this</span>.tileCache[body.x] = {};
                            }
                            <span class="hljs-keyword">this</span>.tileCache[body.x][body.y] = body;
                        }
                    }
                }
                <span class="hljs-comment">//this.updateBounds(star);</span>
            }
            <span class="hljs-comment">//return startZoomLevel;</span>
        },
        reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.tileCache = {};
            <span class="hljs-keyword">this</span>.bounds = {};
            <span class="hljs-keyword">this</span>.tileLayer.reset();
        }
    });
    Mapper.PlanetMap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(divId, options)</span> {</span>
        Mapper.PlanetMap.superclass.constructor.call(<span class="hljs-keyword">this</span>, divId);
        <span class="hljs-keyword">this</span>.setSurfaceUrl(options.surfaceUrl);
    };
    Lang.extend(Mapper.PlanetMap, Map, {
        _setTileSizeByZoom: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            Game.SetCookieSettings(<span class="hljs-string">"planetZoom"</span>, <span class="hljs-keyword">this</span>.zoom);
            <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>.zoom) {
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                    <span class="hljs-keyword">this</span>.setTileSizeInPx(<span class="hljs-number">400</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                    <span class="hljs-keyword">this</span>.setTileSizeInPx(<span class="hljs-number">300</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> -<span class="hljs-number">1</span>:
                    <span class="hljs-keyword">this</span>.setTileSizeInPx(<span class="hljs-number">100</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> -<span class="hljs-number">2</span>:
                    <span class="hljs-keyword">this</span>.setTileSizeInPx(<span class="hljs-number">50</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">this</span>.setTileSizeInPx(<span class="hljs-number">200</span>);
                    <span class="hljs-keyword">break</span>;
            }
        },
        init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.maxZoom = <span class="hljs-number">2</span>;
            <span class="hljs-keyword">this</span>.minZoom = -<span class="hljs-number">2</span>;
            <span class="hljs-keyword">this</span>.bounds = {
                x1Left: -<span class="hljs-number">5</span>,
                x2Right: <span class="hljs-number">5</span>,
                y1Top: <span class="hljs-number">5</span>,
                y2Bottom: -<span class="hljs-number">5</span>
            };
            <span class="hljs-keyword">this</span>.maxBounds = {
                x1Left: -<span class="hljs-number">5</span>,
                x2Right: <span class="hljs-number">5</span>,
                y1Top: <span class="hljs-number">5</span>,
                y2Bottom: -<span class="hljs-number">5</span>
            };
            <span class="hljs-keyword">this</span>.Tile = Mapper.PlanetTile;
            <span class="hljs-keyword">this</span>.TileLayer = Mapper.PlanetTileLayer;
            <span class="hljs-keyword">this</span>.zoom = Game.GetCookieSettings(<span class="hljs-string">"planetZoom"</span>, <span class="hljs-number">0</span>) * <span class="hljs-number">1</span>;
            <span class="hljs-keyword">this</span>._setTileSizeByZoom();
        },
        setCenterToCommand: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.command) { <span class="hljs-comment">// &amp;&amp; this.tileLayer) {</span>
                <span class="hljs-keyword">this</span>.setCenterTo(<span class="hljs-keyword">this</span>.command.x, <span class="hljs-keyword">this</span>.command.y);</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><pre><code>        <span class="hljs-keyword">var</span> otherWidth = <span class="hljs-keyword">this</span>.visibleArea.centerX,
</code></pre><p>otherHeight = this.visibleArea.centerY;</p>
<pre><code>        <span class="hljs-keyword">var</span> ox = <span class="hljs-keyword">this</span>.command.x * <span class="hljs-keyword">this</span>.tileSizeInPx + (<span class="hljs-keyword">this</span>.tileSizeInPx / <span class="hljs-number">2</span>) - otherWidth,
</code></pre><p>oy = (this.command.y <em> -1) </em> this.tileSizeInPx + (this.tileSizeInPx / 2) - otherHeight;</p>
<pre><code>        <span class="hljs-keyword">this</span>.moveByPx(ox * -<span class="hljs-number">1</span>, oy * -<span class="hljs-number">1</span>);
</code></pre></div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            }
        },
        getTileImageSize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>.zoom) {
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"400/"</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"300/"</span>;
                <span class="hljs-keyword">case</span> -<span class="hljs-number">1</span>:
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"100/"</span>;
                <span class="hljs-keyword">case</span> -<span class="hljs-number">2</span>:
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"50/"</span>;
            }
        },
        getTile: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, z)</span> {</span>
            <span class="hljs-keyword">var</span> ySet = <span class="hljs-keyword">this</span>.tileCache[x],
                building = ySet ? ySet[y] : <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (building &amp;&amp; building.image) {
                <span class="hljs-keyword">return</span> {
                    blank: building.level === <span class="hljs-number">0</span>,
                    data: building,
                    url: [Lib.AssetUrl, <span class="hljs-string">'planet_side/'</span>, <span class="hljs-keyword">this</span>.getTileImageSize(), building.image, <span class="hljs-string">'.png'</span>].join(<span class="hljs-string">''</span>)
                };
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> {
                    blank: <span class="hljs-literal">true</span>
                };
            }
        },
        getTileData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback, x1, x2, y1, y2)</span> {</span>
            <span class="hljs-comment">//since we should have all the data already, just call success</span>
            callback.success.call(callback.scope || <span class="hljs-keyword">this</span>, callback.argument);
        },
        getBounds: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.bounds;
        },
        setSurfaceUrl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(surfaceUrl)</span> {</span>
            <span class="hljs-keyword">this</span>._surfaceUrl = surfaceUrl;
            Dom.setStyle(<span class="hljs-keyword">this</span>.mapDiv, <span class="hljs-string">'background-image'</span>, <span class="hljs-string">'url("'</span> + surfaceUrl + <span class="hljs-string">'")'</span>);
        },
        setPlotsAvailable: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(plots)</span> {</span>
            <span class="hljs-keyword">if</span> (plots &gt; <span class="hljs-number">0</span>) {
                Dom.removeClass(<span class="hljs-keyword">this</span>.mapDiv, <span class="hljs-string">'plots-full'</span>);
            }
            <span class="hljs-keyword">else</span> {
                Dom.addClass(<span class="hljs-keyword">this</span>.mapDiv, <span class="hljs-string">'plots-full'</span>);
            }
        },
        <span class="hljs-comment">//don't update bounds on plant.  We have all data at start</span>
        <span class="hljs-comment">/*updateBounds : function(oTile) {
    },*/</span>
        addTileData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(oTiles, filterOutDeleted)</span> {</span>
            <span class="hljs-keyword">var</span> startZoomLevel = <span class="hljs-number">0</span>,
                newTileCache = {};
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> tKey <span class="hljs-keyword">in</span> oTiles) {
                <span class="hljs-keyword">if</span> (oTiles.hasOwnProperty(tKey)) {
                    <span class="hljs-keyword">var</span> tile = oTiles[tKey];
                    tile.id = tKey;
                    <span class="hljs-keyword">if</span> (tile.url === <span class="hljs-string">"/planetarycommand"</span> || tile.url === <span class="hljs-string">"/stationcommand"</span>) {
                        <span class="hljs-keyword">this</span>.command = tile;
                        <span class="hljs-keyword">this</span>.command.x *= <span class="hljs-number">1</span>;
                        <span class="hljs-keyword">this</span>.command.y *= <span class="hljs-number">1</span>;
                    }
                    <span class="hljs-keyword">if</span> (!newTileCache[tile.x]) {
                        newTileCache[tile.x] = {};
                    }
                    newTileCache[tile.x][tile.y] = tile;
                }
            }
            <span class="hljs-keyword">if</span> (filterOutDeleted) {
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.tileCache) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.tileCache[x]) {
                        <span class="hljs-keyword">if</span> (!newTileCache[x] || !newTileCache[x][y]) {
                            <span class="hljs-keyword">this</span>.removeTile(x, y);
                        }
                    }
                }
            }
            <span class="hljs-keyword">this</span>.tileCache = newTileCache;
            <span class="hljs-keyword">return</span> startZoomLevel;
        },
        addSingleTileData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(oBuilding)</span> {</span>
            <span class="hljs-keyword">if</span> (oBuilding.url === <span class="hljs-string">"/planetarycommand"</span> || oBuilding.url === <span class="hljs-string">"/stationcommand"</span>) {
                <span class="hljs-keyword">this</span>.command = oBuilding;
                <span class="hljs-keyword">this</span>.command.x *= <span class="hljs-number">1</span>;
                <span class="hljs-keyword">this</span>.command.y *= <span class="hljs-number">1</span>;
            }
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.tileCache[oBuilding.x]) {
                <span class="hljs-keyword">this</span>.tileCache[oBuilding.x] = {};
            }
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.tileCache[oBuilding.x][oBuilding.y]) {
                <span class="hljs-keyword">this</span>.tileCache[oBuilding.x][oBuilding.y] = {};
            }
            <span class="hljs-keyword">this</span>.tileCache[oBuilding.x][oBuilding.y] = oBuilding;
        },
        refreshTile: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(building)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tileLayer) {
                <span class="hljs-keyword">this</span>.addSingleTileData(building);
                <span class="hljs-keyword">var</span> tile = <span class="hljs-keyword">this</span>.tileLayer.findTile(building.x, building.y, <span class="hljs-keyword">this</span>.zoom);
                <span class="hljs-keyword">if</span> (tile) {
                    tile.refresh();
                }
            }
        },
        refreshTileCounter: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(building)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tileLayer) {
                <span class="hljs-keyword">this</span>.addSingleTileData(building);
                <span class="hljs-keyword">var</span> tile = <span class="hljs-keyword">this</span>.tileLayer.findTile(building.x, building.y, <span class="hljs-keyword">this</span>.zoom);
                <span class="hljs-keyword">if</span> (tile) {
                    tile.refreshCounter();
                }
            }
        },
        removeTile: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tileCache &amp;&amp; <span class="hljs-keyword">this</span>.tileCache[x] &amp;&amp; <span class="hljs-keyword">this</span>.tileCache[x][y]) {
                <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.tileCache[x][y];
            }
            <span class="hljs-keyword">var</span> tile = <span class="hljs-keyword">this</span>.tileLayer.findTile(x, y, <span class="hljs-keyword">this</span>.zoom);
            <span class="hljs-keyword">if</span> (tile) {
                tile.refresh();
            }
        },
        reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.tileCache = {};
            <span class="hljs-keyword">this</span>.tileLayer.reset();
        }
    });
    Mapper.TraditionalController = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(map)</span> {</span>
        <span class="hljs-keyword">this</span>.map = map;
        <span class="hljs-keyword">this</span>.dd = <span class="hljs-keyword">new</span> YAHOO.util.DragDrop(map.mapDiv, <span class="hljs-string">'mapper'</span>);
        <span class="hljs-keyword">this</span>.dd.subscribe(<span class="hljs-string">"dragEvent"</span>, <span class="hljs-keyword">this</span>.moveMap, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">this</span>.dd.subscribe(<span class="hljs-string">"startDragEvent"</span>, <span class="hljs-keyword">this</span>.startDrag, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">this</span>.dd.subscribe(<span class="hljs-string">"endDragEvent"</span>, <span class="hljs-keyword">this</span>.endDrag, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">var</span> moveKeyListener = <span class="hljs-keyword">new</span> KL(document, {
            keys: [KL.KEY.UP, KL.KEY.DOWN, KL.KEY.LEFT, KL.KEY.RIGHT]
        }, {
            fn: <span class="hljs-keyword">this</span>.moveKey,
            scope: <span class="hljs-keyword">this</span>,
            correctScope: <span class="hljs-literal">true</span>
        }, KL.KEYDOWN);
        <span class="hljs-keyword">var</span> moveKeyUpListener = <span class="hljs-keyword">new</span> KL(document, {
            keys: [KL.KEY.UP, KL.KEY.DOWN, KL.KEY.LEFT, KL.KEY.RIGHT]
        }, {
            fn: <span class="hljs-keyword">this</span>.moveKeyUp,
            scope: <span class="hljs-keyword">this</span>,
            correctScope: <span class="hljs-literal">true</span>
        }, KL.KEYUP);
        <span class="hljs-keyword">var</span> xMove = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> yMove = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> lastMove = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">0</span>))
            .getTime();
        <span class="hljs-keyword">var</span> timerActive = <span class="hljs-literal">false</span>;
        Game.onScroll(map.mapDiv, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, x, y)</span> {</span>
            xMove += x;
            yMove += y;</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>we get tons of events, so only move every 50 milliseconds</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">var</span> now = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>())
                .getTime();
            <span class="hljs-keyword">if</span> (now - lastMove &gt; <span class="hljs-number">50</span>) {
                lastMove = now;
                map.moveByPx(xMove, yMove);
                xMove = <span class="hljs-number">0</span>;
                yMove = <span class="hljs-number">0</span>;
            }</pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>refresh screen every second during scrolling, and once afterward</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">if</span> (!timerActive) {
                timerActive = <span class="hljs-literal">true</span>;
                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    map.tileLayer.render(<span class="hljs-literal">true</span>);
                    timerActive = <span class="hljs-literal">false</span>;
                }, <span class="hljs-number">1000</span>);
            }
        });
        moveKeyListener.enable();
        moveKeyUpListener.enable();
        <span class="hljs-keyword">var</span> navEl = document.createElement(<span class="hljs-string">'div'</span>);
        navEl.className = <span class="hljs-string">'mapiator_nav'</span>;
        navEl.innerHTML = [<span class="hljs-string">'&lt;div class="mapiator_nav_up" title="Move Up"&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;div class="mapiator_nav_right" title="Move Right"&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;div class="mapiator_nav_down" title="Move Down"&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;div class="mapiator_nav_left" title="Move Left"&gt;&lt;/div&gt;'</span>].join(<span class="hljs-string">''</span>);
        map.mapDiv.appendChild(navEl);
        <span class="hljs-keyword">var</span> clickMoveMap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, o)</span> {</span>
            map.moveByTiles(o[<span class="hljs-number">0</span>], o[<span class="hljs-number">1</span>]);
        };
        Event.on(Sel.query(<span class="hljs-string">".mapiator_nav_up"</span>, navEl, <span class="hljs-literal">true</span>), <span class="hljs-string">"click"</span>, clickMoveMap, [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]);
        Event.on(Sel.query(<span class="hljs-string">".mapiator_nav_down"</span>, navEl, <span class="hljs-literal">true</span>), <span class="hljs-string">"click"</span>, clickMoveMap, [<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>]);
        Event.on(Sel.query(<span class="hljs-string">".mapiator_nav_left"</span>, navEl, <span class="hljs-literal">true</span>), <span class="hljs-string">"click"</span>, clickMoveMap, [<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]);
        Event.on(Sel.query(<span class="hljs-string">".mapiator_nav_right"</span>, navEl, <span class="hljs-literal">true</span>), <span class="hljs-string">"click"</span>, clickMoveMap, [-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]);
        <span class="hljs-keyword">if</span> ((map.maxZoom - map.minZoom) !== <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">var</span> zoomEl = document.createElement(<span class="hljs-string">'div'</span>);
            zoomEl.className = <span class="hljs-string">'mapiator_zoom'</span>;
            zoomEl.innerHTML = [<span class="hljs-string">'&lt;div class="mapiator_zoom_slider"&gt;'</span>, <span class="hljs-string">'    &lt;div class="mapiator_zoom_slider_thumb"&gt;'</span>, <span class="hljs-string">'        &lt;img src="'</span> + Lib.AssetUrl + <span class="hljs-string">'ui/zoom_slider.png" /&gt;'</span>, <span class="hljs-string">'    &lt;/div&gt;'</span>, <span class="hljs-string">'&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;div class="mapiator_zoom_in" title="Zoom In"&gt;&lt;/div&gt;'</span>, <span class="hljs-string">'&lt;div class="mapiator_zoom_out" title="Zoom Out"&gt;&lt;/div&gt;'</span>].join(<span class="hljs-string">''</span>);
            map.mapDiv.appendChild(zoomEl);
            Event.on(Sel.query(<span class="hljs-string">".mapiator_zoom_in"</span>, zoomEl, <span class="hljs-literal">true</span>), <span class="hljs-string">"click"</span>, map.zoomIn, map, <span class="hljs-literal">true</span>);
            Event.on(Sel.query(<span class="hljs-string">".mapiator_zoom_out"</span>, zoomEl, <span class="hljs-literal">true</span>), <span class="hljs-string">"click"</span>, map.zoomOut, map, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">var</span> sliderId = Dom.generateId(Sel.query(<span class="hljs-string">".mapiator_zoom_slider"</span>, zoomEl, <span class="hljs-literal">true</span>), <span class="hljs-string">"mapiator_zoom_slider"</span>);
            <span class="hljs-keyword">var</span> thumbId = Dom.generateId(Sel.query(<span class="hljs-string">".mapiator_zoom_slider_thumb"</span>, zoomEl, <span class="hljs-literal">true</span>), <span class="hljs-string">"mapiator_zoom_slider_thumb"</span>);
            <span class="hljs-keyword">var</span> zoomSize = <span class="hljs-number">140</span>;
            <span class="hljs-keyword">var</span> zoomScale = <span class="hljs-built_in">Math</span>.floor(zoomSize / (map.maxZoom - map.minZoom));
            <span class="hljs-keyword">var</span> zoomSlider = YAHOO.widget.Slider.getVertSlider(sliderId, thumbId, <span class="hljs-number">0</span>, zoomSize, zoomScale);
            zoomSlider.setZoom = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(zoom, skipAnim, force, silent)</span> {</span>
                <span class="hljs-keyword">this</span>.setValue((map.maxZoom - zoom) * zoomScale, skipAnim, force, silent);
            };
            zoomSlider.getZoom = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">return</span> map.maxZoom - <span class="hljs-keyword">this</span>.getValue() / zoomScale;
            };
            zoomSlider.setZoom(map.zoom, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);
            zoomSlider.subscribe(<span class="hljs-string">"change"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                map.setZoomLevel(<span class="hljs-keyword">this</span>.getZoom());
                map.refresh(<span class="hljs-literal">true</span>);
            });
            <span class="hljs-keyword">this</span>.zoomSlider = zoomSlider;
        }
    };
    Mapper.TraditionalController.prototype = {
        setZoomDisplay: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(zoom)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.zoomSlider &amp;&amp; <span class="hljs-keyword">this</span>.zoomSlider.getZoom() !== zoom) {
                <span class="hljs-keyword">this</span>.zoomSlider.setZoom(zoom);
            }
        },
        startDrag: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            clearTimeout(<span class="hljs-keyword">this</span>._timeout);
            <span class="hljs-keyword">this</span>.xmove = <span class="hljs-keyword">this</span>.ymove = <span class="hljs-literal">undefined</span>;
            <span class="hljs-keyword">this</span>._dragging = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">this</span>.map.coordLayer.startDrag();
        },
        moveMap: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(oArgs)</span> {</span>
            Event.preventDefault(oArgs.e);
            <span class="hljs-keyword">var</span> x = Event.getPageX(oArgs.e),
                y = Event.getPageY(oArgs.e);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.xmove) {
                <span class="hljs-keyword">this</span>.map.moveByPx(x - <span class="hljs-keyword">this</span>.xmove, y - <span class="hljs-keyword">this</span>.ymove);
            }
            <span class="hljs-keyword">this</span>.xmove = x;
            <span class="hljs-keyword">this</span>.ymove = y;
        },
        endDrag: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">var</span> oSelf = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">this</span>._timeout = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                clearTimeout(oSelf._timeout);
                oSelf.xmove = oSelf.ymove = <span class="hljs-literal">undefined</span>;
                oSelf.map.coordLayer.endDrag();
                oSelf.map.tileLayer.render(<span class="hljs-literal">true</span>);
                oSelf._dragging = <span class="hljs-literal">false</span>;
            }, <span class="hljs-number">500</span>);
        },
        isDragging: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._dragging; <span class="hljs-comment">// Math.abs(this.xmove) &gt; 5;</span>
        },
        moveKey: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(evName, evInfo)</span> {</span>
            <span class="hljs-keyword">var</span> keyCode = evInfo[<span class="hljs-number">0</span>],
                e = evInfo[<span class="hljs-number">1</span>];
            <span class="hljs-keyword">if</span> (!Dom.inDocument(<span class="hljs-keyword">this</span>.map.mapDiv)) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">switch</span> (e.target.tagName) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"INPUT"</span>:
                <span class="hljs-keyword">case</span> <span class="hljs-string">"SELECT"</span>:
                <span class="hljs-keyword">case</span> <span class="hljs-string">"TEXTAREA"</span>:
                    <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">if</span> (keyCode === KL.KEY.UP) {
                <span class="hljs-keyword">this</span>.map.moveByTiles(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keyCode === KL.KEY.DOWN) {
                <span class="hljs-keyword">this</span>.map.moveByTiles(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keyCode === KL.KEY.LEFT) {
                <span class="hljs-keyword">this</span>.map.moveByTiles(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keyCode === KL.KEY.RIGHT) {
                <span class="hljs-keyword">this</span>.map.moveByTiles(-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
            }
        },
        moveKeyUp: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(evName, evInfo)</span> {</span>
            <span class="hljs-keyword">var</span> keyCode = evInfo[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">var</span> e = evInfo[<span class="hljs-number">1</span>];
            <span class="hljs-keyword">if</span> (!Dom.inDocument(<span class="hljs-keyword">this</span>.map.mapDiv)) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">switch</span> (e.target.tagName) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"INPUT"</span>:
                <span class="hljs-keyword">case</span> <span class="hljs-string">"SELECT"</span>:
                <span class="hljs-keyword">case</span> <span class="hljs-string">"TEXTAREA"</span>:
                    <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">this</span>.map.tileLayer.render(<span class="hljs-literal">true</span>);
        }
    };
    Mapper.iPhoneController = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(map)</span> {</span>
        <span class="hljs-keyword">this</span>.map = map;
        <span class="hljs-keyword">this</span>.currentX = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.currentY = <span class="hljs-number">0</span>;
        Event.on(map.mapDiv, <span class="hljs-string">'touchstart'</span>, <span class="hljs-keyword">this</span>.touchStart, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
        Event.on(map.mapDiv, <span class="hljs-string">'touchend'</span>, <span class="hljs-keyword">this</span>.touchEnd, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
        Event.on(map.mapDiv, <span class="hljs-string">'touchmove'</span>, <span class="hljs-keyword">this</span>.touchMove, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">if</span> ((map.maxZoom - map.minZoom) !== <span class="hljs-number">0</span>) {
            Event.on(map.mapDiv, <span class="hljs-string">'gestureend'</span>, <span class="hljs-keyword">this</span>.gestureEnd, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
        }
    };
    Mapper.iPhoneController.prototype = {
        touchStart: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (e.touches.length === <span class="hljs-number">1</span>) { <span class="hljs-comment">// Only deal with one finger</span>
                <span class="hljs-keyword">var</span> touch = e.touches[<span class="hljs-number">0</span>]; <span class="hljs-comment">// Get the information for finger #1</span>
                <span class="hljs-keyword">this</span>.currentX = touch.pageX;
                <span class="hljs-keyword">this</span>.currentY = touch.pageY;
            }
        },
        touchEnd: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (e.touches.length === <span class="hljs-number">1</span>) { <span class="hljs-comment">// Only deal with one finger</span>
                <span class="hljs-keyword">this</span>.currentX = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">this</span>.currentY = <span class="hljs-number">0</span>;
            }
        },
        touchMove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (e.touches.length === <span class="hljs-number">1</span>) {
                e.preventDefault();
                <span class="hljs-keyword">var</span> touch = e.touches[<span class="hljs-number">0</span>];
                <span class="hljs-keyword">var</span> diffX = touch.pageX - <span class="hljs-keyword">this</span>.currentX;
                <span class="hljs-keyword">var</span> diffY = touch.pageY - <span class="hljs-keyword">this</span>.currentY;
                <span class="hljs-keyword">this</span>.map.moveByPx(diffX, diffY);
                <span class="hljs-keyword">this</span>.currentX = touch.pageX;
                <span class="hljs-keyword">this</span>.currentY = touch.pageY;
            }
        },
        gestureEnd: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span></pre></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>note: this does not work if the default is prevented!</p>
</div>
        </div>
      
      
        <div class="code"><pre class="wrapper">            <span class="hljs-keyword">if</span> (e.scale &gt; <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">this</span>.map.zoomIn();
            }
            <span class="hljs-keyword">if</span> (e.scale &lt; <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">this</span>.map.zoomOut();
            }
        },
        isDragging: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    };
    YAHOO.lacuna.Mapper = Mapper;
})();</pre></div>
      
      </div>
    
    </div>
  </div>

  <script src="../../toc.js"></script>
  <script src="../../assets/libs.js"></script>
  <script src="../../assets/behavior.js"></script>
</body>
</html>